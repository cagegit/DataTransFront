"use strict";var myApp=angular.module("myApp",["ui.router","pascalprecht.translate","ngAnimate","ui.bootstrap","myApp.service","myApp.common_view","ui.bootstrap.contextMenu","myApp.main_view","myApp.db_view","myApp.console_view","myApp.group_view","myApp.cp_view","myApp.queue_view","myApp.loader_view","myApp.ful_syc_view","myApp.tclient_view","myApp.tserver_view","myApp.etl_view","myApp.ftp_view"]);myApp.config(["$urlRouterProvider","$stateProvider","$translateProvider","$locationProvider","$urlServiceProvider",function(e,t,n,r,a){r.hashPrefix(""),t.state("/",{url:"/main",template:'<main></main><div id="mainDialogUi" ui-view ></div>'}),a.rules.otherwise({state:"/"}),a.rules.when("/","/main"),a.rules.when("","/main");var o=window.localStorage.lang||"cn";n.preferredLanguage(o),n.useStaticFilesLoader({prefix:"./i18n/",suffix:".json"}),n.useSanitizeValueStrategy("escapeParameters")}]),myApp.run(["$rootScope","$translate","$state","$log","$transitions",function(e,t,n,r,a){e.title="",t(["M_title","Cf_content"]).then(function(t){e.title=t.M_title}),n.defaultErrorHandler(function(e){r.error(e)}),a.onError({},function(e){})}]);var myapp=angular.module("myApp.service",["toastr","angular-md5"]);myapp.config(["toastrConfig",function(e){angular.extend(e,{positionClass:"toast-top-center",progressBar:!0,timeOut:2e3})}]),myapp.run(["$http",function(e){e.defaults.headers.common={"X-XSRF-TOKEN":$.cookie("XSRF-TOKEN")}}]),myapp.service("httpService",["$location","$http","$q","$window","toastr","$filter",function(e,t,n,r,a,o){return{getDataList:function(e,r,a){a=0===a?0:6e3;var o=n.defer();return t({method:"get",url:e,data:r,responseType:"json",timeout:a}).then(function(e){o.resolve(e.data,e.status,e.headers,e.config)}).catch(function(e){o.reject(e.data,e.status,e.headers,e.config)}),o.promise},postDataList:function(e,a,s){s=0===s?0:6e4;var i=n.defer();return t({method:"post",url:e,data:a,responseType:"json",timeout:s}).then(function(e){i.resolve(e.data,e.status,e.headers,e.config)}).catch(function(e){301===e.status&&BootstrapDialog.dialogs&&$.isEmptyObject(BootstrapDialog.dialogs)&&BootstrapDialog.alert({title:o("translate")("TIP"),message:o("translate")("Se_yjcs"),type:BootstrapDialog.TYPE_WARNING,closable:!1,buttonLabel:o("translate")("OK"),callback:function(){r.location.href="/logout"}}),i.reject(e.data,e.status,e.headers,e.config)}),i.promise}}}]),myapp.service("tipsService",["toastr","$filter","$translate",function(e,t,n){function r(t,n,r){t=t||"",n=n||i.txt,r=r||{positionClass:"toast-top-center"},e.error(t,n)}function a(t,n,r){t=t||"",n=n||i.txt,r=r||{positionClass:"toast-top-center"},e.warning(t,n)}function o(t,n,r){t=t||"",n=n||i.txt,r=r||{positionClass:"toast-top-center"},e.success(t,n)}function s(t,n,r){t=t||"",n=n||i.txt,r=r||{positionClass:"toast-top-center"},e.info(t,n)}var i={};return n("TIP").then(function(e){i.txt=e}),{error:r,warning:a,success:o,info:s}}]),myapp.service("comService",["httpService",function(e){function t(e){l=e}function n(){return l}function r(e){u=e}function a(){return u}function o(e){p=e}function s(){return p}function i(e){d=e}function c(e){return d}var l=null,u={node_id:"",com_name:"unnamed",db_type:"",group_name:""},p=null,d=null;return{getComData:n,setComData:t,setCanvasData:r,getCanvasData:a,setSessionId:o,getSessionId:s,getP:c,setP:i}}]),myapp.service("currentGroupService",function(){return{curGroupName:null,groupList:[],comInfo:null,curGroup:{},curId:""}}),myapp.service("md5Service",["md5","tipsService",function(e,t){this.md5Data=function(t){try{var n=JSON.stringify(t)}catch(e){return null}return{md5:e.createHash(n),request:t}},this.equalMd5Data=function(n){try{var r="";n.response&&(angular.isArray(n.response)||angular.isObject(n.response))?r=JSON.stringify(n.response):n.response&&angular.isString(n.response)&&(r=n.response)}catch(e){return t.error("check md5 error!"),!1}var a=e.createHash(r);return n.md5===a||(t.error("md5 check fail!"),!1)}}]),myapp.service("graphicService",["tipsService","md5Service","$filter","httpService",function(e,t,n,r){function a(e){var t=null,n=0,r=r7Plumb.instance.getAllConnections();return $.each(r,function(r,a){if(a.targetId===e){var o=$("#"+a.sourceId);if(t={},t.type=o.attr("type"),t.cname=o.attr("name"),t.name=o.attr("realid"),t.rtype=o.attr("rtype"),t.id=a.sourceId,++n>=2)return null}}),t}function o(e){for(var t=null,n=0,r=1,a=r7Plumb.instance.getAllConnections(),o=e,s=a.length;r&&!(s<=0);)s--,n=0,$.each(a,function(e,a){if(a.targetId===o){o=a.sourceId;var s=$("#"+a.sourceId);"database"===s.attr("rtype")&&(t={},t.type=s.attr("type"),t.cname=s.attr("name"),t.name=s.attr("realid"),t.rtype=s.attr("rtype"),t.id=a.sourceId,r=0),n=1}}),0===n&&(r=0);return t}function s(e){var t=null,n=0,r=r7Plumb.instance.getAllConnections();return $.each(r,function(r,a){if(a.sourceId===e){var o=$("#"+a.targetId);t={},t.id=a.targetId,t.type=o.attr("type"),t.cname=o.attr("name"),t.name=o.attr("realid"),t.rtype=o.attr("rtype"),n++,n>=2&&(t=null)}}),t}function i(){var e,t=r7Plumb.instance.getAllConnections(),n={},r=function(e){var n,r={Source:{},Target:{}};return $.each(t,function(t,a){a.sourceId===e&&(r.Source.to=a.targetId,n=$("#"+a.targetId),r.Source.type=n.attr("type"),r.Source.name=n.attr("name"),r.Source.rtype=n.attr("rtype"),r.Source.rid=n.attr("realid")),a.targetId===e&&(r.Target.start=a.sourceId,n=$("#"+a.sourceId),r.Target.type=n.attr("type"),r.Target.name=n.attr("name"),r.Target.rtype=n.attr("rtype"),r.Target.rid=n.attr("realid"))}),r};return $("#flowbox").find(".component").each(function(t,a){var o,s,i=$(a),c=i.attr("rtype"),l=i.attr("id");e={name:i.attr("name"),rid:i.attr("realid"),siblings:[]};var u=function(t,n){e.siblings.push({name:t.name,io_status:n,rid:t.rid,type:t.rtype})};"apply"===c?(n.apply||(n.apply=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.apply.push(e)):"capture"===c?(n.capture||(n.capture=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.capture.push(e)):"etl"===c?(n.etlapply||(n.etlapply=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.etlapply.push(e)):"mqapply"===c?(n.mqapply||(n.mqapply=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.mqapply.push(e)):"mq"===c?(n.mqpublisher||(n.mqpublisher=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.mqpublisher.push(e)):"transfer"===c?(n.transfer||(n.transfer=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.transfer.push(e)):"ftp"===c?(n.transftp||(n.transftp=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.transftp.push(e)):"file_load"===c&&(n.file_load||(n.file_load=[]),s=r(l),o=s.Target,o&&o.name&&u(o,"input"),o=s.Source,o&&o.name&&u(o,"output"),n.file_load.push(e))}),n}function c(a){var o=r7Plumb.graphicToStr(),s=o.json_lines,c=o.json_blocks,l=o.indexs,u=i(),p={global_index:l,line_object:s,graphic_content:c},d={group:a,relation_shape:u,graphic:p};d=t.md5Data(d);var m=function(e){if(angular.isArray(e)&&e.length>0){var t=$("#flowbox").find(".component");angular.forEach(t,function(t){var n=$(t);angular.forEach(e,function(e){n.attr("id")===e.cid&&n.attr("realid",e.rid)})})}};return r.postDataList("/dipserver/add_graphic",d,0).then(function(r){var a=!1;return t.equalMd5Data(r)&&(r.status?(e.success(n("translate")("Bccg")),m(r.response),a=!0):(e.error(r.response.error_msg),a=!1)),a},function(e){return!1})}function l(e){var n=r7Plumb.graphicToStr(),a=n.json_lines,o=n.json_blocks,s=n.indexs,c=i(),l={global_index:s,line_object:a,graphic_content:o},u={group:e,relation_shape:c,graphic:l};u=t.md5Data(u);var p=function(e){if(angular.isArray(e)&&e.length>0){var t=$("#flowbox").find(".component");angular.forEach(t,function(t){var n=$(t);angular.forEach(e,function(e){n.attr("id")===e.cid&&n.attr("realid",e.rid)})})}};return r.postDataList("/dipserver/add_graphic",u).then(function(e){return p(e.response),e.status},function(){return!1})}function u(){var e=[],t=$("#flowbox").find(".component");return angular.forEach(t,function(t){var n=$(t),r={};if("apply"===n.attr("rtype")&&"unnamed"!==n.attr("name")){var a=o(n.attr("id"));if(null===a||!a.type||!a.name)return;r.name=n.attr("realid"),r.cname=n.attr("name"),r.st=a.type,r.sn=a.name,r.cid=n.attr("id"),e.push(r)}}),e}function p(){var e=[],t=$("#flowbox").find(".component");return angular.forEach(t,function(t){var n=$(t),r={id:n.attr("id"),name:n.attr("name"),type:n.attr("rtype"),status:"-",st:"-",temp:"-",scn:"-",insert:"-",update:"-",delete:"-",ddl:"-"};e.push(r)}),e}function d(e){if("unnamed"===e)return!1;var t=!1,n=$("#flowbox").find(".component");return angular.forEach(n,function(n){"unnamed"!==$(n).attr("name")&&$(n).attr("name")===e&&(t=!0)}),t}function m(e,t){var n=[],r=function(e){if($("#"+e).attr("rtype")===t){var r=$("#"+e).attr("realid");r&&"undefined"!==r&&n.push(r)}},a=function(e){var t=!0,n=e;for(r(n);t;){var o=r7Plumb.instance.getConnections({source:n});o.length>0?(n=o[0].targetId,r(n),angular.forEach(o,function(e){e.targetId&&e.targetId!==n&&a(e.targetId)})):t=!1}};return a(e),n}return{getParent:a,getChild:s,fetch_relations:i,getSource:o,save_graphics_alert:c,save_graphics_no_alert:l,getLoaders:u,getMapList:p,checkNames:d,getRealIdBySourceId:m}}]),myapp.factory("tDes",function(){var e={};return e.en_des=function(e){var t="a819709ff2d8c096166b1d8b",n="a819709f";return t=CryptoJS.enc.Utf8.parse(t),n=CryptoJS.enc.Utf8.parse(n),CryptoJS.TripleDES.encrypt(e,t,{iv:n,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString()},e.de_des=function(e){var t="a819709ff2d8c096166b1d8b",n="a819709f";return t=CryptoJS.enc.Utf8.parse(t),n=CryptoJS.enc.Utf8.parse(n),CryptoJS.TripleDES.decrypt(e,t,{iv:n,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)||e},e}),function(){angular.module("myApp.common_view",[]).component("rightDialog",{templateUrl:"common_view/main_dialog.component.html",bindings:{title:"<"},controller:["$state","$location","tipsService","$filter",function(e,t,n,r){var a=this;a.menu={dialog:!0,mc:1},a.$onInit=function(){},e.includes("**.status")&&(a.menu.mc=1),e.includes("**.property")&&(a.menu.mc=2),a.changeTab=function(e){var o=t.search(),s=t.url();if(1===e){if(!o.cn||"unnamed"===o.cn)return void n.error(r("translate")("Zjwpz"));a.menu.mc=1,s=s.replace("property","status")}else 2===e&&(a.menu.mc=2,s=s.replace("status","property"));t.url(s)},a.redirectTo=function(t){e.go(t)}}]})}(),function(){angular.module("myApp.main_view",["myApp.main_view.service"]).directive("main",["tipsService","mainService","$log",function(e,t,n){function r(t,n){var r,a=["#000000","#48daff","#ffA500","#5e87b0"],o={strokeStyle:a[1],fillStyle:"transparent",radius:0,lineWidth:2},s={lineWidth:3,strokeStyle:a[3],outlineWidth:0,outlineColor:"transparent"},i={endpoint:["Dot",{radius:1,cssClass:"rectClass",hoverClass:"rectHoverClass"}],connectorStyle:o,connectorHoverStyle:s,paintStyle:{strokeStyle:a[1],fillStyle:"transparent",radius:1,lineWidth:1},endpointHoverStyle:{strokeStyle:a[3],lineWidth:1,fillStyle:"none"},connector:["Flowchart",{stub:[0,0],gap:2,cornerRadius:5,alwaysRespectStubs:!0}],maxConnections:-1,connectorOverlays:[["Arrow",{width:10,length:10,location:1,foldback:.8}]],DragOptions:{zIndex:2e3}},c=jsPlumb.getInstance({endpoint:["Dot",{radius:1}],connectorStyle:o,connectorHoverStyle:s,maxConnections:-1,connectorOverlays:[["Arrow",{width:10,length:10,location:1,foldback:.8}]],DragOptions:{zIndex:2e3},Container:"flowbox"}),l=$("#flowbox"),u=$("#kj-kj"),p=30,d="Flowchart";new r7PlumbSelectArea.regionSelect({region:"#flowbox div.component",selectedClass:"seled",parentId:"flowbox"}).select(),r=function(){function r(){var t,n,r=0,a=r7PlumbSelectArea.getSelected();if(2===a.length){for(r;r<2;r++)0===r?t=$(a[0]).attr("id"):n=$(a[1]).attr("id");c.getConnections({source:t,target:n}).length>0?e.warning("控件已连接！"):c.connect({source:t,target:n,anchor:"Continuous"},i).bind("click",function(){var e=this;BootstrapDialog.confirm({title:"Dip 提示",message:"确定要删除该连线吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(t){t&&c.detach(e)}})})}}function m(e){for(var t=$.isArray(e)?e:r7PlumbSelectArea.getSelected(),n=0;n<t.length;n++){var r=$(t[n]).attr("id");c.updateOffset({elId:r,recalc:!0}),c.repaint(r)}}function _(e){"Flowchart"===e?(o.strokeStyle=a[1],i.connector=["Flowchart",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}]):"Straight"===e?(o.strokeStyle=a[0],i.connector=["Straight",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}]):"Bezier"===e&&(o.strokeStyle=a[2],i.connector=["Bezier",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}])}function f(e){"1"===e?(o.strokeStyle=a[1],i.connector=["Flowchart",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}]):"2"===e?(o.strokeStyle=a[0],i.connector=["Straight",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}]):"3"===e&&(o.strokeStyle=a[2],i.connector=["Bezier",{stub:[0,0],gap:5,cornerRadius:5,alwaysRespectStubs:!0}])}function g(t,n){var r="",u=0;$.each(t,function(e,t){var n="",a=t.BlockClass.split(" "),o="",s="";a.length>=2&&(o=a[0]+" "+a[1]+" drag-cir"),"database"===t.Rtype?n="<div class='"+o+"'><div class='drag-cir-add vertical-center compic'></div></div>":"capture"===t.Rtype?n="<div class='"+o+"'><div class='drag-cp-add vertical-center compic'></div></div>":"queue"===t.Rtype?n="<div class='"+o+"'><div class='drag-queue-add vertical-center compic'></div></div>":"apply"===t.Rtype?n="<div class='"+o+"'><div class='drag-load-add vertical-center compic'></div></div>":"transfer"===t.Rtype?n="<div class='"+o+"'><div class='drag-server-add vertical-center compic'></div></div>":"etl"===t.Rtype?n="<div class='"+o+"'><div class='drag-etl-add vertical-center compic'></div></div>":"ftp"===t.Rtype&&(n="<div class='"+o+"'><div class='drag-ftp-add vertical-center compic'></div></div>");var i=t.RealId&&"undefined"!==t.RealId?t.RealId:"",c=t.Type&&"undefined"!==t.Type?t.Type:"";c&&"database"===t.Rtype&&(s=' title="'+c+'"'),r+='<div class="'+t.Class+'" rtype="'+t.Rtype+'" parentid="'+t.ParentId+'" style="height:'+t.BlockHeight+";width:"+t.BlockWidth+";left:"+t.BlockX+";top:"+t.BlockY+';position:absolute;" id="'+t.BlockId+'" type="'+c+'" name="'+t.Name+'" original-title="'+t.OriginalTitle+'" realid="'+i+'"'+s+" >"+n+'<span class="dragPoint">'+t.BlockTxt+"</span></div>"}),l.html(r),c.importDefaults({Endpoints:[["Dot",{radius:1}],["Dot",{radius:1}]],EndpointStyles:[{fillStyle:a[0]},{fillStyle:a[0]}],HoverPaintStyle:s,PaintStyle:o,ConnectionOverlays:[["Arrow",{width:10,length:10,location:1}]]}),h(jsPlumb.getSelector("#flowbox .component")),c.bind("connection",function(t){if(t.connection)if(t.connection.sourceId===t.connection.targetId)e.error("不能以自己作为目标元素！"),c.detach(t);else{var n=$("#"+t.connection.sourceId).attr("rtype"),r=$("#"+t.connection.targetId).attr("rtype");n===r&&(e.error("相同控件之间不能连接！"),c.detach(t))}}),c.bind("connectionDragStop",function(t){$("#"+t.targetId).find("#"+t.sourceId).length>0||t.targetId===t.sourceId?(e.error("不能以自己作为目标元素！"),c.detach(t)):(t.unbind("click"),t.bind("click",function(){BootstrapDialog.confirm({title:"Dip 提示",message:"确定要删除该连线吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(e){e&&c.detach(t)}})}))});var p=parseInt($.cookie("strlineStyle"));for(p&&f(p),u=0;u<n.length;u++){if(!p){var m=n[u].Connector||"Flowchart";d=m,0===u&&_(m)}var g=c.connect({source:n[u].PageSourceId,target:n[u].PageTargetId,anchor:"Continuous"},i);g.unbind("click"),g.bind("click",function(){var e=this;BootstrapDialog.confirm({title:"Dip 提示",message:"确定要删除该连线吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(t){t&&c.detach(e)}})})}}function h(t){var n={left:0,top:0};c.draggable(t,{start:function(e){r7PlumbSelectArea.startMove(),n.left=$(e.el).position().left,n.top=$(e.el).position().top},drag:function(e){var t={left:0,top:0};e.pos&&(t.left=e.pos[0]-n.left,t.top=e.pos[1]-n.top),r7PlumbSelectArea.moveSelect(t,$(e.el).attr("id")),m()},stop:function(e){}}),c.unbind("beforeDrop").bind("beforeDrop",function(t){var n=[],r=!0,a=$("#"+t.sourceId).attr("rtype");return"database"!==a&&"capture"!==a||(n=c.getConnections({source:t.sourceId}),n.length>=1&&(e.error("当前组件只能连接一个组件！"),r=!1)),r}),$.isArray(t)?$.each(t,function(e,t){"database"===$(t).attr("rtype")||"queue"===$(t).attr("rtype")||"apply"===$(t).attr("rtype")?i.maxConnections=-1:i.maxConnections=1,c.doWhileSuspended(function(){c.makeSource(t,{filter:".dragPoint",anchor:"Continuous"},i)}),c.makeTarget(t,{dropOptions:{hoverClass:"seled"},anchor:"Continuous"},i)}):(c.doWhileSuspended(function(){var e={filter:".dragPoint",anchor:"Continuous",allowLoopback:!1};c.makeSource(t,e,i)}),c.makeTarget(t,{dropOptions:{hoverClass:"seled"},anchor:"Continuous",allowLoopback:!1},i))}var v={};return v.changePosition=function(e){var t=e;"1"===t?r7PlumbSelectArea.alignTop():"2"===t?r7PlumbSelectArea.alignBottom():"3"===t?r7PlumbSelectArea.alignLeft():"4"===t?r7PlumbSelectArea.alignRight():"5"===t&&r7PlumbSelectArea.alignMiddle()},v.changeLine=function(e){if(parseInt(e)){if(!(jsPlumb.getSelector(".component").length<=0)){f(e),$.cookie("strlineStyle",e);var t=this.graphicToStr();c.reset(),l.empty(),g(t.json_blocks,t.json_lines)}}},v.drawGraphic=function(e){var t=e.response;if(c.reset(),l.empty(),t&&t.graphic&&t.graphic.line_object&&t.graphic.graphic_content&&t.graphic.global_index){var n=t.graphic.graphic_content,r=t.graphic.line_object,a=t.graphic.global_index;p=parseInt(a)&&parseInt(a)>30?parseInt(a):30,"[]"!==n&&(n=JSON.parse(n),r=JSON.parse(r),g(n,r))}},v.graphicToStr=function(){var e=[];$.each(c.getAllConnections(),function(t,n){e.push({ConnectionId:n.id,PageSourceId:n.sourceId,PageTargetId:n.targetId,RealSourceId:$(n.source).attr("realid"),RealTargetId:$(n.target).attr("realid"),Connector:n.connector.type})});var t=[];return l.find(".component").each(function(e,n){var r=$(n);r.removeClass("seled"),t.push({BlockId:r.attr("id"),BlockClass:r.find(".km-btn-full").attr("class"),BlockTxt:r.find(".dragPoint").text(),BlockX:r.css("left"),BlockY:r.css("top"),BlockWidth:r.css("width"),BlockHeight:r.css("height"),ParentId:r.attr("parentid"),Rtype:r.attr("rtype"),Type:r.attr("type"),Name:r.attr("name"),OriginalTitle:r.attr("original-title"),Class:r.attr("class"),RealId:r.attr("realid")})}),{lines:Base64.encode(JSON.stringify(e)),contents:Base64.encode(JSON.stringify(t)),indexs:p,json_lines:e,json_blocks:t}},v.dragInit=function(){function e(e,r){t.$apply(function(){n.menu.comPanelShow=!1});var a=$(e.draggable).attr("id");p++;var o=a+p,s=parseInt(l.parent().scrollLeft()),i=parseInt(l.parent().scrollTop()),u=e.helper.clone();$(u).attr("class","component "+$(u).attr("type")),$(u).attr("rtype",$(u).attr("type")),$(u).removeAttr("type"),$(u).attr("parentid",$(r).attr("id")),$(u).attr("name","unnamed"),$(u).attr("id",o),$(u).attr("realid","");var m=$(u).find(".km-btn-full").attr("class");if("database"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-cir-add vertical-center compic'></div></div>");else if("capture"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-cp-add vertical-center compic'></div></div>");else if("queue"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-queue-add vertical-center compic'></div></div>");else if("apply"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-load-add vertical-center compic'></div></div>");else if("transfer"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-server-add vertical-center compic'></div></div>");else if("etl"===$(u).attr("rtype"))$(u).append("<div class='"+m+" drag-cir'><div class='drag-etl-add vertical-center compic'></div></div>");else{if("ftp"!==$(u).attr("rtype"))return;$(u).append("<div class='"+m+" drag-cir'><div class='drag-ftp-add vertical-center compic'></div></div>")}$(u).find("a").remove(),$(u).append('<span class="dragPoint">unnamed</span>');var f=0;$("#drag_box_id").hasClass("page-sidebar-closed")&&(f=188);var g=parseInt($(u[0]).css("left"))-97+f+s,v=parseInt($(u[0]).css("top"))-102+i;g<0&&(g=10),v<0&&(v=10),$(u[0]).css("left",g+"px"),$(u[0]).css("top",v+"px"),$(u[0]).css("width",""),$(u[0]).css("height",""),$(u[0]).css("zIndex",100),l.append(u),parseInt($.cookie("strlineStyle"))||_(d),h(o),c.revalidate(o)}u.find(".tool").draggable({cursor:"move",helper:"clone",scope:"plant"}),l.droppable({accept:".tool",drop:function(t,n){e(n,this)},scope:"plant"});var r=0,a=null;l.on("click",".km-btn-full",function(e){1==++r&&(a=setTimeout(function(){var o,s=$(e.target);s.hasClass("compic")?o=s.parent().parent():s.hasClass("km-btn-full")&&(o=s.parent()),1===r?o.attr("rtype")&&t.$apply(function(){n.showPzDialog({rtype:o.attr("rtype"),name:o.attr("name"),id:o.attr("id"),cid:o.attr("realid")})}):o.attr("rtype")&&t.$apply(function(){n.changeCurrentCom({rtype:o.attr("rtype"),name:o.attr("name"),id:o.attr("id"),cid:o.attr("realid")})}),r=0,clearTimeout(a)},300))}).on("dblclick",".km-btn-full",function(e){e.preventDefault()})},v.repaintSelected=m,v.connectTwoComponents=r,v.deleteElement=function(e){c.removeAllEndpoints(e),c.remove(e)},v.instance=c,v},window.r7Plumb=r()}return{restrict:"E",controller:["$scope","comService","$state","currentGroupService","graphicService","$location","tipsService","$interval","$window","$filter","$translate","$rootScope",function(e,n,r,a,o,s,i,c,l,u,p,d){function m(e){$("#kj-kj").find(".tool").draggable({disabled:e}),$("#flowbox").droppable("option","disabled",e)}function _(e,t){var n;return"all"===e?n=t:"dt"===e?(n=[],angular.forEach(t,function(e){"capture"!==e.type&&"apply"!==e.type&&"transfer"!==e.type&&"etl"!==e.type||n.push(e)})):"jt"===e&&(n=[],angular.forEach(t,function(e){"database"!==e.type&&"queue"!==e.type||n.push(e)})),n}function f(){var e=window.localStorage.getItem("uname"),n=window.localStorage.getItem("uauth");t.getAllGroups(T,e,n).then(function(e){if(e.status){D.groupList=[];var n=e.list,r=window.localStorage.getItem("group"),o=-1;n.length>0?(angular.forEach(n,function(e,t){e.group_id===r&&(o=t);var n={title:e.name,active:!1,desc:e.description,log_del_duration:e.log_save_hour,load:e.loaded?e.loaded:"no",group_id:e.group_id};D.groupList.push(n)}),-1===o?(D.groupList[0].active=!0,a.curGroup=D.groupList[0],a.curGroupName=D.groupList[0].title,a.curGroupId=D.groupList[0].group_id,a.groupList=D.groupList):(D.groupList[o].active=!0,a.curGroupName=D.groupList[o].title,a.curGroupId=D.groupList[o].group_id,a.curGroup=D.groupList[o],a.groupList=D.groupList),D.menu.currentGc=a.curGroupName,t.getGraphicByGroupId(a.curGroupId).then(function(e){e&&(D.getCurGroupStatus(),E=c(function(){D.getCurGroupStatus()},5e3))})):(D.comsDragable=!0,m(!0))}else D.comsDragable=!0,m(!0)})}function g(e){var n,r,s,l=e||a.comInfo,p="",d=!0,m={};if(!l)return void i.error(u("translate")("M_qxzzj"));if("capture"===l.rtype){if(n="Capture",p='<h2 class="text-warning">'+u("translate")("M_tip7")+"</h2>",(r=o.fetch_relations())&&!$.isEmptyObject(r)&&(s=r.capture,angular.forEach(s.siblings,function(e){"queue"===e.type&&(d=!1)}),!s||0===s.length||!d))return void i.error(u("translate")("M_qxpzzj"))}else if("apply"===l.rtype)n="Loader",p='<h2 class="text-warning">'+u("translate")("M_tip8")+"</h2>";else if("group"===l.rtype){if(r=o.fetch_relations(),angular.isObject(r)&&!$.isEmptyObject(r)){if(!(s=r.capture))return void i.error(u("translate")("M_zjswpz"));if(angular.forEach(s.siblings,function(e){"queue"===e.type&&(d=!1)}),0===s.length||!d)return void i.error(u("translate")("M_qxpzzj"))}n="Group",p='<h2 class="text-warning">'+u("translate")("M_tip9",{gname:l.title})+"</h2>"}else if("transfer"===l.rtype)n="Tclient",p='<h2 class="text-warning">'+u("translate")("M_tip10")+"</h2>";else if("etl"===l.rtype)n="Etl",p='<h2 class="text-warning">Etl 组件启动中..........</h2>';else{if("ftp"!==l.rtype)return;n="Ftp",p='<h2 class="text-warning">Ftp 组件启动中..........</h2>'}var _="",f="",g=a.curGroup.load,h="";"Group"===n?(m={group_id:l.group_id,rtype:l.rtype,cn:l.group_id},_=u("translate")("M_tip11",{gname:l.title}),f=u("translate")("M_tip12",{gname:l.title})):(h="etl"===l.rtype?"etlapply":"ftp"===l.rtype?"transftp":l.rtype,m={group_id:l.group_id,rtype:h,cn:l.cid},_=u("translate")("M_tip13",{cname:n}),f=u("translate")("M_tip14",{cname:n}));var v=function(){var e=new BootstrapDialog({title:n+" Info",type:"type-warning",message:function(){return p},closable:!1});e.open(),a.curGroup.load="no",t.startServer(m).then(function(t){if(t.res)e.setType("type-success"),e.getModalBody().html('<h2 class="text-success">'+f+'<i class="green glyphicon glyphicon-ok"></i></h2>'),e.setClosable(!0),a.curGroup.load="yes",D.getCurGroupStatus(),E||(E=c(function(){D.getCurGroupStatus()},5e3)),setTimeout(function(){e.close()},500);else{e.setType("type-danger");var n=t.msg||_;e.getModalBody().html('<h2 class="text-error">'+n+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0),a.curGroup.load=g}},function(){e.setType("type-danger"),e.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0),a.curGroup.load=g})};if("Loader"===n){var b=l.id,y={},w=null;if(null===(w=o.getSource(b)))return void i.error(u("translate")("M_dqyd"));if(y.sn=w.name,null===(w=o.getChild(b)))return void i.error(u("translate")("M_dqmb"));y.tn=w.name,y.gn=l.group_id,t.isSourceDatabaseSame(y).then(function(e){!0===e?BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_ymyzjs"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&v()}}):!1===e&&v()})}else v()}function h(e){var n,r=e||a.comInfo,o="",s={};if(!r)return void i.error(u("translate")("M_tip15"));if("capture"===r.rtype)n="Capture",o='<h2 class="text-warning">'+u("translate")("M_tip16")+"</h2>";else if("apply"===r.rtype)n="Loader",o='<h2 class="text-warning">'+u("translate")("M_tip17")+"</h2>";else if("group"===r.rtype)n="Group",o='<h2 class="text-warning">'+u("translate")("M_tip18",{gname:r.title})+"</h2>";else if("transfer"===r.rtype)n="Tclient",o='<h2 class="text-warning">'+u("translate")("M_tip19")+"</h2>";else if("etl"===r.rtype)n="Etl",o='<h2 class="text-warning">Etl 组件重启中..........</h2>';else{if("ftp"!==r.rtype)return;n="Ftp",o='<h2 class="text-warning">Ftp 组件重启中..........</h2>'}var l="",p="",d=a.curGroup.load,m="",_=function(){a.curGroup.load="no";var e=new BootstrapDialog({title:n+" Info",type:"type-warning",message:function(e){return o},closable:!1});e.open(),t.restartServer(s).then(function(t){if(t.res)e.setType("type-success"),e.getModalBody().html('<h2 class="text-success">'+p+'<i class="green glyphicon glyphicon-ok"></i></h2>'),e.setClosable(!0),a.curGroup.load="yes",D.getCurGroupStatus(),E||(E=c(function(){D.getCurGroupStatus()},5e3)),setTimeout(function(){e.close()},500);else{e.setType("type-danger");var n=t.msg||l;e.getModalBody().html('<h2 class="text-error">'+n+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0),a.curGroup.load=d}},function(){e.setType("type-danger"),e.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0),a.curGroup.load=d})};"Group"===n?(s={group_id:r.group_id,rtype:r.rtype,cn:r.group_id},l=u("translate")("M_tip20",{gname:r.title}),p=u("translate")("M_tip21",{gname:r.title}),BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_tip22"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&_()}})):(m="etl"===r.rtype?"etlapply":"ftp"===r.rtype?"transftp":r.rtype,s={group_id:r.group_id,rtype:m,cn:r.cid},l=u("translate")("M_tip23",{cname:n}),p=u("translate")("M_tip24",{cname:n}),_())}function v(e){var n,r=e||a.comInfo,s="",c={};if(!r)return void i.error(u("translate")("M_tip25"));if("capture"===r.rtype)n="Capture",s='<h2 class="text-warning">'+u("translate")("M_tip26")+"</h2>";else if("apply"===r.rtype)n="Loader",s='<h2 class="text-warning">'+u("translate")("M_tip27")+"</h2>";else if("group"===r.rtype)n="Group",s='<h2 class="text-warning">'+u("translate")("M_tip28",{gname:r.title})+"</h2>";else if("transfer"===r.rtype)n="Tclient",s='<h2 class="text-warning">'+u("translate")("M_tip29")+"</h2>";else if("etl"===r.rtype)n="Etl",s='<h2 class="text-warning">Etl 组件停止中..........</h2>';else{if("ftp"!==r.rtype)return;n="Ftp",s='<h2 class="text-warning">Ftp 组件停止中..........</h2>'}var l="",p="",d=a.curGroup.load,m="",_=function(e){a.curGroup.load="no";var r=new BootstrapDialog({title:n+" Info",type:"type-warning",message:function(){return s},closable:!1});r.open(),t.stopServer(c).then(function(t){if(r.setClosable(!0),t.res){r.setType("type-success"),r.getModalBody().html('<h2 class="text-success">'+p+'<i class="green glyphicon glyphicon-ok"></i></h2>'),a.curGroup.load=d;var n=$("#flowbox").find("div.component");"group"===e?(a.curGroup.load="no",D.clearInterval(),angular.forEach(n,function(e){var t=$(e).attr("id");$("#"+t).find(".km-btn-full").removeClass("drag-err").removeClass("drag-waring").removeClass("drag-success").addClass("drag-cir")}),D.listView.mapList=o.getMapList()):$("#"+e).find(".km-btn-full").removeClass("drag-err").removeClass("drag-waring").removeClass("drag-success").addClass("drag-cir"),D.com.start=!0,D.com.restart=!1,D.com.stop=!1,D.com.scn_start=!0,setTimeout(function(){r.close()},500)}else{r.setType("type-danger");var s=t.msg||l;r.getModalBody().html('<h2 class="text-error">'+s+'<i class="red glyphicon glyphicon-remove"></i></h2>'),a.curGroup.load=d}},function(){a.curGroup.load=d,r.setType("type-danger"),r.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),r.setClosable(!0)})};"Group"===n?(c={group_id:r.group_id,rtype:r.rtype,cn:r.group_id},l=u("translate")("M_tip30",{gname:r.title}),p=u("translate")("M_tip31",{gname:r.title}),BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_tip32"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&_("group")}})):(m="etl"===r.rtype?"etlapply":"ftp"===r.rtype?"transftp":r.rtype,c={group_id:r.group_id,rtype:m,cn:r.cid},l=u("translate")("M_tip33",{cname:n}),p=u("translate")("M_tip34",{cname:n}),_(r.id))}function b(){var e,n,r,s=a.comInfo,l="";if(!s)return void i.error(u("translate")("M_tip35"));var p=function(){var n=new BootstrapDialog({title:u("translate")("M_tip36"),message:$(l),type:"type-warning",buttons:[{label:u("translate")("CANCEL"),cssClass:"btn-default",action:function(e){e.close()}},{id:"button-c",label:u("translate")("START"),cssClass:"btn-primary",hotkey:13,action:function(r){var o=r.getModalBody(),i=r.getModalBody().find("#scnId"),l=r.getModalBody().find("#lowScnId"),p=/.{0,29}/,d="",m="";if(o.find("span").remove(),!p.test(i.val()))return o.addClass("input-err").append('<span class="help-block">'+u("translate")("M_tip37")+"</span>"),void i.addClass("ia").focus();if(o.removeClass("input-err"),i.removeClass("ia"),d=i.val(),"Capture"===e){if(!p.test(l.val()))return o.addClass("input-err").append('<span class="help-block">'+u("translate")("M_tip39")+"</span>"),void l.addClass("ib").focus();o.removeClass("input-err"),i.removeClass("ib"),m=l.val()}"apply"!==s.rtype&&"etl"!==s.rtype&&"file_load"!==s.rtype&&"transfer"!==s.rtype||(m=d),n.enableButtons(!1),n.setClosable(!1),o.html('<h2 class="text-warning">'+e+u("translate")("M_tip40")+"</h2>");var _="";_="etl"===s.rtype?s.rtype+"apply":s.rtype
;var f=a.curGroup.load;a.curGroup.load="no",t.startServerByScn(s,_,d,m).then(function(t){if(t.res)n.setType("type-success"),n.getModalBody().html('<h2 class="text-success">'+u("translate")("M_tip42",{cname:e})+'<i class="green glyphicon glyphicon-ok"></i></h2>'),n.setClosable(!0),a.curGroup.load="yes",D.getCurGroupStatus(),E||(E=c(function(){D.getCurGroupStatus()},5e3)),setTimeout(function(){n.close()},500);else{n.setType("type-danger");var r=t.msg||u("translate")("M_tip41",{cname:e});n.getModalBody().html('<h2 class="text-error">'+r+'<i class="red glyphicon glyphicon-remove"></i></h2>'),n.setClosable(!0),a.curGroup.load=f}},function(){a.curGroup.load=f,n.setType("type-danger"),n.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),n.setClosable(!0)})}}],closable:!0});n.open()},d=u("translate")("M_tip43"),m=u("translate")("M_tip44"),_=u("translate")("M_tip45"),f=u("translate")("M_tip46");if("capture"===s.rtype){if(r=o.fetch_relations(),angular.isObject(r)&&!$.isEmptyObject(r)){var g=r.capture,h=!0;if(angular.forEach(g.siblings,function(e){"queue"===e.type&&(h=!1)}),!g||0===g.length||!h)return void i.error(u("translate")("M_qxpzzj"))}e="Capture",l='<div id="mainId"><label>'+d+'</label><input class="form-control" type="text" id="scnId" placeholder="'+m+'"/><br><label>'+_+'</label><input id="lowScnId" type="text" class="form-control" placeholder="'+f+'"/></div>',p()}else if("transfer"===s.rtype)e="Tclient",l='<div id="mainId"><label>'+d+'</label><input class="form-control" type="text" id="scnId" placeholder="'+m+'"/></div>';else if("etl"===s.rtype)e="Etl",l='<div id="mainId"><label>'+d+'</label><input class="form-control" type="text" id="scnId" placeholder="'+m+'"/></div>',p();else if("apply"===s.rtype){e="Loader",l='<div id="mainId"><label>'+d+'</label><input class="form-control" type="text" id="scnId" placeholder="'+m+'"/></div>';var v=s.id,b={};if(null===(n=o.getSource(v)))return void i.error(u("translate")("M_dqyd"));if(b.sn=n.name,null===(n=o.getChild(v)))return void i.error(u("translate")("M_dqmb"));b.tn=n.name,b.gn=s.group_id,t.isSourceDatabaseSame(b).then(function(e){!0===e?BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_ymyzjs"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&p()}}):!1===e&&p()})}}function y(e){if("yes"===a.curGroup.load)return void BootstrapDialog.alert({title:u("translate")("TIP"),message:e.title+u("translate")("M_tip54"),type:BootstrapDialog.TYPE_DANGER,closable:!0,buttonLabel:u("translate")("SURE"),btnOKClass:"btn-warning"});!function(){var n='<div id="mainId"><input type="radio" name="rgroup" checked value="yes" id="dd_all"/><label for="dd_all">'+u("translate")("M_tip48")+'</label><br><input type="radio" name="rgroup" value="no" id="dd_none"/><label for="dd_none">'+u("translate")("M_tip49")+"</label></div>",r=e.title,o=new BootstrapDialog({title:u("translate")("M_tip50",{gname:r}),message:$(n),type:"type-warning",buttons:[{label:u("translate")("CANCEL"),cssClass:"btn-default",action:function(e){e.close()}},{id:"button-c",label:u("translate")("RESET"),cssClass:"btn-primary",hotkey:13,action:function(n){var s=n.getModalBody().find("input:checked").val();o.enableButtons(!1),o.setClosable(!1),n.getModalBody().html('<h2 class="text-warning">'+r+u("translate")("M_tip51")+"</h2>");var i=a.curGroup.load;a.curGroup.load="no",t.resetGroup(e.group_id,s).then(function(e){if(e.res)o.setType("type-success"),o.getModalBody().html('<h2 class="text-success">'+u("translate")("M_tip52",{gname:r})+'<i class="green glyphicon glyphicon-ok"></i></h2>'),o.setClosable(!0),D.getCurGroupStatus(),a.curGroup.load="no",D.clearInterval(),setTimeout(function(){o.close()},500);else{o.setType("type-danger");var t=e.msg||u("translate")("M_tip53",{cname:r});o.getModalBody().html('<h2 class="text-error">'+t+'<i class="red glyphicon glyphicon-remove"></i></h2>'),o.setClosable(!0),a.curGroup.load=i}},function(){o.setType("type-danger"),o.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),o.setClosable(!0),a.curGroup.load=i})}}],closable:!0});o.open()}()}function w(e){var n=function(){var n='<h2 class="text-warning">'+u("translate")("M_tip55",{gname:e.title})+"</h2>",r=new BootstrapDialog({title:u("translate")("M_tip56"),type:"type-warning",message:function(){return n},closable:!1});r.open(),t.deleteGroup(e.group_id).then(function(n){if(n.res){r.setType("type-success"),r.getModalBody().html('<h2 class="text-success">'+e.title+u("translate")("M_tip57")+'<i class="green glyphicon glyphicon-ok"></i></h2>'),r.setClosable(!0),D.clearInterval();var o=D.groupList.slice(0),s=0;angular.forEach(o,function(t,n){t.title===e.title&&(D.groupList.splice(n,1),s=n-1)}),s>=0&&D.groupList.length>0?(D.groupList[s].active=!0,a.curGroupName=D.groupList[s].title,a.curGroupId=D.groupList[s].group_id,a.curGroup=D.groupList[s],a.groupList=D.groupList,window.localStorage.setItem("group",a.curGroupId),D.menu.currentGc=a.curGroupName,t.getGraphicByGroupId(a.curGroupId).then(function(e){e&&(D.getCurGroupStatus(),E=c(function(){D.getCurGroupStatus()},5e3))})):0===D.groupList.length&&($("#flowbox").empty(),window.localStorage.removeItem("group"),D.comsDragable=!0,m(!0),D.clearInterval()),setTimeout(function(){r.close()},500)}else{r.setType("type-danger");var i=n.msg||e.title+u("translate")("M_tip58");r.getModalBody().html('<h2 class="text-error">'+i+'<i class="red glyphicon glyphicon-remove"></i></h2>'),r.setClosable(!0)}},function(){r.setType("type-danger"),r.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),r.setClosable(!0)})};if("yes"===a.curGroup.load)return void BootstrapDialog.alert({title:u("translate")("TIP"),message:u("translate")("M_tip59"),type:BootstrapDialog.TYPE_DANGER,closable:!1,buttonLabel:u("translate")("SURE")});BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_tip60",{gname:e.title}),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&n()}})}function x(){var e=new BootstrapDialog({title:"Tserver Info",type:"type-warning",message:function(){return'<h2 class="text-warning">'+u("translate")("M_tip61")+"</h2>"},closable:!1});e.open(),t.stopTServer().then(function(t){t?(e.setType("type-success"),e.getModalBody().html('<h2 class="text-success">'+u("translate")("M_tip63")+'<i class="green glyphicon glyphicon-ok"></i></h2>'),e.setClosable(!0),D.tserver.num=0,setTimeout(function(){e.close()},300)):(e.setType("type-danger"),e.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip62")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0))},function(){e.setClosable(!0),e.setType("type-danger"),e.getModalBody().html('<h2 class="text-error">'+u("translate")("Wlcw")+'<i class="red glyphicon glyphicon-remove"></i></h2>')})}function I(){t.getTserverStatus().then(function(e){D.tserver.num=e})}function k(){t.getDbModelList().then(function(e){D.modelList=e})}var D=this;D.menu={moshi:{map:!0,list:!1},dialog:!1,dq:{left:!0,right:!1,center:!1,top:!1,bottom:!1,justify:!1},cons:!1,sideBarClose:!0,currentGc:"",comPanelShow:!1},p("M_zjm").then(function(e){D.menu.currentGc=e}),D.searchDis=!1,D.com={operation:!1,start:!1,restart:!1,stop:!1,scn_start:!1},D.user={name:"admin",auth:"super"},D.q="",D.tserver={num:0},D.isOpen=!0,D.proName="",D.groupList=[],D.comsDragable=!1,D.modelList=[];var E,S=function(){BootstrapDialog.alert({title:u("translate")("TIP"),message:u("translate")("TIMEOUT"),type:BootstrapDialog.TYPE_WARNING,closable:!1,buttonLabel:u("translate")("SURE"),callback:function(e){l.location.href="/login"}})},T=window.localStorage.getItem("proId"),C=window.localStorage.getItem("proName");T&&C||(l.location.href="/index"),t.checkCurrentUserAuth().then(function(e){if(e.res){var t=e.user;D.user.name=t.name,D.user.auth=t.auth,window.localStorage.setItem("uname",t.name),window.localStorage.setItem("uauth",t.auth),D.proName=C,f(),I(),k()}else S()},function(){S()}),D.listView={mapList:[],group:null,curView:"map",param:"all"},D.changeMs=function(e){"list"===e?(D.listView.curView="list",D.listView.group=a.curGroup,D.listView.mapList=o.getMapList(),"yes"===a.curGroup.load&&D.getCurGroupStatus(),r.go("/"),$("#viewMapId").hide(),$("#viewListId").show(),D.menu.moshi.map=!1):(D.listView.curView="map",D.menu.moshi.map=!0,$("#viewListId").hide(),$("#viewMapId").show(),r7Plumb.instance.repaintEverything())},D.showDialog=function(){D.menu.dialog=!D.menu.dialog},D.changeDq=function(e){switch(e){case 1:D.menu.dq.left=!0,D.menu.dq.right=D.menu.dq.center=D.menu.dq.top=D.menu.dq.bottom=D.menu.dq.justify=!1,r7PlumbSelectArea.alignLeft();break;case 2:D.menu.dq.right=!0,D.menu.dq.left=D.menu.dq.center=D.menu.dq.top=D.menu.dq.bottom=D.menu.dq.justify=!1,r7PlumbSelectArea.alignRight();break;case 3:D.menu.dq.center=!0,D.menu.dq.left=D.menu.dq.right=D.menu.dq.top=D.menu.dq.bottom=D.menu.dq.justify=!1,r7PlumbSelectArea.alignMiddle();break;case 4:D.menu.dq.justify=!0,D.menu.dq.left=D.menu.dq.center=D.menu.dq.top=D.menu.dq.bottom=D.menu.dq.right=!1,r7PlumbSelectArea.alignMiddle();break;case 5:D.menu.dq.top=!0,D.menu.dq.left=D.menu.dq.center=D.menu.dq.right=D.menu.dq.bottom=D.menu.dq.justify=!1,r7PlumbSelectArea.alignTop();break;case 6:D.menu.dq.bottom=!0,D.menu.dq.left=D.menu.dq.center=D.menu.dq.top=D.menu.dq.right=D.menu.dq.justify=!1,r7PlumbSelectArea.alignBottom()}},D.saveCanvas=function(){if(D.groupList.length<=0)return void i.error(u("translate")("M_wfbcst"));o.save_graphics_alert(a.curGroupId)},D.createNewGroup=function(){r.go("/.group_view.property",{group:"new"})},D.deleteComponent=function(){if(!a.comInfo)return void i.error(u("translate")("M_xssczj"));var e=a.comInfo,n=e.id,r=function(){t.deleteComponents(e).then(function(t){t&&(i.success(u("translate")("Sccg")),r7Plumb.deleteElement(n),o.save_graphics_no_alert(e.group_id),D.menu.currentGc=e.groupName)})};e&&(e.cid&&"undefined"!==e.cid?"yes"===a.curGroup.load?i.error(u("translate")("M_zyxwfs")):BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_qrsc",{cname:e.name}),type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(e){e&&r()}}):BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_qrsc",{cname:e.name}),type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:u("translate")("CANCEL"),btnOKLabel:u("translate")("OK"),btnOKClass:"btn-warning",callback:function(t){t&&(r7Plumb.deleteElement(e.id),o.save_graphics_no_alert(e.group_id),D.menu.currentGc=e.groupName)}}))},D.toggleSideBar=function(){var t=$(".page-header-fixed"),n=$(".page-sidebar");$(".sidebar-search",n).removeClass("open"),t.hasClass("page-sidebar-closed")?(t.removeClass("page-sidebar-closed"),t.hasClass("page-sidebar-fixed")&&n.css("width",""),D.isOpen=!0):(t.addClass("page-sidebar-closed"),D.isOpen=!1),e.$broadcast("consoleView",D.isOpen)},D.toggleConsole=function(){D.menu.moshi.map||D.changeMs("map");var e=a.comInfo,t="";if(null===e)t="/";else{var n=e.rtype;"capture"===n?t="/main/capture?gn="+e.group_id+"&cn="+e.cid+"&pt="+e.p_dbType+"&id="+e.id:"queue"===n?t="/main/queue?gn="+e.group_id+"&cn="+e.cid+"&pt="+e.p_dbType+"&pn="+e.p_dbId+"&id="+e.id+"&tab=tab1":"apply"===n&&(t="/main/loader?gn="+e.group_id+"&cn="+e.cid+"&pt="+e.p_dbType+"&id="+e.id+"&tab=tab1")}s.url(t)},D.clearView=function(e){"flowbox"===e.target.id&&(D.menu.dialog=!1,D.menu.cons=!1,r.go("/"))},D.showConsole=function(e){},D.showPzDialog=function(e){var t=null,n=function(){var e=a.curGroup&&a.curGroup.load;"yes"===e?(D.com.operation=!0,D.getCurGroupStatus()):"no"===e&&(D.com.operation=!0,"yes"!==a.curGroup.load&&(D.com.start=!0,D.com.restart=!1,D.com.stop=!1,D.com.scn_start=!0))};"capture"===e.rtype?(n(),(t=o.getParent(e.id))&&t.name&&t.type&&(e.p_dbType=t.type,e.p_dbId=t.name)):"queue"===e.rtype?(D.getCurGroupStatus(),D.com.operation=!1,(t=o.getSource(e.id))&&(e.p_dbType=t.type,e.p_dbId=t.name)):"apply"===e.rtype?(n(),(t=o.getSource(e.id))&&t.name&&t.type&&(e.p_dbType=t.type,e.p_dbId=t.name)):"transfer"===e.rtype?(n(),(t=o.getParent(e.id))&&t.name&&t.type&&(e.p_dbType=t.type,e.p_dbId=t.name)):"etl"===e.rtype?(n(),D.com.scn_start=!1,(t=o.getParent(e.id))&&t.name&&t.type&&(e.p_dbType=t.type,e.p_dbId=t.name)):"ftp"===e.rtype?(n(),D.com.scn_start=!1,(t=o.getParent(e.id))&&t.name&&t.type&&(e.p_dbType=t.type,e.p_dbId=t.name)):D.com.operation=!1,e.groupName=a.curGroupName,e.group_id=a.curGroupId,a.comInfo=e,a.curId=e.id;var r=e.name?e.name:"";D.menu.currentGc=a.curGroupName+"."+r},D.changeCurrentCom=function(e){var t,n="",c="";if("database"===e.rtype)e.group_id=a.curGroupId,a.curId=e.id,n="gn="+e.group_id+"&cn="+e.name+"&id="+e.id+"&cid="+e.cid,n="unnamed"===e.name?"/main/db_view/property?"+n:"/main/db_view/status?"+n,s.url(n);else if("capture"===e.rtype){if(e.group_id=a.curGroupId,a.curId=e.id,!(t=o.getParent(e.id)))return void i.error(u("translate")("M_qljzq"));if(!t.name||!t.type)return void i.error(u("translate")("M_ydts"));e.p_dbId=t.name,e.p_dbType=t.type,n="gn="+e.group_id+"&cn="+e.name+"&pn="+e.p_dbId+"&pt="+e.p_dbType+"&id="+e.id+"&cid="+e.cid,n="unnamed"===e.name?"/main/cp_view/property?"+n:"/main/cp_view/status?"+n,s.url(n)}else if("queue"===e.rtype){if(e.group_id=a.curGroupId,a.curId=e.id,!(t=o.getParent(e.id)))return void i.error("请配置完善上一级组件！");if(!t.type||"undefined"===t.type)return void i.error("请配置完善上一级组件！");t=o.getSource(e.id),t&&(e.p_dbType=t.type,e.p_dbId=t.name),e.p_dbType=t.type,n="gn="+e.group_id+"&cn="+e.name+"&pt="+e.p_dbType+"&id="+e.id+"&cid="+e.cid,n="unnamed"===e.name?"/main/queue_view/property?"+n:"/main/queue_view/status?"+n,s.url(n)}else if("apply"===e.rtype){e.group_id=a.curGroupId,a.curId=e.id;var l="";if(null===(t=o.getSource(e.id))||!t.name||"undefined"===t.name)return void i.error(u("translate")("M_pzldts"));l=t.id;var p=t.type,d=t.name;if(null===(t=o.getChild(e.id))||!t.name||"undefined"===t.name)return void i.error(u("translate")("M_pzlts1"));var m=t.type;if(!(t=o.getChild(l)))return void i.error(u("translate")("M_cppzcw"));var _,f="";t&&"capture"===t.rtype&&(f=t.name),_="oracle"===m||"oracle_rac"===m?"mqpublisher"===m?"mqapply":"oracle":m,n="gn="+e.group_id+"&cn="+e.name+"&sn="+d+"&st="+p+"&tt="+_+"&id="+e.id+"&cid="+e.cid+"&cpid="+f,n="unnamed"===e.name?"/main/loader_view/property?"+n:"/main/loader_view/status?"+n,s.url(n)}else if("transfer"===e.rtype)e.group_id=a.curGroupId,a.curId=e.id,n="gn="+e.group_id+"&cn="+e.name+"&id="+e.id+"&cid="+e.cid,n="unnamed"===e.name?"/main/tclient_view/property?"+n:"/main/tclient_view/status?"+n,s.url(n);else if("etl"===e.rtype){if(e.group_id=a.curGroupId,a.curId=e.id,null===(t=o.getSource(e.id))||!t.name||"undefined"===t.name)return void i.error("配置ETL组件之前，请先配置好与ETL关联的组件！");p=t.type,d=t.name,n="gn="+e.group_id+"&cn="+e.name+"&pn="+d+"&pt="+p+"&id="+e.id+"&cid="+e.cid,n="unnamed"===e.name?"/main/etl_view/property/config?"+n:"/main/etl_view/status?"+n,s.url(n)}else if("ftp"===e.rtype){e.group_id=a.curGroupId,a.curId=e.id;var g={gn:e.group_id,cn:e.name,id:e.id,cid:e.cid};"unnamed"===e.name?r.go("/.ftp_view.property",g):r.go("/.ftp_view.status",g)}a.comInfo=e,a.curId=e.id,c=e.name?e.name:"",D.menu.currentGc=a.curGroupName+"."+c},D.startEngine=function(){g()},D.stopEngine=function(){v()},D.restartEngine=function(){h()},D.startScnEngine=function(){b()};var L=d.$on("createGroup",function(e,n){D.isOpen||D.toggleSideBar();var r={title:n.groupName,active:!0,desc:n.desc,log_del_duration:n.logTime,load:"no",group_id:n.group_id};angular.forEach(D.groupList,function(e,t){e.active&&(e.active=!1)}),D.groupList.push(r),a.curGroupName=r.title,a.curGroupId=r.group_id,a.curGroup=r,D.menu.currentGc=a.curGroupName,D.comsDragable&&(m(!1),D.comsDragable=!1),D.clearInterval(),t.getGraphicByGroupId(a.curGroupId).then(function(e){e&&(D.getCurGroupStatus(),E=c(function(){D.getCurGroupStatus()},5e3))})}),q=d.$on("modifyGroup",function(e,t){angular.forEach(D.groupList,function(e){e.group_id===t.group_id&&(e.desc=t.desc,e.log_del_duration=t.logTime,e.title=t.groupName,a.curGroupId===e.group_id&&(a.curGroupName=t.groupName,a.curGroup=e,D.menu.currentGc=t.groupName))})}),A=d.$on("tserverStarted",function(e,t){D.tserver.num=1}),M=d.$on("createModel",function(e,t){D.modelList.push(t)}),z=d.$on("deleteModel",function(e,t){k()});e.$on("$destroy",function(){D.clearInterval(),L(),q(),A(),M(),z()}),D.getCurGroupStatus=function(){a.curGroupName&&"yes"===a.curGroup.load&&t.getGroupStatus(a.curGroupId).then(function(e){if("ERROR"===e.command_return){e.return_data.error_message||e.return_data.error_msg;a.curGroup.load="no",BootstrapDialog.closeAll(),BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_xtjcts"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("SURE"),btnOKLabel:u("translate")("RECON"),btnOKClass:"btn-warning",callback:function(e){e?a.curGroup.load="yes":D.clearInterval()}})}else{var t=e.return_data,n=[];angular.isArray(t.server)?n=t.server:n.push(t.server);var r=$("#flowbox").find(".component"),o=a.comInfo,s=[],i=0,c=!1;angular.forEach(n,function(e){o&&o.rtype===e.type&&o.cid===e.name&&(c=!0),angular.forEach(r,function(t,n){var r=$(t).attr("realid"),a=$(t).attr("name"),c=$(t).attr("id"),l=$(t).attr("rtype"),u={id:c,name:a,type:l,status:"-",st:"-",temp:"-",scn:"-",insert:"-",update:"-",delete:"-",ddl:"-"};if(r===e.name&&l===e.type){if(0===i)u.status=e.status,u.st=e.start_time,u.temp=e.work_scn_time,u.scn=e.work_scn,u.insert=e.op_insert,u.update=e.op_update,u.delete=e.op_delete,u.ddl=e.op_ddl,s.push(u);else{var p=s[n];p.status=e.status,p.st=e.start_time,p.temp=e.work_scn_time,p.scn=e.work_scn,p.insert=e.op_insert,p.update=e.op_update,p.delete=e.op_delete,p.ddl=e.op_ddl}"running"===e.status?(o&&o.id===c&&(D.com.start=!1,D.com.restart=!0,D.com.stop=!0,D.com.scn_start=!1),$("#"+c).find(".km-btn-full").addClass("drag-success").removeClass("drag-cir").removeClass("drag-err").removeClass("drag-waring")):"not started"===e.status||"terminated"===e.status||"errorexit"===e.status?(o&&o.id===c&&(D.com.start=!0,D.com.restart=!1,D.com.stop=!1,D.com.scn_start=!0),$("#"+c).find(".km-btn-full").addClass("drag-err").removeClass("drag-cir").removeClass("drag-waring").removeClass("drag-success")):(o&&o.id===c&&(D.com.start=!1,D.com.restart=!0,D.com.stop=!0,D.com.scn_start=!1),$("#"+c).find(".km-btn-full").addClass("drag-waring").removeClass("drag-cir").removeClass("drag-err").removeClass("drag-success"))}else 0===i&&s.push(u)}),i++}),c||(D.com.start=!0,D.com.restart=!1,D.com.stop=!1,D.com.scn_start=!0),o&&"ftp"===o.rtype&&(D.com.scn_start=!1),D.listView.mapList=_(D.listView.param,s)}},function(){a.curGroup.load="no",BootstrapDialog.closeAll(),BootstrapDialog.confirm({title:u("translate")("TIP"),message:u("translate")("M_sbcw"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:u("translate")("SURE"),btnOKLabel:u("translate")("RECON"),btnOKClass:"btn-warning",callback:function(e){e?a.curGroup.load="yes":D.clearInterval()}})})},D.clearInterval=function(){angular.isDefined(E)&&(c.cancel(E),E=void 0)},D.full_syc_data=function(){var e=o.getLoaders();if(0===e.length)return void i.error(u("translate")("M_qtbpz"));var t=e[0];r.go("/.full_syc_view.loader",{gn:a.curGroupId,cn:t.name,st:t.st,sn:t.sn,name:t.cname,cid:t.cid})},D.changeGroup=function(e){if(e.title!==a.curGroupName){window.localStorage.setItem("group",e.group_id);var n=0;angular.forEach(D.groupList,function(r,s){if(r.title===e.title){if(++n>=2)return;D.groupList[s].active=!0,a.curGroup=r,a.curGroupName=r.title,a.curGroupId=r.group_id,D.menu.currentGc=r.title,a.comInfo=null,a.curId="",D.clearInterval(),t.getGraphicByGroupId(r.group_id).then(function(e){e&&(D.getCurGroupStatus(),E=c(function(){D.getCurGroupStatus()},5e3)),D.listView.mapList=[],"list"===D.listView.curView&&(D.listView.group=a.curGroup,D.listView.mapList=o.getMapList()),D.curGn=a.curGroupName})}else D.groupList[s].active=!1}),D.com.operation=!1,r.go("/")}},D.getCurGraphic=function(){a.curGroupId&&t.getGraphicByGroupId(a.curGroupId)},p(["START","STOP","RESTART","RESET","DELETE","PROPERTY"]).then(function(e){D.menuOptions=[[e.START,function(e){var t=e.group;t.rtype="group",g(t)}],null,[e.STOP,function(e){var t=e.group;t.rtype="group",v(t)}],null,[e.RESTART,function(e){var t=e.group;t.rtype="group",h(t)}],null,[e.RESET,function(e){y(e.group)}],null,[e.DELETE,function(e){w(e.group)}],null,[e.PROPERTY,function(e){var t=e.group;r.go("/.group_view.status",{group:t})}]]}),D.stopTerver=function(){x()},D.showTserverInfo=function(){t.getTserverConfig().then(function(e){e?s.url("/main/tserver_view/status?cn="+e):s.url("/main/tserver_view/property?cn=no-ne")})},D.outputPz=function(){t.exportConfigFile()},D.inputPz=function(){$("#file").click()},D.changeFiles=function(){var e=null,n=document.getElementById("file");if(n.files&&n.files[0]){e=n.files[0].name;var r="<label>"+u("translate")("M_wjmc")+'</label><div class="text-info">'+e+"</div>",a=new BootstrapDialog({title:u("translate")("M_drpzwj"),message:$(r),type:"type-warning",buttons:[{label:u("translate")("CANCEL"),cssClass:"btn-default",action:function(e){e.close()}},{id:"button-c",label:u("translate")("M_kssc"),cssClass:"btn-primary",hotkey:13,action:function(r){a.enableButtons(!1),a.setClosable(!1),a.setType("type-warning"),a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_wjscz")+"</h2>"),e=n.files[0];var o=new FormData;o.append("file",e);var s=new XMLHttpRequest;s.open("post","/dipserver/upload_config",!0),s.setRequestHeader("X-XSRF-TOKEN",$.cookie("XSRF-TOKEN")),s.onload=function(){if(s.status>=200&&s.status<300||304===s.status){var e=JSON.parse(s.responseText);"SUCCESS"===e.command_return?(a.setType("type-success"),a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip1")+"</h2>"),t.importConfigFile(e.fileName).then(function(e){e.res?(a.setType("type-success"),a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip2")+"</h2>"),setTimeout(function(){a.close(),l.location.href="/index"},500)):(a.setType("type-danger"),e.errorCode?a.getModalBody().html('<h2 class="text-error">'+u("translate")(e.errorCode)+"</h2>"):a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip3")+"</h2>")),a.setClosable(!0)},function(e){a.setType("type-danger"),a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip4")+"</h2>"),a.setClosable(!0)})):(a.setType("type-danger"),a.getModalBody().html('<h2 class="text-error">'+e.error_message+"</h2>"),a.setClosable(!0))}else a.setType("type-danger"),a.getModalBody().html('<h2 class="text-error">'+u("translate")("M_tip5")+"</h2>"),a.setClosable(!0)},s.send(o)}}],closable:!1});a.open()}},D.editGroup=function(){D.groupList.length<=0||$.isEmptyObject(a.curGroup)||r.go("/.group_view.status",{group:a.curGroup})},D.outputErrFiles=function(){t.exportErrFile()},D.checkCurModel=function(e,t){$(e.target).parent().addClass("active").siblings().removeClass("active"),r.go("/.db_model_view",{model:t})},D.getComTemplate=function(){if(D.groupList.length<=0)return void i.error(u("translate")("M_tip6"));$("#flowbox").find("div.component").length<=0?t.getCommonTemplate().then(function(e){e.res&&(r7Plumb.drawGraphic(e.data),o.save_graphics_no_alert(a.curGroupId))}):i.error(u("translate")("M_stbcz"))},D.showBigPage=function(){l.open("/view")},D.changAc=function(e){D.listView.param=e,D.getCurGroupStatus()}}],controllerAs:"$ctrl",bindToController:!0,link:function(e,t,n,a){var o=a||{};r(e,o),$(document).contextmenu({delegate:".component",autoFocus:!0,preventContextMenuForPopup:!0,preventSelect:!0,menu:[{}],beforeOpen:function(){return!1}}),r7Plumb.dragInit(),$("#flowbox").on("click","div.component",function(){e.$apply(function(){o.menu.dialog=!o.menu.dialog})}),$("#file").on("change",function(){e.$apply(function(){o.changeFiles()})})},templateUrl:"main_view/main_view.html"}}]).directive("repeatFinish",function(){return{link:function(e){e.$last&&$("#flexbox").find(".flex-viewport").jCarouselLite({btnPrev:"#flexbox .flex-prev",btnNext:"#flexbox .flex-next",circular:!1,start:0,scroll:1,speed:500,visible:9,mouseWheel:!0})}}})}(),function(){function e(e,t,n,r,a,o){this.deleteComponents=function(a){var o={group:a.group_id,component_name:a.name,type:a.rtype,component_id:a.cid},s=!1;return o=n.md5Data(o),e.postDataList("/dipserver/delete_component",o).then(function(e){return n.equalMd5Data(e)&&(e.status?s=!0:t.error(e.response.error_msg)),s},function(e){t.error(r("translate")("M_wlscsb"))})},this.getGroupStatus=function(t){var n="<dip_command><command>query_one_group_status</command><command_data><group>"+t+"</group></command_data></dip_command>";return e.postDataList("/dipserver/query_one_group_status",{xmlDoc:n})},this.getAllGroups=function(a,o,s){var i={projectid:a,users:o,auth:s},c={status:!0,list:[]};return i=n.md5Data(i),e.postDataList("/dipserver/fetch_all_groups",i).then(function(e){return n.equalMd5Data(e)&&(e.status?e.response&&angular.isObject(e.response)?angular.isArray(e.response.group)?c.list=e.response.group:angular.isObject(e.response.group)&&c.list.push(e.response.group):c.status=!1:e.response&&t.error(e.response.error_msg)),c},function(){t.error(r("translate")("M_hqzsb"))})},this.getGraphicByGroupId=function(r){var a=!1,o=n.md5Data({group:r});return e.postDataList("/dipserver/require_graphic",o).then(function(e){return n.equalMd5Data(e)&&(e.status?(r7Plumb.drawGraphic(e),a=!0):e.response&&t.error(e.response.error_msg)),a},function(e){return e})},this.getDbModelList=function(){var r=n.md5Data({}),o=[];return e.postDataList("/dipserver/query_fav_db",r).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;if(r&&r.fav_dbs){var s=r.fav_dbs.db,i=[];angular.isArray(s)?i=s:angular.isObject(s)&&i.push(s),angular.forEach(i,function(e){e.db_password&&(e.db_password=a.de_des(e.db_password))}),o=i}}else e.response&&t.error(e.response.error_msg);return o})},this.getTserverConfig=function(){var a=n.md5Data({}),o="";return e.postDataList("/dipserver/query_tserver_config",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&angular.isObject(r)&&r.server_config&&r.server_config.user&&(o=r.server_config.user.name)}else e.response&&t.error(e.response.error_msg);return o},function(){t.error(r("translate")("Wlcw"))})},this.getTserverStatus=function(){var t=0;return e.postDataList("/dipserver/query_tserver_status",{xmlDoc:"<dip_command><command>query_tserver_status</command><command_data></command_data></dip_command>"}).then(function(e){if("SUCCESS"===e.command_return){var n=e.return_data;if(n&&n.server_info){var r=n.server_info;"tserver"===r.type&&"running"===r.status&&(t=1)}}return t})},this.stopTServer=function(){var t=!1;return e.postDataList("/dipserver/stop_server",{xmlDoc:"<dip_command><command>stop_server</command><command_data><type>tserver</type></command_data></dip_command>"}).then(function(e){return"SUCCESS"===e.command_return&&(t=!0),t})},this.deleteGroup=function(t){var r={group:t},a={res:!1,msg:""};return r=n.md5Data(r),e.postDataList("/dipserver/delete_group",r).then(function(e){return n.equalMd5Data(e)&&(e.status?a.res=!0:(a.res=!1,e.response&&e.response.error_msg&&(a.msg=e.response.error_msg))),a})},this.resetGroup=function(t,r){var a={group:t,clean_all:r},o={res:!1,msg:""};return a=n.md5Data(a),e.postDataList("/dipserver/group_reset",a,0).then(function(e){return n.equalMd5Data(e)&&(e.status?o.res=!0:(o.res=!1,e.response&&e.response.error_msg&&(o.msg=e.response.error_msg))),o})},this.isSourceDatabaseSame=function(r){var a={group:r.gn,sorcedb_name:r.sn,targetdb_name:r.tn},o=!1;return a=n.md5Data(a),e.postDataList("/dipserver/query_all_db_info",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.same&&"yes"===r.same.toLowerCase()&&(o=!0)}else t.error(e.response.error_msg),o="error";return o})},this.startServerByScn=function(t,n,r,a){var o="<dip_command><command>start_server_by_scn</command><command_data><group>"+t.group_id+"</group><type>"+n+"</type><name>"+t.cid+"</name><start_scn>"+r+"</start_scn><low_scn>"+a+"</low_scn></command_data></dip_command>",s={res:!1,msg:""};return e.postDataList("/dipserver/start_server_by_scn",{xmlDoc:o},0).then(function(e){return"ERROR"===e.command_return?(s.res=!1,s.msg=e.error_message||e.return_data&&e.return_data.error_message||""):s.res=!0,s})},this.stopServer=function(t){var n="<dip_command><command>stop_server</command><command_data><group>"+t.group_id+"</group><type>"+t.rtype+"</type><name>"+t.cn+"</name></command_data></dip_command>",r={res:!1,msg:""};return e.postDataList("/dipserver/stop_server",{xmlDoc:n},0).then(function(e){return"ERROR"===e.command_return?(r.res=!1,r.msg=e.error_message||e.return_data&&e.return_data.error_message||""):r.res=!0,r})},this.restartServer=function(t){var n="<dip_command><command>restart_server</command><command_data><group>"+t.group_id+"</group><type>"+t.rtype+"</type><name>"+t.cn+"</name></command_data></dip_command>",r={res:!1,msg:""};return e.postDataList("/dipserver/start_server",{xmlDoc:n},0).then(function(e){return"ERROR"===e.command_return?(r.res=!1,r.msg=e.error_message||e.return_data&&e.return_data.error_message||""):r.res=!0,r})},this.startServer=function(t){var n="<dip_command><command>start_server</command><command_data><group>"+t.group_id+"</group><type>"+t.rtype+"</type><name>"+t.cn+"</name></command_data></dip_command>",r={res:!1,msg:""};return e.postDataList("/dipserver/start_server",{xmlDoc:n},0).then(function(e){return"ERROR"===e.command_return?(r.res=!1,r.msg=e.error_message||e.return_data&&e.return_data.error_message||""):r.res=!0,r})},this.getCommonTemplate=function(){var a=n.md5Data({}),o={res:!1,data:{}};return e.postDataList("/dipserver/fetch_template",a).then(function(e){return n.equalMd5Data(e)&&e.status&&(o.res=!0,o.data=e),o},function(e){t.error(r("translate")("M_cwsb"))})},this.exportErrFile=function(){var a=n.md5Data({});e.postDataList("/dipserver/export_errinfo",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var a=e.response;a&&a.filename?o.open("/download/"+a.filename):t.warning(r("translate")("M_mykpz"))}else t.error(e.response.error_msg)},function(){t.error(r("translate")("Wlcw"))})},this.importConfigFile=function(t){var r=n.md5Data({filename:t}),a={res:!1,errorCode:""};return e.postDataList("/dipserver/import_config",r,0).then(function(e){return n.equalMd5Data(e)&&(e.status?a.res=!0:(a.res=!1,a.errorCode="",e.response&&e.response.error_code&&(a.errorCode=e.response.error_code))),a})},this.exportConfigFile=function(){var a=n.md5Data({});e.postDataList("/dipserver/export_config",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var a=e.response;a&&a.filename?o.open("/download/"+a.filename):t.warning(r("translate")("M_mykpz"))}else t.error(e.response.error_msg)},function(e){t.error(r("translate")("Wlcw"))})},this.checkCurrentUserAuth=function(){var t={res:!1,user:null};return e.getDataList("/isAuth",{}).then(function(e){return e.isAuth&&(t.res=!0,t.user=e.user||{}),t})}}angular.module("myApp.main_view.service",[]).config(["$qProvider",function(e){e.errorOnUnhandledRejections(!1)}]).service("mainService",e),e.$inject=["httpService","tipsService","md5Service","$filter","tDes","$window"]}(),angular.module("myApp.db_view",["ui.bootstrap","myApp.dbService","myApp.dbComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/db_view/","/main/db_view/status"),t.state("/.db_view",{abstract:!0,url:"/db_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Db_sjkpz")}],dataList:["$transition$","dbService",function(e,t){var n=e.params()
;return n.gn&&n.cn&&"unnamed"!==n.cn&&n.cid?t.getDbInfo(n):"init"}]},bindings:{title:"title"}}).state("/.db_view.status",{url:"/status?gn&cn&id&cid",component:"dbStatus",bindings:{dl:"dataList"}}).state("/.db_view.property",{url:"/property?gn&cn&id&cid",component:"dbProperty",bindings:{dl:"dataList"}}).state("/.db_model_view",{url:"/db_model_view",component:"dbModel",params:{model:null}})}]),function(){function e(e,t,n,r,a){this.getDbInfo=function(o){var s={group:o.gn,component_id:o.cid},i=null;return s=n.md5Data(s),e.postDataList("/dipserver/query_db_info",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r={},o=e.response;r.dbName=o.component_name,r.bh=o.as_source_db,r.dbType=o.db_type,r.serviceName=o.db_id,r.ipAddress=o.db_ip,r.port=o.db_port,r.uName=o.db_user,r.uPwd=a.de_des(o.db_password),i=r}else e.response&&t.error(e.response.error_msg);return i},function(){t.error(r("translate")("Wlcw"))})},this.testDbConnection=function(t){var r={db_type:t.dbType,db_ip:t.ipAddress,db_port:t.port,db_user:t.uName,db_password:a.en_des(t.uPwd),db_id:t.serviceName},o=!1;return r=n.md5Data(r),e.postDataList("/dipserver/test_db_connection",r,0).then(function(e){return n.equalMd5Data(e)&&e.status&&(o=!0),o})},this.testDbSourceEnv=function(t){var r={db_is_source:t.bh,db_type:t.dbType,db_ip:t.ipAddress,db_port:t.port,db_user:t.uName,db_password:a.en_des(t.uPwd),db_id:t.serviceName},o={res:!1,info:{}};return r=n.md5Data(r),e.postDataList("/dipserver/check_sourcedb_env",r).then(function(e){return n.equalMd5Data(e)&&e.status&&(o.res=!0,o.info=e.response||{}),o})},this.getModelList=function(){var t=n.md5Data({}),r=[];return e.postDataList("/dipserver/query_fav_db",t).then(function(e){if(n.equalMd5Data(e)&&e.status){var t=e.response;if(t&&t.fav_dbs){var o=t.fav_dbs.db,s=[];angular.isArray(o)?s=o:angular.isObject(o)&&s.push(o),angular.forEach(s,function(e){e.db_password&&(e.db_password=a.de_des(e.db_password))}),s.unshift({db_name:"",db_type:""}),r=s}}return r})},this.saveDbInfo=function(t,r,o){var s={group:t.gn,component_name:o.dbName,db_type:r,db_ip:o.ipAddress,db_port:o.port,db_user:o.uName,db_password:a.en_des(o.uPwd),db_id:o.serviceName,as_source_db:o.bh,component_id:t.cid};s=n.md5Data(s);var i={res:!1,comId:"",msg:""};return e.postDataList("/dipserver/save_db_info",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(i.res=!0,e.response&&(i.comId=e.response.component_id)):i.msg=e.response.error_msg),i})},this.saveModelInfo=function(t,r){var o={db_name:t.mdName,db_type:r.dbType,db_ip:r.ipAddress,db_port:r.port,db_user:r.uName,db_password:a.en_des(r.uPwd),db_id:r.serviceName,as_source_db:"yes"};o=n.md5Data(o);var s=!1;return e.postDataList("/dipserver/add_fav_db",o).then(function(e){return n.equalMd5Data(e)&&e.status&&(s=!0),s})},this.fetchYclTable=function(o){var s={db_type:o.dbType,db_ip:o.ipAddress,db_port:o.port,db_user:o.uName,db_password:a.en_des(o.uPwd),db_id:o.serviceName};s=n.md5Data(s);var i=[];return e.postDataList("/dipserver/query_db_table",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response||[],a=0;angular.forEach(r,function(e,t){var n={},r=0;n.name=t,n.icon="/img/ico/schema.png",n.children=[],n.id=++a,e.table&&angular.isArray(e.table)&&angular.forEach(e.table,function(e){var t={},a=0;t.name=e.name,t.checked="yes"===e.sup_log,t.checked&&r++,t.icon="/img/ico/object.png",t.id=++a,n.children.push(t)}),n.checked=r>0,i.push(n)})}else t.error(e.response&&e.response.error_msg);return i},function(e){t.error(r("translate")("Wlcw"))})},this.sqlCfgEnv=function(o,s){var i={group:o.gn,component_name:o.cid,db_type:s.dbType,db_ip:s.ipAddress,db_port:s.port,db_user:s.uName,db_password:a.en_des(s.uPwd),db_id:s.serviceName},c={res:!1,data:null};return i=n.md5Data(i),e.postDataList("/dipserver/query_environment_status",i).then(function(e){return n.equalMd5Data(e)&&(e.status?(c.res=!0,c.data=e.response||{}):t.error(e.response&&e.response.error_msg)),c},function(){t.error(r("translate")("Wlcw"))})},this.startRecoverMode=function(o,s){var i={group:o.gn,component_name:o.cid,db_type:s.dbType,db_ip:s.ipAddress,db_port:s.port,db_user:s.uName,db_password:a.en_des(s.uPwd),db_id:s.serviceName},c=!1;return i=n.md5Data(i),e.postDataList("/dipserver/start_recover_mode",i).then(function(e){return n.equalMd5Data(e)&&(e.status?c=!0:t.error(e.response&&e.response.error_msg)),c},function(e){t.error(r("translate")("Wlcw"))})},this.startCdc=function(o,s){var i={group:o.gn,component_name:o.cid,db_type:s.dbType,db_ip:s.ipAddress,db_port:s.port,db_user:s.uName,db_password:a.en_des(s.uPwd),db_id:s.serviceName},c=!1;return i=n.md5Data(i),e.postDataList("/dipserver/start_cdc",i).then(function(e){return n.equalMd5Data(e)&&(e.status?c=!0:t.error(e.response&&e.response.error_msg)),c},function(){t.error(r("translate")("Wlcw"))})},this.addR7Cdc=function(o,s,i){var c={group:o.gn,component_name:o.cid,db_type:s.dbType,db_ip:s.ipAddress,db_port:s.port,db_user:s.uName,db_password:a.en_des(s.uPwd),db_id:s.serviceName,r7:i},l=!1;return c=n.md5Data(c),e.postDataList("/dipserver/add_r7_cdc",c).then(function(e){return n.equalMd5Data(e)&&(e.status?l=!0:t.error(e.response&&e.response.error_msg)),l},function(){t.error(r("translate")("Wlcw"))})},this.sqlCfgRollback=function(o){var s={db_type:o.dbType,db_ip:o.ipAddress,db_port:o.port,db_user:o.uName,db_password:a.en_des(o.uPwd),db_id:o.serviceName},i=!1;return s=n.md5Data(s),e.postDataList("/dipserver/dip_sqlcfg_rollback",s).then(function(e){return n.equalMd5Data(e)&&(e.status?i=!0:t.error(e.response&&e.response.error_msg)),i},function(){t.error(r("translate")("Wlcw"))})},this.deleteDbModel=function(a){var o={db_name:a},s=!1;return o=n.md5Data(o),e.postDataList("/dipserver/delete_fav_db",o).then(function(e){return n.equalMd5Data(e)&&(e.status?s=!0:t.error(e.response.error_msg)),s},function(){t.error(r("translate")("M_wlscsb"))})}}angular.module("myApp.dbService",[]).service("dbService",e),e.$inject=["httpService","tipsService","md5Service","$filter","tDes"]}(),function(){angular.module("myApp.dbComponent",["ngSanitize"]).component("dbStatus",{templateUrl:"database_view/status.component.html",bindings:{dl:"<"},controller:["$stateParams","tipsService","$filter","$state","dbService",function(e,t,n,r,a){function o(e){return a.testDbSourceEnv(e).then(function(e){if(e.res){s.data.testing=!0;var t=e.info;s.data.gd=t.archive_mode,s.data.dbv=t.version,s.data.auth=t.user_priv,s.data.dbms=t.dbms_priv,s.data.bcrz=t.spmt_log}else s.data.dbTestInfo=n("translate")("Db_cssb")})}var s=this;s.data={cb:"all",testing:!1,dbTestInfo:n("translate")("Db_cszsqy"),gd:{status:"",message:""},dbv:{status:"",message:""},auth:{status:"",message:""},dbms:{status:"",message:""},bcrz:{status:"",message:""}},s.real={comId:"",yes:n("translate")("YES"),no:n("translate")("NO")},s.property={},s.$onInit=function(){s.dl&&angular.isObject(s.dl)?(s.property=s.dl,s.real.comId=e.cid):r.go("/")},s.isTesting=!1,s.testDbInfo=function(){var e=s.property;if(!(e.dbName&&e.dbType&&e.serviceName&&e.ipAddress&&e.port&&e.uName&&e.uPwd))return void t.error(n("translate")("Db_pzxx"));s.isTesting=!0,s.data.testing=!1,s.data.dbTestInfo=n("translate")("Db_zzcs"),a.testDbConnection(e).then(function(t){t?o(e).finally(function(){s.isTesting=!1}):(s.isTesting=!1,s.data.dbTestInfo='<p class="db-test-danger">'+n("translate")("Db_cssb")+"</p>")},function(){s.isTesting=!1,s.data.dbTestInfo='<p class="db-test-danger">'+n("translate")("Db_cssb")+"</p>"})},s.changeBc=function(){}}]}).component("dbProperty",{templateUrl:"database_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","graphicService","$filter","$rootScope","dbService",function(e,t,n,r,a,o,s){function i(e){return s.testDbSourceEnv(e).then(function(e){if(e.res){p.data.testing=!0;var t=e.info;p.data.gd=t.archive_mode,p.data.dbv=t.version,p.data.auth=t.user_priv,p.data.dbms=t.dbms_priv,p.data.bcrz=t.spmt_log}else p.data.dbTestInfo=a("translate")("Db_cssb")})}function c(e){var t="",n=p.data.cb;if("all"===n)t="Alter database add supplemental log data  (primary key,unique index) columns;";else if("table"===n){if(null===e)return;t="";var r=e.getCheckedNodes();angular.forEach(r,function(e){if(0===e.level){var n=e.name;angular.forEach(e.children,function(e){!0===e.checked&&(t+="alter table "+n+"."+e.name+" add supplemental log data  (primary key,unique index) columns;\n")})}})}p.data.scripts=t}function l(e){var t=p.data.cb,n=$("#objTree"),r=p.property;if("all"===t)n.hide();else if("table"===t)if(null===e.dbTreeObj){if(!(r.dbType&&r.ipAddress&&r.port&&r.uName&&r.uPwd&&r.serviceName))return;s.fetchYclTable(r).then(function(t){n.empty(),e.zTreeNodes=t,e.dbTreeObj=$.fn.zTree.init(n,e.setting,e.zTreeNodes),n.show()})}else n.show()}function u(){s.saveModelInfo(p.model,p.property).then(function(e){if(e){var t=p.property,n={};n.db_name=p.model.mdName,n.db_type=t.dbType,n.db_ip=t.ipAddress,n.db_port=t.port,n.db_user=t.uName,n.db_password=t.uPwd,n.db_id=t.serviceName,n.as_source_db="yes",o.$emit("createModel",n)}})}var p=this,d=e;p.number=0,p.data={cb:"all",scripts:"",testing:!1,dbTestInfo:a("translate")("Db_cszsqy"),gd:{status:"",message:""},dbv:{status:"",message:""},auth:{status:"",message:""},dbms:{status:"",message:""},bcrz:{status:"",message:""}},p.params={},p.property={bh:"no",port:1521,dbType:"oracle"},p.model={modelCk:"",isModel:"no",mdName:"",modelList:[]},p.allowDbs=["oracle","db2","sqlserver","gbase-8a","mysql","informix","sybase","altibase","postgresql","oscar","dameng","kingbase","vertica","dbone","kdb"],p.real={comId:""},p.isSaving=!1;var m=a("translate")("SAVE"),_=a("translate")("SAVING");p.saveBtnTxt=m,p.$onInit=function(){null===p.dl?t.go("/"):(p.dl&&"init"!==p.dl&&(p.property=p.dl,p.property.bh||(p.property.bh="no"),p.real.comId=d.cid),p.getDbModels())},p.getDbModels=function(){s.getModelList().then(function(e){p.model.modelList=e})};var f={dbTreeObj:null,zTreeNodes:[],setting:{isSimpleData:!1,showLine:!0,check:{enable:!0},callback:{onClick:function(){}}}};p.modelIsCheck=function(){"no"===p.model.isModel&&(p.model.mdName="")},p.saveDbInfo=function(){var e=p.property.dbName;if("unnamed"===e)return void n.error(a("translate")("Db_mcbnk"));var o=this.property.dbType,i=p.model.modelList,c=!1;if("yes"===p.model.isModel&&!p.model.mdName)return void n.error(a("translate")("Db_tip23"));if("yes"===p.model.isModel&&p.model.mdName&&angular.forEach(i,function(e){e.db_name===p.model.mdName&&(c=!0)}),c&&"yes"===p.model.isModel)return void n.error(a("translate")("Db_mbmccf"));p.isSaving=!0,p.saveBtnTxt=_;var l=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),f=function(e,t){e?(l.setType("type-success"),l.getModalBody().html("保存成功！"),setTimeout(function(){l.close()},300)):(l.setType("type-danger"),t?l.getModalBody().html(t):l.getModalBody().html("保存失败！")),l.setClosable(!0)};l.open(),s.saveDbInfo(d,o,p.property).then(function(n){if(n.res){p.real.comId=n.comId;var a=$("#"+d.id);a.attr("realid",p.real.comId),a.attr("type",o),a.find(".dragPoint").text(e),a.attr("name",e),a.attr("title",o),r.save_graphics_no_alert(d.gn).finally(function(){f(!0)}),"yes"===p.model.isModel&&p.model.mdName&&u(),t.go("/")}else f(!1,n.msg)}).catch(function(){f(!1)}).finally(function(){p.isSaving=!1,p.saveBtnTxt=m})},p.isTesting=!1,p.testDbInfo=function(){var e=p.property;if(!(e.dbType&&e.serviceName&&e.ipAddress&&e.port&&e.uName&&e.uPwd))return void n.error(a("translate")("Db_pzxx"));p.isTesting=!0,p.data.testing=!1,p.data.dbTestInfo=a("translate")("Db_zzcs"),s.testDbConnection(e).then(function(t){t?i(e).finally(function(){p.isTesting=!1}):(p.isTesting=!1,p.data.dbTestInfo='<p class="db-test-danger">'+a("translate")("Db_cssb")+"</p>")},function(){p.isTesting=!1,p.data.dbTestInfo='<p class="db-test-danger">'+a("translate")("Db_cssb")+"</p>"})},p.createScript=function(){c(f.dbTreeObj)},p.changeBc=function(){l(f)},p.changeMb=function(){var e=p.model.modelCk;e&&e.db_name?angular.forEach(p.model.modelList,function(t){t.db_name===e.db_name&&(p.property.dbType=t.db_type,p.property.ipAddress=t.db_ip,p.property.port=t.db_port,p.property.uName=t.db_user,p.property.uPwd=t.db_password,p.property.serviceName=t.db_id)}):(p.property.ipAddress="",p.property.port="1521",p.property.uName="",p.property.uPwd="",p.property.serviceName="",p.property.bh="no")},p.changeDbType=function(){var e=p.property.dbType;switch("sqlserver"!==e&&(p.sqlEnv.isSqlSer=!1),"oracle"!==e&&(p.sqlEnv.isOracle=!1),e){case"oracle":p.property.port="1521";break;case"sqlserver":p.property.port="1433";break;case"db2":p.property.port="60000";break;case"gbase-8a":p.property.port="5258";break;case"mysql":p.property.port="3306";break;case"informix":case"sybase":p.property.port="1000";break;case"altibase":p.property.port="20300";break;case"postgresql":p.property.port="5432";break;case"oscar":p.property.port="1000";break;case"dameng":p.property.port="5236";break;case"kingbase":p.property.port="1000";break;case"vertica":p.property.port="5433";break;case"dbone":p.property.port="9001";break;case"kdb":p.property.port="1000";break;default:p.property.port="1521"}},p.sqlEnv={logHf:{status:"简单",isDone:!1},bgbh:{status:"未启用",isDone:!1},bypz:{status:"未完成",isDone:!1},reset:!0,isSqlSer:!1,isOracle:!1};var g=null;p.toSqlEfg=function(){"oracle"===p.property.dbType?p.sqlEnv.isOracle=!p.sqlEnv.isOracle:"sqlserver"===p.property.dbType&&(p.sqlEnv.isSqlSer=!p.sqlEnv.isSqlSer,p.sqlEnv.isSqlSer&&p.sqlEnvCfg())},p.sqlEnvCfg=function(){s.sqlCfgEnv(d,p.property).then(function(e){if(e.res){var t=e.data;"yes"===t.recover_status?(p.sqlEnv.logHf.status="完整",p.sqlEnv.logHf.isDone=!0):(p.sqlEnv.logHf.status="简单",p.sqlEnv.logHf.isDone=!1),"yes"===t.cdc_status?(p.sqlEnv.bgbh.status="已启用",p.sqlEnv.bgbh.isDone=!0):(p.sqlEnv.bgbh.status="未启用",p.sqlEnv.bgbh.isDone=!1),"yes"===t.r7_status?(p.sqlEnv.bypz.status="已完成",p.sqlEnv.bypz.isDone=!0):(p.sqlEnv.bypz.status="未完成",p.sqlEnv.bypz.isDone=!1),p.sqlEnv.reset="no"===t.rollback,g=t.r7}})},p.start_sql_log=function(){p.sqlEnv.logHf.status="操作中...",s.startRecoverMode(d,p.property).then(function(e){e?(p.sqlEnv.logHf.status="已启用",p.sqlEnv.logHf.isDone=!0):p.sqlEnv.logHf.status="操作失败"},function(){p.sqlEnv.logHf.status="操作失败"})},p.start_sql_cdc=function(){p.sqlEnv.bgbh.status="操作中...",s.startCdc(d,p.property).then(function(e){e?(p.sqlEnv.bgbh.status="完整",p.sqlEnv.bgbh.isDone=!0):p.sqlEnv.bgbh.status="操作失败"},function(){p.sqlEnv.bgbh.status="操作失败"})},p.start_sql_r7=function(){var e=g||{r7_table:"",r7_pro:"",r7_tri:"",r7_ms_tri:"",r7_cap:"",r7_clean:""};p.sqlEnv.bypz.status="操作中...",s.addR7Cdc(d,p.property,e).then(function(e){e?(p.sqlEnv.bypz.status="已完成",p.sqlEnv.bypz.isDone=!0):p.sqlEnv.bypz.status="操作失败"},function(){p.sqlEnv.bypz.status="操作失败"})},p.resetSqlCfg=function(){BootstrapDialog.confirm({title:"Dip 提示",message:"确认要重置sqlServer必要环境吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(e){e&&s.sqlCfgRollback(p.property).then(function(e){e&&p.sqlEnvCfg()})}})}}]}).component("dbModel",{templateUrl:"database_view/dbModel.component.html",controller:["$stateParams","tipsService","$filter","$state","dbService","$rootScope",function(e,t,n,r,a,o){var s=this;s.menu={dialog:!0,mc:1},s.property={},s.$onInit=function(){var t=e.model;t?s.property=t:r.go("/")},s.redirectTo=function(e){r.go(e)},s.deleteModelDb=function(){var e=function(){a.deleteDbModel(s.property.db_name).then(function(e){e&&(o.$emit("deleteModel",{}),t.success(n("translate")("Bccg")),r.go("/"))})};BootstrapDialog.confirm({title:n("translate")("TIP"),message:n("translate")("Db_qrscmb"),type:BootstrapDialog.TYPE_WARNING,closable:!1,btnCancelLabel:n("translate")("CANCEL"),btnOKLabel:n("translate")("OK"),btnOKClass:"btn-warning",callback:function(t){t&&e()}})}}]})}(),function(){angular.module("myApp.console_view",["luegg.directives","myApp.consoleService","myApp.consoleComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){t.state("/.capture_con_view",{url:"/capture?gn&cn&pt&id",views:{master:{component:"captureConsole"}},resolve:{trans:["$translate",function(e){return e(["Co_cpzqtj","Co_tj"])}]}}).state("/.queue_con_view",{url:"/queue?gn&cn&pt&pn&id&tab",views:{master:{component:"queueConsole",bindings:{dl:"infoData"}}},resolve:{infoData:["$transition$","csService",function(e,t){var n=e.params(),r=["tab1","tab2","tab3"],a="tab1";return $.inArray(n.tab,r)&&(a=n.tab),n.gn&&n.cn?"tab1"===a?t.getQueueStatus(n):"tab2"===a?t.initQueueUserTree(n):t.getQueueDisplayList(n,0,"","",""):{tab:"tab2"}}]}}).state("/.loader_con_view",{url:"/loader?gn&cn&pt&id&tab",views:{master:{component:"loaderConsole"}},resolve:{trans:["$translate",function(e){return e(["Co_ldzztj","Co_tj"])}]}})}])}(),function(){function e(e,t,n,r,a){this.getCaptureStatus=function(t){var n="<dip_command><command>query_capture_status</command><command_data><group>"+t.gn+"</group><component_name>"+t.cn+"</component_name></command_data></dip_command>",r={res:!1,data:null};return e.postDataList("/dipserver/query_capture_status",{xmlDoc:n}).then(function(e){if("ERROR"===e.command_return){var t=e.error_message||e.return_data&&e.return_data.error_message;r.res=!1,r.data=t}else r.res=!0,r.data=e.return_data;return r},function(){})},this.getConsoleErrorDetail=function(n,a){var o="<dip_command><command>query_error_detail</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><type>"+a.type+"</type><thread>"+a.thread+"</thread><pid>"+a.pid+"</pid><offset>"+a.off_set+"</offset></command_data></dip_command>",s={status:1,msg:"",data:null};return e.postDataList("/dipserver/query_error_detail",{xmlDoc:o}).then(function(e){if("ERROR"===e.command_return){var t=e.error_message||e.return_data&&e.return_data.error_message;s.status=1,s.msg=t}else{var n=e.return_data,r=[];if(n){if(n.errors&&(angular.isArray(n.errors.error)?r=n.errors.error:angular.isObject(n.errors.error)&&r.push(n.errors.error)),s.data={errors:r,logs:"",fileName:"",off_set:""},n.log){var a=n.log;s.data.logs=a.latest_log,s.data.fileName=a.filename,s.data.off_set=a.offset}s.status=3}else s.status=2}return s},function(){t.error(r("translate")("Wlcw"))})},this.getQueueStatus=function(n){var a="<dip_command><command>query_queue_info</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",o={res:!1,data:null,tab:"tab1"};return e.postDataList("/dipserver/query_queue_info_status",{xmlDoc:a}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else o.res=!0,o.data=e.return_data;return o},function(){t.error(r("translate")("Co_tip10"))})},this.getQueueDisplayList=function(n,a,o,s,i){var c={res:!1,list:[],total:1,tab:"tab3"},l="<dip_command><command>query_queue_pkg</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><page_num>"+a+"</page_num><start_time>"+o+"</start_time><end_time>"+s+"</end_time><xid>"+i+"</xid></command_data></dip_command>";return e.postDataList("/dipserver/query_queue_pkg",{xmlDoc:l}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else c.res=!0,e.return_data&&(e.return_data.list&&(angular.isArray(e.return_data.list)?c.list=e.return_data.list:c.list.push(e.return_data.list)),c.total=parseInt(e.return_data.page_num)?parseInt(e.return_data.page_num):1);return c},function(){t.error(r("translate")("Co_tip11"))})},this.getSqlInfoByXid=function(n,a,o,s){var i=null,c="<dip_command><command>query_queue_sql</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><rec_oft>"+a+"</rec_oft><qno>"+o+"</qno><oft>"+s+"</oft></command_data></dip_command>";return e.postDataList("/dipserver/query_queue_sql",{xmlDoc:c}).then(function(e){if("ERROR"===e.command_return){var n=e.error_message||e.return_data.error_message;t.error(n)}else i=e.return_data;return i},function(e){t.error(r("translate")("Co_tip12"))})},this.initQueueUserTree=function(a){var o={group:a.gn,db_component_name:a.pn,db_type:a.pt},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_etl_user",o).then(function(e){if(n.equalMd5Data(e)&&e.status){var t=e.response;t&&angular.isArray(t.user)&&angular.forEach(t.user,function(e,t){var n={id:t,name:e,pt:a.pt,pn:a.pn,open:!1,isParent:!0,children:[]};s.push(n)})}return{data:s,tab:"tab2"}},function(){t.error(r("translate")("Wlcw"))})},this.getQueueDetailList=function(n,a,o,s,i,c,l){var u={res:!1,list:[],total:1},p="<dip_command><command>query_queue_rec</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><page_num>"+a+"</page_num><xid>"+o+"</xid><opc>"+s+"</opc><owner>"+i+"</owner><table>"+c+"</table><scn>"+l+"</scn></command_data></dip_command>";return e.postDataList("/dipserver/query_queue_rec",{xmlDoc:p}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else u.res=!0,e.return_data&&(e.return_data.list&&(angular.isArray(e.return_data.list)?u.list=e.return_data.list:u.list.push(e.return_data.list)),u.total=parseInt(e.return_data.page_num)?parseInt(e.return_data.page_num):1);return u},function(){t.error(r("translate")("Co_hqdlsb"))})},this.deleteQueuePkgXid=function(n,a){var o=!1,s="<dip_command><command>delete_queue_pkg_xid</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name>"+a+"</command_data></dip_command>";return e.postDataList("/dipserver/delete_queue_pkg_xid",{xmlDoc:s}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else o=!0;return o},function(){t.error(r("translate")("Co_qcsb"))})},this.queryQueueTj=function(t,n,r,a,o,s,i,c,l,u,p,d,m){var _="<dip_command><command>query_queue_statis</command><command_data><group>"+t.gn+"</group><component_name>"+t.cn+"</component_name><full>"+n+"</full><owner>"+r+"</owner><table>"+a+"</table><start_time>"+o+"</start_time><end_time>"+s+"</end_time><minute>"+i+"</minute><hour>"+c+"</hour><day>"+l+"</day><month>"+u+"</month><year>"+p+"</year><object_type>"+d+"</object_type><sql_type>"+m+"</sql_type><interval>1</interval></command_data></dip_command>";return e.postDataList("/dipserver/query_queue_statis",{xmlDoc:_})},this.queryApplyFullErrors=function(n,a,o,s,i,c,l,u){var p="<dip_command><command>query_apply_full_error</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><owner>"+a+"</owner><object>"+o+"</object><action>"+s+"</action><page_num>"+i+"</page_num><mark_flag>"+c+"</mark_flag><start_time>"+l+"</start_time><end_time>"+u+"</end_time></command_data></dip_command>",d={res:!1,list:[],total:0};return e.postDataList("/dipserver/query_apply_full_error",{xmlDoc:p}).then(function(e){if("ERROR"===e.command_return);else{var t=e.return_data;if(t){var n=[];angular.isArray(t.history)?n=t.history:n.push(t.history),angular.forEach(n,function(e){e.flag=!1}),d.res=!0,d.list=n,d.total=parseInt(t.all_num)?parseInt(t.all_num):1}}return d},function(){t.error(r("translate")("Wlcw"))})},this.exportExcelErrorFile=function(n){var o="<dip_command><command>download_error_file</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>";e.postDataList("/dipserver/download_error_file",{xmlDoc:o}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{var r=e.return_data;r&&"string"==typeof r.file_path&&a.open("/download/"+r.file_path)}},function(){t.error(r("translate")("Wlcw"))})},this.markedApplyError=function(n,a){var o="<dip_command><command>marked_apply_error</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name>"+a+"</command_data></dip_command>",s=!1;return e.postDataList("/dipserver/marked_apply_error",{xmlDoc:o}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else s=!0;return s},function(){t.error(r("translate")("Wlcw"))})},this.clearErrorLogs=function(n){var a="<dip_command><command>trunc_apply_error_record</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",o=!1;return e.postDataList("/dipserver/trunc_apply_error_record",{xmlDoc:a}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else o=!0;return o},function(){t.error(r("translate")("Wlcw"))})},this.getErrorStatList=function(n){var a="<dip_command><command>query_apply_error_statistics</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><offset>0</offset><clicktype>start</clicktype></command_data></dip_command>",o={res:!1,list:[]};return e.postDataList("/dipserver/query_apply_error_statistics",{xmlDoc:a}).then(function(e){if("SUCCESS"===e.command_return){var t=e.return_data,n=[];t&&t.record&&(angular.isArray(t.record)?n=t.record:angular.isObject(t.record)&&n.push(t.record),o.list=n),o.res=!0}return o},function(){t.error(r("translate")("Wlcw"))})},this.excludeSelectTable=function(n,a){var o="<dip_command><command>exclude_select_table</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name>"+a+"</command_data></dip_command>",s=!1;return e.postDataList("/dipserver/exclude_select_table",{xmlDoc:o}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else s=!0;return s},function(){t.error(r("translate")("Wlcw"))})},this.syncTablePart=function(n,a){var o="<dip_command><command>sync_table_part</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><record>"+a+"</record></command_data></dip_command>",s=!0;return e.postDataList("/dipserver/sync_table_part",{xmlDoc:o}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else s=!0;return s},function(){t.error(r("translate")("Wlcw"))})},this.handleError=function(n,a){var o="<dip_command><command>"+a+"</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",s="/dipserver/"+a,i={res:!1,msg:""};return e.postDataList(s,{xmlDoc:o},0).then(function(e){return"ERROR"===e.command_return?(i.res=!1,i.msg=e.return_data.error_message||e.return_data.error_msg):i.res=!0,i},function(){t.error(r("translate")("Wlcw"))})},this.getLoaderCurrentError=function(n){var a="<dip_command><command>query_apply_current_error</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",o={res:!1,data:null};return e.postDataList("/dipserver/query_apply_current_error",{xmlDoc:a}).then(function(e){return"ERROR"===e.command_return||(o.res=!0,o.data=e.return_data||{}),o},function(){t.error(r("translate")("Wlcw"))})},this.getLoaderStatus=function(n){var a="<dip_command><command>query_apply_status</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",o={res:!1,msg:"",data:null};return e.postDataList("/dipserver/query_capture_status",{xmlDoc:a}).then(function(e){return"ERROR"===e.command_return?(o.res=!1,o.msg=e.error_message||e.return_data&&e.return_data.error_message):(o.res=!0,o.data=e.return_data||{}),o},function(){t.error(r("translate")("Wlcw"))})},this.getLoaderPcbList=function(a,o){var s={group_id:a.gn,component_id:a.cn,page_num:o},i={list:[],total:1};return s=n.md5Data(s),e.postDataList("/dipserver/query_apply_exclude_table",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&angular.isArray(r.list)&&(angular.forEach(r.list,function(e){e.checked=!1,i.list.push(e)}),i.total=parseInt(r.total)?parseInt(r.total):1)}else t.error(e.response.error_msg);return i},function(){t.error(r("translate")("Wlcw"))})},this.deletePcbList=function(a,o){var s={group_id:a.gn,component_id:a.cn,object:o},i=!1;return s=n.md5Data(s),e.postDataList("/dipserver/delete_exclude_table",s).then(function(e){return n.equalMd5Data(e)&&e.status&&"SUCCESS"===e.response&&(i=!0),i},function(){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.consoleService",[]).service("csService",e),e.$inject=["httpService","tipsService","md5Service","$filter","$q","$window"]}(),function(){function e(e,t,n){var r,a={title:{text:t,y:10},tooltip:{trigger:"axis"},legend:{y:10,data:["Insert","Delete","Update","DDL"]},toolbox:{show:!1,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},dataZoom:{show:!1,start:0,end:100},xAxis:[{type:"category",boundaryGap:!0,data:function(){for(var e=new Date,t=[],n=10;n--;)t.unshift(e.toLocaleTimeString().replace(/^\D*/,"")),e=new Date(e-2e3);return t}()}],yAxis:[{type:"value",scale:!0,name:n}],series:[{name:"Insert",type:"bar",data:function(){for(var e=[],t=10;t--;)e.push(0);return e}()},{name:"Delete",type:"bar",data:function(){for(var e=[],t=10;t--;)e.push(0);return e}()},{name:"Update",type:"bar",data:function(){for(var e=[],t=10;t--;)e.push(0);return e}()},{name:"DDL",type:"bar",data:function(){for(var e=[],t=10;t--;)e.push(0);return e}()}]};require.config({paths:{echarts:"./lib"}});var o=e.defer();return require(["echarts","echarts/chart/bar","echarts/chart/line","echarts/theme/dark","echarts/zrender/tool/color"],function(e,t,n,s){var i=$(".main-console").find("div.tab-content"),c=0===i.height()?325:i.height()-58;$("#Capture_chart_id").css({width:i.width()-30+"px",height:c+"px",margin:"0 auto"}),r=e.init(document.getElementById("Capture_chart_id"),s),r.setOption(a),o.resolve({chart:r,option:a})}),o.promise}function t(e,t,r,a,o,s){s||(s=0),"1"!==t.data.freshWay||t.data.isFresh||n(e,t,r,a).then(function(e){1===e.status?s++:3===e.status&&(s=0)})}function n(e,t,n,r){return e.getConsoleErrorDetail(n,r).then(function(e){return e.data&&(t.data.errors=e.data.errors,t.data.logs+=e.data.logs,t.data.fileName=e.data.fileName,r.off_set=e.data.off_set),e})}angular.module("myApp.consoleComponent",[]).component("captureConsole",{templateUrl:"console_view/captureCon.component.html",bindings:{trans:"<"},controller:["$scope","$rootScope","$stateParams","tipsService","$interval","$filter","$q","csService",function(r,a,o,s,i,c,l,u){function p(){var e={status:1,msg:"",data:null};return u.getCaptureStatus(m).then(function(t){if(t.res){var n=t.data;if(n){d.data.start_scn=n.breakpoint.start_scn,d.data.complete_scn=n.breakpoint.complete_scn,d.data.complete_xid=n.breakpoint.complete_xid,d.data.servers=[];var r={};if(n.server_info&&(angular.isArray(n.server_info.server)?d.data.servers=n.server_info.server:angular.isObject(n.server_info.server)&&d.data.servers.push(n.server_info.server)),d.data.servers.length>0?(angular.forEach(d.data.servers,function(e){e.off_set?_&&(e.off_set=_.off_set):e.off_set=0}),_||(_=d.data.servers[0]),e.status=3,e.data=_,r=d.data.servers[0]):e.status=4,d.cons.chart&&r){var a=r,o=n.timestamp.split(" ")[1];d.cons.chart.addData([[0,a.op_insert,!1,!1,o],[1,a.op_delete,!1,!1],[2,a.op_update,!1,!1],[3,a.op_ddl,!1,!1]])}}else e.status=2}else e.status=1,e.msg=t.data;return e})}var d=this,m=o;d.cons={cons:!0,currentTab:"tab1",chart:null,option:null},d.data={start_scn:"",complete_scn:0,complete_xid:0,servers:[],offset:0,errors:[],logs:"",isFresh:!1,freshWay:"1"};var _,f,g,h=0;d.$onInit=function(){e(l,d.trans.Co_cpzqtj,d.trans.Co_tj).then(function(e){d.cons.chart=e.chart,d.cons.option=e.option,p().then(function(e){m&&(3===e.status?(_=e.data,d.data.currentId=_.pid,t(u,d,m,_,s,0),f=i(function(){p().then(function(e){1===e.status?++h<2&&s.error(e.msg):3===e.status&&(h=0,t(u,d,m,e.data,s,0))})},5e3)):1===e.status&&s.error(e.msg),r.$on("$destroy",function(){angular.isDefined(f)&&(i.cancel(f),f=void 0),g&&angular.isFunction(g)&&g()}))})})},d.getNewLog=function(){m&&_&&n(u,d,m,_)},
d.getDetail=function(e){_=e,d.data.currentId=e.pid},d.showTab=function(e){d.cons.currentTab="tab"+e},g=a.$on("consoleView",function(e,t){var n=$("#Capture_chart_id"),r=n.width();t?n.width(r-193):n.width(r+193),d.cons.chart&&d.cons.chart.resize()})}]}).component("queueConsole",{templateUrl:"console_view/queueCon.component.html",bindings:{dl:"<"},controller:["$scope","$rootScope","$stateParams","tipsService","$interval","$filter","$q","$timeout","csService",function(e,t,n,r,a,o,s,i,c){function l(e){var t=e.substring(0,10),n=e.substring(10,19),r=t.split("-"),a=n.split(":"),o=new Date;return o.setUTCFullYear(r[0],r[1]-1,r[2]),o.setUTCHours(a[0]-8,a[1],a[2],0),o}function u(e){var t=[[0],[31],[28],[31],[30],[31],[30],[31],[31],[30],[31],[30],[31]],n=e.getFullYear(),r=e.getDate(),a=e.getMonth()+1;n%4==0&&n%100!=0&&(t[2]=29),a-1==0?(n-=1,a=12):a-=1,r=t[a]>=r?r:t[a],a<10&&(a="0"+a),r<10&&(r="0"+r);var o=n+"-"+a+"-"+r+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return new Date(o)}function p(e){var t=e.getFullYear()-1,n=e.getDate(),r=e.getMonth()+1;r<10&&(r="0"+r),n<10&&(n="0"+n);var a=t+"-"+r+"-"+n+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return new Date(a)}function d(){var e=o("translate")("Co_dltj"),t={title:{text:e,y:10},tooltip:{trigger:"axis"},legend:{y:10,data:["Insert","Delete","Update","DDL","Total"]},toolbox:{show:!1,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},dataZoom:{show:!1,start:0,end:100},xAxis:[{type:"category",boundaryGap:!0,axisLabel:{show:!0,rotate:45,formatter:"{value}"},data:function(){for(var e=new Date,t=[],n=10;n--;)t.unshift(e.toLocaleTimeString().replace(/^\D*/,"")),e=new Date(e-2e3);return t}()}],yAxis:[{type:"value",scale:!0,name:o("translate")("Co_tj")}],series:[{name:"Insert",type:"bar",data:[]},{name:"Delete",type:"bar",data:[]},{name:"Update",type:"bar",data:[]},{name:"DDL",type:"bar",data:[]},{name:"Total",type:"bar",data:[]}],noDataLoadingOption:{text:"No Data!",effect:"bubble",effectOption:{backgroundColor:"#1A1A1D",effect:{n:0}},textStyle:{fontWeight:"bold"}}},n={title:{text:o("translate")("Co_dltjbt"),x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:["INSERT","DELETE","UPDATE","DDL"]},toolbox:{show:!1,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["pie","funnel"],option:{funnel:{x:"25%",width:"50%",funnelAlign:"left",max:1548}}},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,series:[{name:o("translate")("Co_dltjsj"),type:"pie",radius:"55%",center:["50%","60%"],data:[{value:0,name:"INSERT"},{value:0,name:"UPDATE"},{value:0,name:"DELETE"},{value:0,name:"DDL"}]}],noDataLoadingOption:{text:"No Data!",effect:"bubble",effectOption:{backgroundColor:"#1A1A1D",effect:{n:0}},textStyle:{fontWeight:"bold"}}};require.config({paths:{echarts:"./lib"}});var r=s.defer();return require(["echarts","echarts/chart/bar","echarts/chart/line","echarts/chart/pie","echarts/theme/dark","echarts/zrender/tool/color"],function(e,a,o,s,i){var c=e.init(document.getElementById("queue_bj_chart"),i);c.setOption(t),r.resolve({chart:c,option1:t,option2:n})}),r.promise}var m=this;m.info={},m.fileList=[],m.swList=[],m.ptotal=1,m.pnum=1,m.clist=[],m.ctotal=1,m.cnum=1,m.detailTitle="",m.detailXid=0,m.mck=!1,m.fy={snum:"",csnum:""},m.pz={mainL:!0,detailL:!1,detail:!1,mainLoading:!1,detailLoading:!1},m.mainParam={startTime:"",endTime:"",swNumber:""},m.detailParam={userName:"",tabName:"",option:"",scnNumber:""},m.detail={sql:"",hg:""};var _=n;m.cons={cons:!0,currentTab:"tab1",chart:null,option:null};var f,g,h={option1:{},option2:{}},v=!0,b="";m.tj={c_type:"bar",begin_time:"",end_time:"",isTop:!1},m.user_t="U",m.ut="DML",m.nowType="yy",m.datalist=[],m.pielist=[],m.owner=f,m.table=g,m.chart=null,m.nowType_repeat="yy",m.a_show=!0,m.b_show=!1,m.c_show=!1,m.$onInit=function(){if(m.dl){if(m.dl&&!m.dl.data)return;if("tab1"===m.dl.tab){var e=m.dl.data;m.info=e.queue_info,m.fileList=[],e&&e.queue_file_list&&(angular.isArray(e.queue_file_list.queue_file)?m.fileList=e.queue_file_list.queue_file:angular.isObject(e.queue_file_list.queue_file)&&m.fileList.push(e.queue_file_list.queue_file)),m.cons.currentTab="tab1"}else if("tab3"===m.dl.tab)m.dl.res&&(m.swList=m.dl.list,m.ptotal=m.dl.total),m.cons.currentTab="tab3",i(function(){var e=$("#dl-dark-sh-start"),t=$("#dl-dark-sh-end");e.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",onShow:function(){this.setOptions({maxDate:t.val()?t.val():o("date")(new Date,"yyyy-MM-dd HH:mm:ss")})}}),t.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",minDate:new Date,onShow:function(){this.setOptions({minDate:!!e.val()&&e.val()})}})});else if("tab2"===m.dl.tab){m.cons.currentTab="tab2";var t={view:{selectedMulti:!1},async:{enable:!0,url:"/dipserver/query_etl_table",autoParam:["name=user"],otherParam:{group:_.gn,db_type:_.pt,db_component_name:_.pn},type:"get",contentType:"application/json",dataFilter:function(e,t,n){var r=[];return n&&n.status&&n.response&&angular.isArray(n.response.tables)&&angular.forEach(n.response.tables,function(e,t){r.push({id:t,name:e})}),r}},callback:{onMouseUp:function(e,t,n){if(n&&!n.isParent){var r=n.getParentNode();f=r.name,g=n.name,v=!1,m.selectUserData()}},beforeClick:function(e,t){if(t&&t.isParent)return m.now_user=t.name,m.now_tab="",v=!1,1!==t.id},beforeAsync:function(e,t){return t&&(b=t.name),1!==t.id}}};d().then(function(e){m.chart=e.chart,h.option1=e.option1,h.option2=e.option2,$.fn.zTree.init($("#queue_tj_tree"),t,m.dl.data),m.selectAllData()}),i(function(){var e=$("#dl-dark-start"),t=$("#dl-dark-end");e.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",onShow:function(){this.setOptions({maxDate:t.val()?t.val():o("date")(new Date,"yyyy-MM-dd HH:mm:ss")})}}),t.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",minDate:new Date,onShow:function(){this.setOptions({minDate:!!e.val()&&e.val()})}})})}}else $state.go("/")};var y=function(e){if(m.mainParam.startTime&&!angular.isDate(new Date(m.mainParam.startTime)))return void r.warning("开始时间格式不正确，请重新输入！");if(m.mainParam.endTime&&!angular.isDate(new Date(m.mainParam.endTime)))return void r.warning("结束时间格式不正确，请重新输入！");var t=m.mainParam.startTime?m.mainParam.startTime:"",n=m.mainParam.endTime?m.mainParam.endTime:"",a=m.mainParam.swNumber?m.mainParam.swNumber:"";c.getQueueDisplayList(_,e,t,n,a).then(function(e){e.res?(m.swList=e.list,m.ptotal=e.total,m.pnum>=m.ptotal&&(m.pnum=m.ptotal)):(m.swList=[],m.ptotal=1,m.pnum=1)})},w=function(e,t){m.clist=[];var n=m.detailParam.userName?m.detailParam.userName:"",r=m.detailParam.tabName?m.detailParam.tabName:"",a=m.detailParam.option?m.detailParam.option:"",o=m.detailParam.scnNumber?m.detailParam.scnNumber:"";c.getQueueDetailList(_,e,t,a,n,r,o).then(function(e){e.res?(m.clist=e.list,m.ctotal=e.total,m.cnum>=m.ctotal&&(m.cnum=m.ctotal)):(m.clist=[],m.ctotal=1,m.cnum=1)})};m.pagePre=function(){1===m.ptotal?m.pnum=1:m.pnum-1>0&&(m.pnum=m.pnum-1),y(m.pnum)},m.pageNext=function(){1===m.ptotal&&(m.pnum=1),m.ptotal===m.pnum?m.pnum=m.ptotal:m.pnum+1<=m.ptotal&&(m.pnum=m.pnum+1),y(m.pnum)},m.tiao=function(){""!==m.fy.snum&&(m.pnum=parseInt(m.fy.snum)||m.pnum,m.fy.snum="",y(m.pnum))},m.clearSelected=function(){m.mck=!1;var e="",t=$(".mainCbList:checked");if(angular.forEach(t,function(t){e+="<xid>"+t.value+"</xid>"}),""===e)return void r.warning("请勾选您要清除的队列信息！");$("input.mainCbList").prop("checked",!1),c.deleteQueuePkgXid(_,e).then(function(e){e&&(m.pnum=1,y(0),r.success(o("translate")("Co_qccg")))})},m.selectedAll=function(){m.mck?$("input.mainCbList").prop("checked",!0):$("input.mainCbList").prop("checked",!1)},m.searchListByParams=function(){m.pnum=1,y(0)},m.resetParams=function(){m.pnum=1,m.mainParam.startTime="",m.mainParam.endTime="",m.mainParam.swNumber="",y(0)},m.getDetail=function(e){m.detailTitle=o("translate")("Co_swxxlb"),m.pz.mainL=!1,m.pz.detailL=!0,m.pz.detail=!1,m.detailXid=e.xid,w(0,e.xid)},m.backDetail=function(e){},m.backToMain=function(){m.detailTitle="",m.pz.mainL=!0,m.pz.detailL=!1,m.pz.detail=!1,m.detailParam.option=""},m.showSql=function(e){var t=e.rec_oft,n=e.qno,r=e.oft;c.getSqlInfoByXid(_,t,n,r).then(function(e){e&&(m.detail.sql=e.sql,m.detail.hg=e.rollback_sql,m.pz.detail=!0)})},m.closeSqlPanel=function(){m.pz.detail=!1},m.searchDetailList=function(){m.cnum=1,w(0,m.detailXid)},m.resetDetailList=function(){m.cnum=1,m.detailParam.userName="",m.detailParam.tabName="",m.detailParam.option="",m.detailParam.scnNumber="",w(0,m.detailXid)},m.cpagePre=function(){1===m.ctotal?m.cnum=1:m.cnum-1>0&&(m.cnum=m.cnum-1),w(m.cnum,m.detailXid)},m.cpageNext=function(){1===m.ctotal&&(m.cnum=1),m.ctotal===m.cnum?m.cnum=m.ctotal:m.cnum+1<=m.ctotal&&(m.cnum=m.cnum+1),w(m.cnum,m.detailXid)},m.ctiao=function(){""!==m.fy.csnum&&(m.cnum=parseInt(m.fy.csnum)||m.cnum,m.fy.csnum="",w(m.cnum,m.detailXid))};var x=function(e){var t;t="pie"===m.tj.c_type?h.option2:h.option1;for(var n=[],r=[],a=[],o=[],s=[],i=0;i<e.length;i++)n.push(parseInt(e[i].insert)),r.push(parseInt(e[i].update)),a.push(parseInt(e[i].del)),o.push(parseInt(e[i].ddl)),s.push(parseInt(e[i].total));for(var c=[n,r,a,o,s],l=0;l<t.series.length;l++)t.series[l].data=c[l]},I=function(e,t){var n;if("pie"!==m.tj.c_type){n=h.option1,e=e.getFullYear();for(var r=[],a=0;a<=t;a++)r.push(e),e++;n.xAxis&&(n.xAxis[0].data.length=0,n.xAxis[0].data=r,n.xAxis[0].axisLabel.formatter="{value}"),m.chart.setOption(n,!0),m.chart.hideLoading()}},k=function(e,t){var n;if("pie"!==m.tj.c_type){n=h.option1;for(var r=e.getMonth()+1,a=e.getFullYear(),o=[],s=0;s<=t;s++)r>12&&(r=1,a++),o.push(a+"."+r),r++;n.xAxis&&(n.xAxis[0].data.length=0,n.xAxis[0].data=o,n.xAxis[0].axisLabel.formatter="{value}M"),m.chart.setOption(n,!0),m.chart.hideLoading()}},D=function(e,t,n){var r;if("pie"!==m.tj.c_type){r=h.option1;for(var a=e.getMonth()+1,o=e.getDate(),s=[],i=0;i<=n;i++)o>t&&(o=1,a++),s.push(a+"."+o),o++;r.xAxis&&(r.xAxis[0].data=s,r.xAxis[0].axisLabel.formatter="{value}D"),m.chart.setOption(r,!0),m.chart.hideLoading()}},E=function(e,t){var n;if("pie"!==m.tj.c_type){n=h.option1;for(var r=e.getHours(),a=[],o=0;o<t;o++)r>23&&(r=0),a.push(r),r++;n.xAxis&&(n.xAxis[0].data.length=0,n.xAxis[0].data=a,n.xAxis[0].axisLabel.formatter="{value}H"),m.chart.setOption(n,!0),m.chart.hideLoading()}},S=function(e,t){var n;if("pie"!==m.tj.c_type){n=h.option1;for(var r=e.getMinutes(),a=[],o=0;o<t;o++)r>60&&(r=1),a.push(r),r++;n.xAxis&&(n.xAxis[0].data.length=0,n.xAxis[0].data=a,n.xAxis[0].axisLabel.formatter="{value}m"),m.chart.setOption(n,!0),m.chart.hideLoading()}},T=function(e){var t=h.option2,n=e[0],r=[];for(var a in n){var o={};o.name=a.toUpperCase();var s=n[a].replace(/%/,"");s=parseFloat(s),o.value=s,r.push(o)}t.series[0].data=r};Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e};var C=function(e,t,n,r,a,o,s){r.setSeconds(0),v?(e="yes",t="",n=""):e="no";var i=r.Format("yyyy-MM-dd hh:mm:ss"),l=a.Format("yyyy-MM-dd hh:mm:ss"),u="mm"===m.nowType?"yes":"no",p="hh"===m.nowType?"yes":"no",d="dd"===m.nowType?"yes":"no",f="mo"===m.nowType?"yes":"no",g="yy"===m.nowType?"yes":"no";return c.queryQueueTj(_,e,t,n,i,l,u,p,d,f,g,o,s)},L=function(e){var t=[];return angular.isArray(e)?t=e:angular.isObject(e)&&t.push(e),t},q=function(e){var t=e.return_data;if(t&&!angular.isString(t)&&!$.isEmptyObject(t)){m.datalist=[],m.pielist=[],m.user_x=[],m.user_y=[],m.table_x=[],m.table_y=[];var n=L(t.list),r=L(t.persent),a=[];angular.forEach(n,function(e){var t={};t.time=e.time,t.insert=parseInt(e.inst),t.update=parseInt(e.del),t.del=parseInt(e.upd),t.ddl=parseInt(e.ddl),t.total=parseInt(e.full),a.push(t)});var o=[];angular.forEach(r,function(e){var t={};t.insert=e.inst,t.update=e.upd,t.del=e.del,t.ddl=e.ddl,o.push(t)}),m.datalist=a,m.pielist=o}};m.changeTj=function(){var e=h.option1,t=this.tj.c_type;"line"===t?angular.forEach(e.series,function(e){e.type="line"}):"bar"===t?angular.forEach(e.series,function(e){e.type="bar"}):"pie"===t&&(e=h.option2,angular.forEach(e.series,function(e){e.type="pie"})),m.nowType=m.nowType_repeat,m.chart.setOption(e,!0)},m.selectUserData=function(){var e=m.tj.start_time,t=m.tj.end_time;if(m.owner=f,m.table=g,"top"===m.nowType){if(e=$("#startTime").val(),t=$("#endTime").val(),""!==m.tj.start_time&&""!==m.tj.end_time){if((angular.isDate(new Date(m.tj.end_time))?new Date(m.tj.end_time):l(m.tj.end_time))<(angular.isDate(new Date(m.tj.start_time))?new Date(m.tj.start_time):l(m.tj.start_time)))return}var n=$("#user_table").val(),a=$("#operation").val();t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e.setFullYear(e.getFullYear()-10),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")),C("no",f,g,e,t,n,a).then(function(e){q(e),"U"===n?(updateuser(m.user_y),updateuserx(m.user_x,m.user_num)):"T"===n&&(updateuser(m.table_y),updateuserx(m.table_x,m.table_num))})}if("yy"===m.nowType){m.nowType_repeat="yy",t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e.setFullYear(e.getFullYear()-10),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss"));var s=C("no",f,g,e,t,"","");s.then(function(n){q(n);for(var r=m.datalist,a=[],o=e.getFullYear(),s=e.getMonth(),i=t.getFullYear()-e.getFullYear(),c=0;c<=i;c++){var u=0,p={};angular.forEach(r,function(e){var t=angular.isDate(new Date(e.time))?new Date(e.time):l(e.time);o===t.getFullYear()&&(p.time=e.time,p.insert=e.insert,p.update=e.update,p.del=e.del,p.ddl=e.ddl,p.total=e.total,u=1)}),0===u&&(p.time=o+"-"+s,p.insert=0,p.update=0,p.del=0,p.ddl=0,p.total=0),a.push(p),o++}x(a),T(m.pielist),I(e,i)},function(e){r.error(o("translate")("Wlcw"))})}if("mo"===m.nowType){m.nowType_repeat="mo",t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e=p(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss"));var i,s=C("no",f,g,e,t,"","");s.then(function(n){q(n);var a=m.datalist,s=[],c=e.getFullYear(),u=e.getMonth(),p=t.getFullYear()-e.getFullYear(),d=null;0===p?(i=e.getMonth(),d=t.getMonth()-i):1===p?(i=12-e.getMonth(),d=i+t.getMonth()):(r.error(o("translate")("Co_bcgln")),d=24);for(var _=0;_<=d;_++){var f=0,g={};u>12&&(u=1,c++),angular.forEach(a,function(e){var t=angular.isDate(new Date(e.time))?new Date(e.time):l(e.time);t.getMonth()===u&&c===t.getFullYear()&&(g.time=e.time,g.insert=e.insert,g.update=e.update,g.del=e.del,g.ddl=e.ddl,g.total=e.total,f=1)}),0===f&&(g.time=e.getFullYear()+"-"+u,g.insert=0,g.update=0,g.del=0,g.ddl=0,g.total=0),s.push(g),u++}x(s),T(m.pielist),k(e,d)},function(e){r.error(o("translate")("Wlcw"))})}if("dd"===m.nowType){m.nowType_repeat="dd",t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e=u(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss"));var s=C("no",f,g,e,t,"","");s.then(function(n){q(n);var a=m.datalist,s=[],i=e.getMonth()+1,c=new Date(e.getFullYear(),i,0).getDate(),u=e.getDate(),p=null,d=(t.getTime()-e.getTime())/864e5;d<=31?p=d:(r.error(o("translate")("Co_bcg31")),p=31);for(var _=0;_<p;_++){var f=0,g={};u>c&&(u=c),g.time=u,angular.forEach(a,function(e){(angular.isDate(new Date(e.time))?new Date(e.time).getDate():l(e.time).getDate())===u&&(g.time=e.time,g.insert=e.insert,g.update=e.update,g.del=e.del,g.ddl=e.ddl,g.total=e.total,f=1)}),0===f&&(g.insert=0,g.update=0,g.del=0,g.ddl=0,g.total=0),s.push(g),u++}x(s),T(m.pielist),D(e,c,p)},function(){r.error(o("translate")("Wlcw"))})}if("hh"===m.nowType){m.nowType_repeat="hh",t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e=angular.isDate(new Date(e.getTime()-864e5))?new Date(e.getTime()-864e5):l(e.getTime()-864e5));var s=C("no",f,g,e,t,"","");s.then(function(n){q(n);var a=m.datalist,s=[],i=(e.getFullYear(),e.getDate()),c=e.getHours(),u=null,p=(t.getTime()-e.getTime())/36e5;p<=24?u=p:(r.error(o("translate")("Co_bcg24")),u=24);for(var d=0;d<u;d++){var _=0,f={};c>23&&(c=1,i=t.getDate()),f.time=c,angular.forEach(a,function(e){var t=angular.isDate(new Date(e.time+":00:00"))?new Date(e.time+":00:00"):l(e.time+":00:00");t.getDate()===i&&t.getHours()===c&&(f.time=e.time,f.insert=e.insert,f.update=e.update,f.del=e.del,f.ddl=e.ddl,f.total=e.total,_=1)}),0===_&&(f.insert=0,f.update=0,f.del=0,f.ddl=0,f.total=0),s.push(f),c++}x(s),T(m.pielist),E(e,u)},function(){r.error(o("translate")("Wlcw"))})}if("mm"===m.nowType){m.nowType_repeat="mm",t?(t=angular.isDate(new Date(t))?new Date(t):l(t),m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")):(t=new Date,m.tj.end_time=t.Format("yyyy-MM-dd hh:mm:ss")),e?(e=angular.isDate(new Date(e))?new Date(e):l(e),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss")):(e=new Date,e=angular.isDate(new Date(e.getTime()-36e5))?new Date(e.getTime()-36e5):l(e.getTime()-36e5),m.tj.start_time=e.Format("yyyy-MM-dd hh:mm:ss"));var s=C("no",f,g,e,t,"","");s.then(function(n){q(n);var a=m.datalist,s=[],i=(e.getFullYear(),e.getDate(),e.getHours()),c=e.getMinutes(),u=null,p=(t.getTime()-e.getTime())/6e4;p<=60?u=p:(r.error(o("translate")("Co_bcg60")),u=60);for(var d=0;d<u;d++){var _=0,f={};c>59&&(c=0,i=t.getHours()),f.time=c,angular.forEach(a,function(e){var t=angular.isDate(new Date(e.time+":00"))?new Date(e.time+":00"):l(e.time+":00");t.getHours()===i&&t.getMinutes()===c&&(f.time=e.time,f.insert=e.insert,f.update=e.update,f.del=e.del,f.ddl=e.ddl,f.total=e.total,_=1)}),0===_&&(f.insert=0,f.update=0,f.del=0,f.ddl=0,f.total=0),s.push(f),c++}x(s),T(m.pielist),S(e,u)},function(){r.error(o("translate")("Wlcw"))})}},m.selectAllData=function(){v=!0,m.selectUserData()},m.setType=function(e){var t,n,r,a,o,s=m.tj.end_time;if("yy"===e){s=new Date;var i=s.getFullYear()-10;m.tj.start_time=i+"-01-01 00:00:00",m.tj.end_time=s.Format("yyyy-MM-dd hh:mm:ss")}else if("mo"===e)t=(new Date).getFullYear(),m.tj.start_time=t+"-01-01 00:00:00",m.tj.end_time=t+"-12-31 23:59:59";else if("dd"===e){o=new Date,t=o.getFullYear(),n=o.getMonth()+1;var c=new Date(t,n,0);r=c.getDate(),m.tj.start_time=t+"-"+n+"-01 00:00:00",m.tj.end_time=t+"-"+n+"-"+r+" 23:59:59"}else"hh"===e?(o=new Date,t=o.getFullYear(),n=o.getMonth()+1,r=o.getDate(),m.tj.start_time=t+"-"+n+"-"+r+" 00:00:00",m.tj.end_time=t+"-"+n+"-"+r+" 23:59:59"):"mm"===e&&(o=new Date,t=o.getFullYear(),n=o.getMonth()+1,r=o.getDate(),a=o.getHours()+1,m.tj.start_time=t+"-"+n+"-"+r+" "+a+":00:00",m.tj.end_time=t+"-"+n+"-"+r+" "+a+":59:00");m.nowType=e,m.selectUserData()},m.showTab=function(e){m.cons.currentTab="tab"+e,1===e?(c.getQueueStatus(_).then(function(e){if(e.res&&e.data){var t=e.data;m.info=t.queue_info,m.fileList=[],t&&t.queue_file_list&&(angular.isArray(t.queue_file_list.queue_file)?m.fileList=t.queue_file_list.queue_file:angular.isObject(t.queue_file_list.queue_file)&&m.fileList.push(t.queue_file_list.queue_file))}}),m.cons.currentTab="tab1"):2===e?(m.cons.currentTab="tab2",c.initQueueUserTree(_).then(function(e){var t={view:{selectedMulti:!1},async:{enable:!0,url:"/dipserver/query_etl_table",autoParam:["name=user"],otherParam:{group:_.gn,db_type:_.pt,db_component_name:_.pn},type:"get",contentType:"application/json",dataFilter:function(e,t,n){var r=[];return n&&n.status&&n.response&&angular.isArray(n.response.tables)&&angular.forEach(n.response.tables,function(e,t){r.push({id:t,name:e})}),r}},callback:{onMouseUp:function(e,t,n){if(n&&!n.isParent){var r=n.getParentNode();f=r.name,g=n.name,v=!1,m.selectUserData()}},beforeClick:function(e,t){if(t&&t.isParent)return m.now_user=t.name,m.now_tab="",v=!1,1!==t.id},beforeAsync:function(e,t){return t&&(b=t.name),1!==t.id}}};(!m.chart||$.isEmptyObject(h.option1)||$.isEmptyObject(h.option2))&&(d().then(function(n){m.chart=n.chart,h.option1=n.option1,h.option2=n.option2,$.fn.zTree.init($("#queue_tj_tree"),t,e.data),m.selectAllData()}),i(function(){var e=$("#dl-dark-start"),t=$("#dl-dark-end");e.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",onShow:function(){this.setOptions({maxDate:t.val()?t.val():o("date")(new Date,"yyyy-MM-dd HH:mm:ss")})}}),t.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",minDate:new Date,onShow:function(){this.setOptions({minDate:!!e.val()&&e.val()})}})}))})):3===e&&(c.getQueueDisplayList(_,0,"","","").then(function(e){e.res&&(m.swList=e.list,m.ptotal=e.total)}),i(function(){var e=$("#dl-dark-sh-start"),t=$("#dl-dark-sh-end");e.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",onShow:function(){this.setOptions({maxDate:t.val()?t.val():o("date")(new Date,"yyyy-MM-dd HH:mm:ss")})}}),t.datetimepicker({theme:"dark",format:"Y-m-d H:i:s",minDate:new Date,onShow:function(){this.setOptions({minDate:!!e.val()&&e.val()})}})}),m.cons.currentTab="tab3")}}]}).component("loaderConsole",{templateUrl:"console_view/loaderCon.component.html",bindings:{trans:"<"},controller:["$scope","$rootScope","$stateParams","$state","tipsService","$interval","$filter","$q","csService","$timeout",function(r,a,o,s,i,c,l,u,p,d){function m(){var e={status:1,msg:"",data:null};return p.getLoaderStatus(f).then(function(t){if(t.res){var n=t.data;if(n){_.data.start_scn=n.breakpoint.start_scn,_.data.complete_scn=n.breakpoint.complete_scn,_.data.complete_xid=n.breakpoint.complete_xid,_.data.servers=[];var r={};if(n.server_info&&(angular.isArray(n.server_info.server)?_.data.servers=n.server_info.server:angular.isObject(n.server_info.server)&&_.data.servers.push(n.server_info.server)),_.data.servers.length>0?(angular.forEach(_.data.servers,function(e){e.off_set?h&&(e.off_set=h.off_set):e.off_set=0}),h||(h=_.data.servers[0]),e.status=3,e.data=h,r=_.data.servers[0]):e.status=4,_.cons.chart&&r){var a=r,o=n.timestamp.split(" ")[1];_.cons.chart.addData([[0,a.op_insert,!1,!1,o],[1,a.op_delete,!1,!1],[2,a.op_update,!1,!1],[3,a.op_ddl,!1,!1]])}}else e.status=2}else e.msg=t.msg;return e})}var _=this,f=o;_.cons={cons:!0,currentTab:"tab3",chart:null,option:null,statusRunning:!1},_.data={start_scn:"",complete_scn:0,complete_xid:0,servers:[],offset:0,errors:[],logs:"",isFresh:!1,freshWay:"1",currentId:0};var g,h,v,b=0,y=0;_.loader_err={active:0,loading:!1,his_err_list:[],start_time:"",end_time:"",uname:"",uobject:"",handle:"",has_read:!1},_.ptotal=1,_.pnum=1,_.fy={snum:""},_.pd_info=!1,_.pd_ck_all=!1,_.is_cur=!1,_.is_cur_run=!1,_.empty_err_tip="No Data!",_.err_detail="",_.loader_err_stat={list:[]},_.isShow=!1,_.$onInit=function(){function n(){e(u,_.trans.Co_ldzztj,_.trans.Co_tj).then(function(e){_.cons.chart=e.chart,_.cons.option=e.option,m().then(function(e){f&&(3===e.status?(h=e.data,_.data.currentId=h.pid,t(p,_,f,h,i,y),g=c(function(){m().then(function(n){1===n.status?++b<2&&i.error(n.msg):3===n.status&&(b=0,t(p,_,f,e.data,i,y))})},5e3)):1===e.status&&i.error(e.msg),r.$on("$destroy",function(){angular.isDefined(g)&&(c.cancel(g),g=void 0),v&&angular.isFunction(v)&&v()}))})})}"tab1"===f.tab?(_.cons.currentTab="tab1",n(),_.cons.statusRunning=!0):"tab2"===f.tab?(_.cons.currentTab="tab2",n(),_.cons.statusRunning=!0):"tab3"===f.tab?_.cons.currentTab="tab3":(_.cons.currentTab="tab1",n(),_.cons.statusRunning=!0)},_.$postLink=function(){d(function(){var e=$("#datetimepicker-dark-start"),t=$("#datetimepicker-dark-end");e.datetimepicker({theme:"dark",onShow:function(){this.setOptions({maxDate:t.val()?t.val():l("date")(new Date,"yyyy-MM-dd HH:mm:ss")})}}),t.datetimepicker({theme:"dark",onShow:function(){this.setOptions({minDate:!!e.val()&&e.val()})}})})};var w=function(e){var t=_.loader_err.start_time,n=_.loader_err.end_time,r=_.loader_err.uname,a=_.loader_err.uobject,o=_.loader_err.handle,s=_.loader_err.has_read?16:0;_.loader_err.loading=!0,_.pd_ck_all=!1,p.queryApplyFullErrors(f,r,a,o,e,s,t,n).then(function(e){_.loader_err.loading=!1,e.res&&(_.loader_err.his_err_list=e.list,_.ptotal=e.total,_.pnum>=_.ptotal&&(_.pnum=_.ptotal))},function(){_.loader_err.loading=!1})};_.searchErrList=function(){_.is_cur=!1,_.empty_err_tip="No Data!",_.pnum=1;var e=_.loader_err.start_time,t=_.loader_err.end_time;if(e&&t){if(!angular.isDate(new Date(e)))return void i.error("开始时间格式错误！");if(!angular.isDate(new Date(t)))return void i.error("结束时间格式错误！");if(new Date(t)<new Date(e))return void i.error("开始时间不能大于结束时间！")}w(1)},_.showHistoryList=function(){_.is_cur=!1,_.empty_err_tip="No Data!",_.pnum=1,w(1)},_.pagePre=function(){1===_.ptotal?_.pnum=1:_.pnum-1>0&&(_.pnum=_.pnum-1),w(_.pnum)},_.pageNext=function(){1===_.ptotal&&(_.pnum=1),_.ptotal===_.pnum?_.pnum=_.ptotal:_.pnum+1<=_.ptotal&&(_.pnum=_.pnum+1),w(_.pnum)},_.tiao=function(){""!==_.fy.snum&&(_.pnum=parseInt(_.fy.snum)||_.pnum,_.fy.snum="",w(_.pnum))},_.getNewLog=function(){f&&h&&n(p,_,f,h)},_.getDetail=function(e){h=e,_.data.currentId=e.pid},_.showTab=function(e){_.cons.currentTab="tab"+e,_.cons.statusRunning||(loaderStart(),_.cons.statusRunning=!0),_.isShow=4===e},v=a.$on("consoleView",function(e,t){var n=$("#Capture_chart_id"),r=n.width();t?n.width(r-193):n.width(r+193),_.cons.chart&&_.cons.chart.resize()}),_.closeDetailPanel=function(){_.pd_info=!1,_.err_detail=""},_.showHisErrDetail=function(e){_.pd_info=!0,angular.isString(e)&&e.length>0&&(_.err_detail=e)},_.outputExcel=function(){p.exportExcelErrorFile(f)},_.markReaded=function(){var e="",t=l("filter")(_.loader_err.his_err_list,{flag:!0});if(t.length<=0)return void i.error(l("translate")("Co_tip1"));angular.forEach(t,function(t){e+="<location><offset>"+t.offset+"</offset></location>"}),p.markedApplyError(f,e).then(function(e){e&&(i.success(l("translate")("Co_tip2")),w(1))})},_.ckAllChange=function(){var e=_.pd_ck_all;angular.forEach(_.loader_err.his_err_list,function(t){t.flag=e})},_.itemCkChange=function(e){var t=0;e.flag?(angular.forEach(_.loader_err.his_err_list,function(e){e.flag&&t++}),_.loader_err.his_err_list.length===t&&(_.pd_ck_all=!0)):_.pd_ck_all=!1},_.clearErrLogs=function(){p.clearErrorLogs(f).then(function(e){e&&(_.loader_err.his_err_list=[],_.ptotal=1,_.pnum=1)})},_.showErrTj=function(){_.getErrStatList()},_.getErrStatList=function(){p.getErrorStatList(f).then(function(e){e.res&&(_.loader_err_stat.list=e.list)})},_.exceptCkList=function(){var e="",t=l("filter")(_.loader_err.list,{checked:!0});if(t.length<=0)return void i.error(l("translate")("Co_tip3"));angular.forEach(t,function(t){e+="<owner>"+t.owner+"</owner><table>"+t.table_name+"</table>"}),p.excludeSelectTable(f,e).then(function(e){e&&i.success(l("translate")("Co_zxcg"))})},_.reSyncCkList=function(){var e="",t=l("filter")(_.loader_err.list,{checked:!0});if(t.length<=0)return void i.error(l("translate")("Co_tip3"));angular.forEach(t,function(t){e+="<owner>"+t.owner+"</owner><table>"+t.table_name+"</table>"}),p.syncTablePart(f,e).then(function(e){e&&w(1)})};var x=function(e,t){var n=new BootstrapDialog({title:"Full Sync Info",type:"type-warning",message:function(){return'<h2 class="text-warning">'+t+"</h2>"},closable:!1});n.open(),p.handleError(f,e).then(function(e){e.res?(n.setType("type-success"),n.getModalBody().html('<h2 class="text-success">'+l("translate")("Co_gxzxcg")+'<i class="green glyphicon glyphicon-ok"></i></h2>'),_.showCurrentErr()):(n.setType("type-danger"),n.getModalBody().html('<h2 class="text-error">'+e.msg+'<i class="red glyphicon glyphicon-remove"></i></h2>')),n.setClosable(!0),setTimeout(function(){n.close()},500)},function(){i.error(l("translate")("Wlcw")),n.setClosable(!0),n.close()})};_.showCurrentErr=function(){_.is_cur=!0,_.empty_err_tip="No Data!",p.getLoaderCurrentError(f).then(function(e){if(e.res){var t=e.data,n={};if($.isEmptyObject(t))return;"running"===t.status?(_.loader_err.his_err_list=[],_.empty_err_tip=l("translate")("Co_tip4"),_.is_cur_run=!0):(_.is_cur_run=!1,_.loader_err.his_err_list=[],_.ptotal=1,_.pnum=1,n.owner=t.owner,n.time=t.time,n.object=t.object,n.operation=t.operation,n.error_type=t.error_type,n.action=t.action,n.flag=!1,n.detailed_message=t.detailed_message,_.loader_err.his_err_list.push(n))}})},_.resetErrParams=function(){_.loader_err.start_time="",_.loader_err.end_time="",_.loader_err.uname="",_.loader_err.uobject="",_.loader_err.handle="",_.loader_err.has_read=!1,w(1)},_.handleErr=function(e){var t="";"auto_fix_data"===e?(t=l("translate")("Co_tip5"),x(e,t)):"skip_error"===e?(t=l("translate")("Co_tip6"),x(e,t)):"exclude_table"===e?(t=l("translate")("Co_tip7"),x(e,t)):"force_updates"===e?(t=l("translate")("Co_tip8"),x(e,t)):"retry_error"===e?(t=l("translate")("Co_tip9"),x(e,t)):"refresh"===e&&this.showCurrentErr()}}]}).component("loaderErr",{templateUrl:"console_view/loaderErrStatis.component.html",bindings:{errList:"<",onUpdate:"&"},controller:function(){var e=this;e.loader_err_stat={list:[],ckAll:!1,loading:!1},e.$onInit=function(){angular.forEach(e.errList,function(e){e.checked=!1})},e.getErrStatList=function(){e.loader_err_stat.ckAll=!1,e.onUpdate()},e.ckErrAllChange=function(){var t=e.loader_err_stat.ckAll;angular.forEach(e.errList,function(e){e.checked=t})},e.ckErrItemChange=function(t){var n=0;t.checked?(angular.forEach(e.errList,function(e){e.checked&&n++}),n===e.errList.length&&(e.loader_err_stat.ckAll=!0)):e.loader_err_stat.ckAll=!1}}}).component("loaderPcb",{templateUrl:"console_view/loaderPcb.component.html",bindings:{isShow:"<"},controller:["$stateParams","csService","tipsService","$log",function(e,t,n,r){var a=this;a.ckAll=!1,a.pcbList=[],a.loading=!1,a.ptotal=1,a.pnum=1,a.fy={snum:""};var o=function(n){a.loading=!0,t.getLoaderPcbList(e,n).then(function(e){a.pcbList=e.list,a.ckAll=!1,a.ptotal=e.total,a.pnum>=a.ptotal&&(a.pnum=a.ptotal)}).finally(function(){a.loading=!1})};a.$onChanges=function(e){e.isShow.currentValue&&o(1)},a.pagePre=function(){1===a.ptotal?a.pnum=1:a.pnum-1>0&&(a.pnum=a.pnum-1),o(a.pnum)},a.pageNext=function(){1===a.ptotal&&(a.pnum=1),a.ptotal===a.pnum?a.pnum=a.ptotal:a.pnum+1<=a.ptotal&&(a.pnum=a.pnum+1),o(a.pnum)},a.tiao=function(){""!==a.fy.snum&&(a.pnum=parseInt(a.fy.snum)||a.pnum,a.fy.snum="",o(a.pnum))},a.ckAllChange=function(){angular.forEach(a.pcbList,function(e){e.checked=a.ckAll})},a.ckItemChange=function(e){var t=0;e.checked?(angular.forEach(a.pcbList,function(e){e.checked&&t++}),t===a.pcbList.length&&(a.ckAll=!0)):a.ckAll=!1},a.deleteRecords=function(){var r=[];if(angular.forEach(a.pcbList,function(e){e.checked&&r.push({owner:e.owner,table:e.table})}),0===r.length)return void n.warning("您未选中任何数据！");BootstrapDialog.confirm({title:"Dip 提示",message:"确认删除这些记录吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(a){a&&t.deletePcbList(e,r).then(function(e){e?(n.success("删除成功！"),o(1)):n.error("删除失败！")})}})}}]}).directive("page",function(){return{restrict:"EA",scope:{pre:"&",next:"&",tiao:"&",cnum:"=",tt:"=",snum:"="},
template:'<button class="btn button" ng-click="pre()"><i class="fa fa-arrow-circle-o-left"></i></button><span>{{cnum+"/"+tt}}</span><button class="btn button" ng-click="next()"><i class="fa fa-arrow-circle-o-right"></i></button><input class="input" type="number" ng-model="snum" min="1" size="30"><button class="btn button" ng-click="tiao();snum=\'\';"><i class="fa fa-search"></i></button>',link:function(e){e.$watch("snum",function(t,n){if(t!==n){if(t>e.tt)return void(e.snum=e.tt);if(t<1)return void(e.snum="");e.snum=t&&isFinite(t)?t:n}})}}})}(),function(){angular.module("myApp.group_view",["ui.bootstrap","myApp.groupService","myApp.groupComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){t.state("/.group_view",{url:"/group_view",component:"groupModel",params:{group:null}}).state("/.group_view.status",{url:"/status",component:"groupStatus",params:{group:null}}).state("/.group_view.property",{url:"/property",component:"groupProperty",params:{group:null}})}])}(),function(){function e(e,t,n,r,a){this.addGroup=function(t,r,a,o){var s={projectid:t,group:r.groupName,description:r.desc,log_save_hour:r.logTime,users:a,auth:o},i={res:!1,error:{},groupId:""};return s=n.md5Data(s),e.postDataList("/dipserver/add_group",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(i.res=!0,i.groupId=e.response&&e.response.group_id||""):(i.res=!1,i.error=e.response)),i})},this.modifyGroup=function(a,o){var s={group:a.groupName,new_group:a.groupName,description:a.desc,log_save_hour:a.logTime,group_id:o},i=!1;return s=n.md5Data(s),e.postDataList("/dipserver/modify_group",s).then(function(e){return n.equalMd5Data(e)&&(e.status?i=!0:t.error(e.response&&e.response.error_msg)),i},function(){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.groupService",[]).service("groupService",e),e.$inject=["httpService","tipsService","md5Service","$filter","$q","$window"]}(),function(){angular.module("myApp.groupComponent",[]).component("groupModel",{templateUrl:"group_view/groupView.component.html",controller:["$state","currentGroupService","$stateParams","$filter","$translate",function(e,t,n,r,a){var o=this,s=n.group;o.$onInit=function(){},o.menu={dialog:!0,mc:1,createStatus:!1,title:""},a("Gp_pz").then(function(e){o.menu.title=e}),"new"===s&&(o.menu.createStatus=!0,o.menu.mc=2,o.menu.title=r("translate")("Gp_xjz")),e.includes("**.status")&&(o.menu.mc=1),e.includes("**.property")&&(o.menu.mc=2),o.changeTab=function(n){1===n?(this.menu.mc=1,e.go("/.group_view.status",{group:t.curGroup})):2===n&&(this.menu.mc=2,e.go("/.group_view.property",{group:t.curGroup}))},o.redirectTo=function(t){e.go(t)}}]}).component("groupStatus",{templateUrl:"group_view/status.component.html",controller:["$state","$stateParams","$filter","$translate",function(e,t,n,r){var a=this,o=t.group;a.$onInit=function(){},a.group={dialog:!0},a.params={groupName:!1,log:!1,desc:!1,gid:!1},a.property={groupName:"",logTime:48,desc:""},a.real={group_id:"",hour:""},r("HOUR").then(function(e){a.real.hour=e}),o?(a.property.groupName=o.title,a.property.logTime=o.log_del_duration,a.property.desc=o.desc,a.real.group_id=o.group_id):e.go("/")}]}).component("groupProperty",{templateUrl:"group_view/property.component.html",controller:["$state","currentGroupService","tipsService","$stateParams","groupService","$filter","$rootScope",function(e,t,n,r,a,o,s){var i=this,c=r.group;i.$onInit=function(){},i.group={dialog:!0},i.params={groupName:!1,log:!1,desc:!1,gid:!1},i.property={groupName:"",logTime:48,desc:"",group_id:""},i.back_err={show:!1,msg:""},i.real={group_id:""},i.isSaving=!1,c&&"new"!==c&&(i.property.groupName=c.title,i.property.logTime=c.log_del_duration,i.property.desc=c.desc,i.property.group_id=c.group_id,i.real.group_id=c.group_id),i.saveGroupInfo=function(){if(i.real.group_id&&"undefined"!==i.real.group_id&&"new"!==c)return void i.modifyGroupInfo();var r=window.localStorage.getItem("uname"),l=window.localStorage.getItem("uauth"),u=!1,p=window.localStorage.getItem("proId");if(t.groupList&&t.groupList.length>0&&angular.forEach(t.groupList,function(e){e.title===i.property.groupName&&(u=!0)}),u&&"new"===c)return i.back_err.show=!0,void(i.back_err.msg=o("translate")("Gp_zmbcf"));i.back_err.show=!1,i.back_err.msg="",i.isSaving=!0,a.addGroup(p,i.property,r,l).then(function(t){t.res?(i.real.group_id=t.groupId,i.property.group_id=i.real.group_id,n.success(o("translate")("Bccg")),e.go("/"),s.$emit("createGroup",i.property)):t.error&&t.error.error_code&&("00009"===t.error.error_code?n.error("一个项目里面最多可建64个组！"):n.error(t.error&&t.error.error_msg))}).finally(function(){i.isSaving=!1})},i.modifyGroupInfo=function(){var r=!1;if(t.groupList&&t.groupList.length>0&&angular.forEach(t.groupList,function(e){e.title===i.property.groupName&&i.property.group_id!==e.group_id&&(r=!0)}),r)return i.back_err.show=!0,void(i.back_err.msg=o("translate")("Gp_zmbcf"));i.back_err.show=!1,i.back_err.msg="",a.modifyGroup(i.property,i.real.group_id).then(function(t){t&&(s.$emit("modifyGroup",i.property),n.success(o("translate")("Bccg")),e.go("/"))})}}]})}(),angular.module("myApp.cp_view",["ui.bootstrap","myApp.cpService","myApp.cpComponent"]).config(["$urlServiceProvider","$stateProvider",function(e,t){e.rules.when("/main/cp_view/","/main/cp_view/status"),t.state("/.cp_view",{abstract:!0,url:"/cp_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Cp_pz")}],captureInfo:["$transition$","cpService",function(e,t){var n=e.params();return n.gn&&n.pn&&n.pt?t.getCaptureConfig(n):"init"}]},bindings:{title:"title"}}).state("/.cp_view.status",{url:"/status?gn&cn&pn&pt&id&cid",component:"cpStatus",bindings:{dl:"captureInfo"}}).state("/.cp_view.property",{url:"/property?gn&cn&pn&pt&id&cid",component:"cpProperty",bindings:{dl:"captureInfo"}})}]),function(){function e(e,t,n,r){function a(e,t,n){var r,a=[],o=[],s=t.selected_users,i=t.all_users,c=[];if(s){var l=[];angular.isArray(s.user)?l=s.user:l.push(s.user),angular.forEach(l,function(e){a.push(e)}),a.sort()}if(i){var u=[];angular.isArray(i.user)?u=i.user:u.push(i.user),angular.forEach(u,function(e){var t=0;angular.forEach(a,function(n){n===e&&(t=1)}),0===t&&o.push(e)}),o.sort()}return"oracle-rac"===n&&(angular.isArray(t.rac_info.instance)?c=t.rac_info.instance:angular.isObject(t.rac_info.instance)&&c.push(t.rac_info.instance)),r=t.downstream_info,angular.isObject(t.downstream_info)&&(r=t.downstream_info),{unselList:o,selList:a,property:t.parameter,racs:c,captureName:e.cn,downstream_info:r}}this.getCaptureConfig=function(o){var s="unnamed"===o.cn?"":o.cn,i={group_id:o.gn,db_component_id:o.pn,component_id:o.cid,type:o.pt,component_name:s},c=null;i=n.md5Data(i);return e.postDataList("/dipserver/query_capture_config",i).then(function(e){if(n.equalMd5Data(e))if(e.status){var r="",s=e.response;"oracle"===o.pt&&(r="oracle",s.rac_info&&s.rac_info.instance&&(r="oracle-rac")),c=a(o,s,r)}else t.error(e.response&&e.response.error_msg);return c},function(){t.error(r("translate")("Wlcw"))})},this.addCaptureProperty=function(t){var r={res:!1,comId:"",msg:""};return t=n.md5Data(t),e.postDataList("/dipserver/add_capture_property",t,0).then(function(e){return n.equalMd5Data(e)&&(e.status?(r.res=!0,r.comId=e.response&&e.response.component_id||""):r.msg=e.response.error_msg),r})},this.saveParameter=function(a,o){var s={group_id:a.gn,component_id:a.cid,parameter:o},i=!1;return s=n.md5Data(s),e.postDataList("/dipserver/save_parameter",s).then(function(e){return n.equalMd5Data(e)&&(e.status?i=!0:t.error(e.response&&e.response.error_msg)),i},function(){t.error(r("translate")("Bcsb"))})},this.queryCaptureTable=function(a,o){var s,i={res:!1,info:null};return s={group:a.gn,db_component_name:a.pn,component_name:a.cid,selected_users:{user:o}},s=n.md5Data(s),e.postDataList("/dipserver/query_capture_table",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response||[];i.res=!0,i.info=r}else t.error(e.response&&e.response.error_msg);return i},function(){t.error(r("translate")("Wlcw"))})},this.saveKzTable=function(a,o,s,i,c){var l={group_id:a.gn,component_name:o,db_component_id:a.pn,type:a.pt,selected_users:s,snapshot_tables:{schema:i},parameter:c,component_id:a.cid};l=n.md5Data(l);return e.postDataList("/dipserver/add_capture_property",l).then(function(e){n.equalMd5Data(e)&&(e.status?t.success(r("translate")("Bccg")):t.error(e.response&&e.response.error_msg))},function(){t.error(r("translate")("Bcsb"))})},this.changeExtendedLog=function(t,r){var a,o=!1;return a={group:t.gn,db_name:t.pn,extend_table:{user:r.name,table:r.table,status:r.cz}},a=n.md5Data(a),e.postDataList("/dipserver/change_extended_log",a,0).then(function(e){return n.equalMd5Data(e)&&(o=!!e.status),o})},this.queryExtendLogTable=function(a,o){var s,i={res:!1,info:null};return s={group:a.gn,db_name:a.pn,user:o},s=n.md5Data(s),e.postDataList("/dipserver/query_extended_log_table",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response||[];i.res=!0,i.info=r}else t.error(e.response&&e.response.error_msg);return i},function(){t.error(r("translate")("Wlcw"))})},this.getDb2Schema=function(a){var o,s={res:!1,list:[]};return o={group:a.gn,db_id:a.pn,type:"schema"},o=n.md5Data(o),e.postDataList("/dipserver/query_db2_schema",o).then(function(e){if(n.equalMd5Data(e))if(e.status){s.res=!0;var r=[];e.response&&angular.isArray(e.response)&&(r=e.response),angular.forEach(r,function(e,t){s.list.push({id:t,name:e,gp:a.gn,db:a.pn,checked:!1,icon:"/img/ico/schema.png",isParent:!0,children:[]})})}else t.error(e.response&&e.response.error_msg);return s},function(){t.error(r("translate")("Wlcw"))})},this.saveDb2CdcInfo=function(a,o,s){var i,c=!1;return i={close_cdc_set:a,open_cdc_set:o,db_id:s},i=n.md5Data(i),e.postDataList("/dipserver/set_db2_cdc",i).then(function(e){return n.equalMd5Data(e)&&(e.status&&"SUCCESS"===e.response?c=!0:t.error(e.response&&e.response.error_msg)),c},function(){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.cpService",[]).service("cpService",e),e.$inject=["httpService","tipsService","md5Service","$filter"]}(),function(){angular.module("myApp.cpComponent",[]).component("cpStatus",{templateUrl:"capture_view/status.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","$filter",function(e,t,n){var r=this,a=e;r.data={cb:"all",testing:!1,superConfig:!1,left:">>",right:"<<",second:n("translate")("SECOND"),yes:n("translate")("YES"),no:n("translate")("NO"),hour:n("translate")("HOUR")},r.status={},r.params={captureName:!1,zfj:!1,xtjg:!1,cqjg:!1,scnxx:!1,racscn:!1,swc:!1,swczd:!1,ncdl:!1,lobzd:!1,gxqzd:!1,bingf:!1,bfgs:!1,maxlog:!1,capId:!1,zqjg:!1,skipGrant:!1,fullColUpdate:!1,onLine:!1,cpjg:!1,ssjg:!1,fccl:!1,bcrztb:!1,ctbcrz:!1,zqlzz:!1,hlwgx:!1},r.dbConf={nowDB:"oracle"},r.racs=[],r.real={com_id:""},r.$onInit=function(){if(r.dl&&angular.isObject(r.dl)){r.data.unselList=r.dl.unselList||[],r.data.selList=r.dl.selList||[];var e=r.dl.property;if(r.property=e||{},r.property.captureName=r.dl.captureName&&"unnamed"!==r.dl.captureName?r.dl.captureName:"",angular.forEach(r.dl.racs,function(e){e.path||(e.path=""),e.enable="yes"===e.enable||"是"===e.enable?r.data.yes:r.data.no}),r.racs=r.dl.racs,r.dl.racs.length,"oracle"===a.pt||"oracle-rac"===a.pt)r.dbConf.nowDB="oracle",r.property.nls_lang=e.nls_lang||"",r.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,r.property.capture_heartbeat=parseInt(e.capture_heartbeat)?parseInt(e.capture_heartbeat):300,r.property.logminer_restart_time=parseInt(e.logminer_restart_time)?parseInt(e.logminer_restart_time):300,r.property.back_scn=parseInt(e.back_scn)?parseInt(e.back_scn):10,r.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,r.property.internal_queue_size=parseInt(e.internal_queue_size)?parseInt(e.internal_queue_size):32,r.property.scn_evaluate_time=parseInt(e.scn_evaluate_time)?parseInt(e.scn_evaluate_time):20,r.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,r.property.lob_skip=e.lob_skip||"no",r.property.concurrent=e.concurrent||"no",r.property.parallel=parseInt(e.parallel)?parseInt(e.parallel):1,r.property.full_column_update=e.full_column_update||"no",r.property.use_online_dict=e.use_online_dict||"no",r.property.capture_grant=e.capture_grant||"no";else if("sqlserver"===a.pt)r.dbConf.nowDB=a.pt,r.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,r.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,r.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,r.property.checkpoint_interval=parseInt(e.checkpoint_interval)?parseInt(e.checkpoint_interval):1,r.property.snapshot_interval=parseInt(e.snapshot_interval)?parseInt(e.snapshot_interval):1,r.property.full_column_update=e.full_column_update||"yes",r.property.fetch_delay_reconnect=parseInt(e.fetch_delay_reconnect)?parseInt(e.fetch_delay_reconnect):20,r.property.sync_when_extend_log=e.sync_when_extend_log||"yes",r.property.extend_log_when_create=e.extend_log_when_create||"yes",r.property.cap_loader_data=e.cap_loader_data||"yes";else if("db2"===a.pt){r.dbConf.nowDB="db2",r.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,r.property.readlog_only=1===parseInt(e.readlog_only)?r.data.yes:r.data.no,r.property.db2_set_cdc=1===parseInt(e.db2_set_cdc)?r.data.yes:r.data.no,r.property.log_slot_size=(parseInt(e.log_slot_size)?parseInt(e.log_slot_size):1e3)+"K",r.property.max_log_slot=parseInt(e.max_log_slot)?parseInt(e.max_log_slot):1e3;var n=parseInt(e.update_ratio)?parseInt(e.update_ratio):0;r.property.update_ratio=100*n+"%"}else r.dbConf.nowDB=a.pt,r.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,r.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,r.property.cap_loader_data=e.cap_loader_data||"yes";"undefined"!==a.cid&&a.cid&&(r.real.com_id=a.cid)}else t.go("/")}}]}).component("cpProperty",{templateUrl:"capture_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","graphicService","$filter","$uibModal","cpService",function(e,t,n,r,a,o,s){function i(e,t,n){n&&n.isParent&&(f.db2Param={group:g.gn,db_id:g.pn,schema:n.name,type:"table"})}function c(e){var t=[];return 0===e.length?t:(angular.forEach(e,function(e){if(e.thread&&e.name&&e.ip&&e.port){var n=e.enable?"yes":"no",r={};r.thread=e.thread,r.name=e.name,r.ip=e.ip,r.port=e.port,r.enable=n,r.path=e.path,t.push(r)}}),t)}function l(){s.queryExtendLogTable(g,f.data.selList).then(function(e){if(e.res){var t=m(e.info);h=$.fn.zTree.init($("#objTree"),y,t)}})}function u(){var e=[];if(v){var t=v.getCheckedNodes();angular.forEach(t,function(t){if(0===t.level){var n={};n.name=t.name,n.table=[],0===t.level&&angular.forEach(t.children,function(e){e.checked&&n.table.push(e.name)}),e.push(n)}})}return e}function p(e,t){var n={};if("oracle"===t||"oracle-rac"===t){var r="lx"===f.logFx.ms?"yes":"no",a=e.parallel?e.parallel:1;n.downstream=r,n.nls_lang=e.nls_lang,n.capture_interval=e.capture_interval,n.capture_heartbeat=e.capture_heartbeat,n.logminer_restart_time=e.logminer_restart_time,n.back_scn=e.back_scn,n.transaction_slot_size=e.transaction_slot_size+"K",n.internal_queue_size=e.internal_queue_size+"M",n.scn_evaluate_time=e.scn_evaluate_time,n.max_transaction_slot=e.max_transaction_slot,n.lob_skip=e.lob_skip,n.concurrent=e.concurrent,n.parallel=a,n.full_column_update=e.full_column_update||"no",n.use_online_dict=e.use_online_dict||"no",n.capture_grant=e.capture_grant||"no"}else if("sqlserver"===t)n.capture_interval=e.capture_interval,n.checkpoint_interval=e.checkpoint_interval,n.snapshot_interval=e.snapshot_interval,n.fetch_delay_reconnect=e.fetch_delay_reconnect,n.sync_when_extend_log=e.sync_when_extend_log,n.extend_log_when_create=e.extend_log_when_create,n.cap_loader_data=e.cap_loader_data;else if("db2"===t){n.max_transaction_slot=e.max_transaction_slot,n.capture_interval=e.capture_interval,n.transaction_slot_size=e.transaction_slot_size+"K",n.readlog_only=e.readlog_only,n.db2_set_cdc=e.db2_set_cdc,n.log_slot_size=e.log_slot_size+"K",n.max_log_slot=e.max_log_slot,n.cap_loader_data=e.cap_loader_data;var o=parseInt(e.update_ratio)?parseInt(e.update_ratio):0;n.update_ratio=o/100}else n.capture_interval=e.capture_interval,n.transaction_slot_size=e.transaction_slot_size+"K",n.cap_loader_data=e.cap_loader_data;return n}function d(e){return angular.isArray(e.data.selList)?e.data.selList:[]}function m(e){var t=[];return e&&angular.isArray(e.extend_table)&&angular.forEach(e.extend_table,function(e){var n={},r=1,a=parseInt(e.extend_num)||0,o=parseInt(e.sum_num)||0,s=e.user,i=angular.isArray(e.table)?e.table:[];n.name=s,n.children=[],n.icon="/img/ico/schema.png",n.checked=a===o&&0!==o,angular.forEach(i,function(e){var t={};t.name=e,r<=a?(t.checked=!0,r++):t.checked=!1,t.icon="/img/ico/object.png",n.children.push(t)}),t.push(n)}),t}function _(e){var t=[],n=e.all_unrepl&&angular.isArray(e.all_unrepl)?e.all_unrepl:[],r=e.snapshot_tables&&angular.isArray(e.snapshot_tables.schema)?e.snapshot_tables.schema:[];return angular.forEach(n,function(e){var n={},a=e.table||[],o=[],s=0;n.name=e.name,n.checked=!1,n.icon="/img/ico/schema.png",n.children=[],angular.forEach(r,function(t){t.name===e.name&&(o=t.table||[])}),angular.forEach(a,function(e){var t={};t.name=e,t.checked=!1,t.icon="/img/ico/object.png",a.length===o.length?(t.checked=!0,s=1):angular.forEach(o,function(n){n===e&&(t.checked=!0,s=0)}),n.children.push(t)}),1===s&&(n.checked=!0),t.push(n)}),t}var f=this,g=e;f.number=0,f.data={unselList:[],selList:[],selModel:[],unselModel:[],superConfig:!1,serErr:null,left:">>",right:"<<",lxErr:"",isValid:!1},f.params={captureName:!1,zfj:!1,xtjg:!1,cqjg:!1,scnxx:!1,racscn:!1,swc:!1,swczd:!1,ncdl:!1,lobzd:!1,gxqzd:!1,bingf:!1,bfgs:!1,skipGrant:!1,fullColUpdate:!1,onLine:!1,capId:!1,cpjg:!1,ssjg:!1,hlwgx:!1,fccl:!1,bcrztb:!1,ctbcrz:!1,zqlzz:!1,zqjg:!1},f.property={captureName:"",downstream:"no",nls_lang:"AMERICAN_AMERICA.ZHS16GBK",capture_interval:15,capture_heartbeat:300,logminer_restart_time:300,back_scn:10,transaction_slot_size:32,internal_queue_size:32,scn_evaluate_time:20,max_transaction_slot:1e3,lob_skip:"no",concurrent:"no",parallel:1,full_column_update:"no",use_online_dict:"no",capture_grant:"no"},f.racs=[],f.rac_param_ck=!0,f.rac_param_error="",f.logFx={ms:"zx",db_ip:"",db_id:"",db_user:"",db_password:"",db_port:""},f.dbConf={nowDB:"",isEdit:!1,oraclePanel:!1,sqlserPanel:!1,sqlActive:0,sqlLog:{isEdit:!1,totalApp:0,appNum:0,totalCan:0,canNum:0,error:0,ckAll:!0,excuteBtx:"执行",excuteIng:!1,tables:[]}},f.real={com_id:""};var h=null,v=null,b=[],y={showLine:!0,check:{enable:!0},edit:{enable:!0}};f.isSaving=!1;var w=a("translate")("SAVE"),x=a("translate")("SAVING");f.isSaving1=!1,f.saveBtnTxt=w,f.db2Param={},f.isBpz=!1;var I,k={showLine:!0,check:{enable:!0},view:{selectedMulti:!1},async:{enable:!0,url:"/dipserver/query_db2_table",autoParam:[],otherParam:{},type:"get",contentType:"application/json",dataFilter:function(e,t,n){var r=[];return n&&n.status&&n.response&&angular.isArray(n.response)&&angular.forEach(n.response,function(e,n){var a="yes"===e.status;r.push({id:n,name:e.name,ps:t.name,checked:a,icon:"/img/ico/object.png"})}),r}},callback:{onClick:i}};f.$onInit=function(){if(null===f.dl)t.go("/");else if(f.dl&&"init"!==f.dl){f.data.unselList=f.dl.unselList||[],f.data.selList=f.dl.selList||[];var e=f.dl.property;f.dl.captureName&&(f.property.captureName=f.dl.captureName&&"unnamed"!==f.dl.captureName?f.dl.captureName:""),f.property.full_column_update||(f.property.full_column_update="no"),f.property.concurrent||(f.property.concurrent="no"),"undefined"!==g.cid&&g.cid&&(f.real.com_id=g.cid);var n=[];if(angular.forEach(angular.copy(f.dl.racs),function(e){e.path||(e.path=""),e.enable="yes"===e.enable||"是"===e.enable,n.push(e)}),f.racs=n,"oracle"===g.pt||"oracle-rac"===g.pt)f.dbConf.nowDB="oracle",f.dbConf.oraclePanel=!0,f.property.nls_lang=e.nls_lang||"",f.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,f.property.capture_heartbeat=parseInt(e.capture_heartbeat)?parseInt(e.capture_heartbeat):300,f.property.logminer_restart_time=parseInt(e.logminer_restart_time)?parseInt(e.logminer_restart_time):300,f.property.back_scn=parseInt(e.back_scn)?parseInt(e.back_scn):10,f.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,f.property.internal_queue_size=parseInt(e.internal_queue_size)?parseInt(e.internal_queue_size):32,f.property.scn_evaluate_time=parseInt(e.scn_evaluate_time)?parseInt(e.scn_evaluate_time):20,f.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,f.property.lob_skip=e.lob_skip||"no",f.property.concurrent=e.concurrent||"no",f.property.parallel=parseInt(e.parallel)?parseInt(e.parallel):1,f.property.full_column_update=e.full_column_update||"no",f.property.use_online_dict=e.use_online_dict||"no",f.property.capture_grant=e.capture_grant||"no";else if("sqlserver"===g.pt)f.dbConf.nowDB=g.pt,f.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,f.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,f.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,f.property.checkpoint_interval=parseInt(e.checkpoint_interval)?parseInt(e.checkpoint_interval):1,f.property.snapshot_interval=parseInt(e.snapshot_interval)?parseInt(e.snapshot_interval):1,f.property.full_column_update=e.full_column_update||"yes",f.property.fetch_delay_reconnect=parseInt(e.fetch_delay_reconnect)?parseInt(e.fetch_delay_reconnect):20,f.property.sync_when_extend_log=e.sync_when_extend_log||"yes",f.property.extend_log_when_create=e.extend_log_when_create||"yes",f.property.cap_loader_data=e.cap_loader_data||"yes";else if("db2"===g.pt){f.dbConf.nowDB="db2",f.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,f.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,f.property.max_transaction_slot=parseInt(e.max_transaction_slot)?parseInt(e.max_transaction_slot):1e3,f.property.cap_loader_data="yes"===e.cap_loader_data?"yes":"no",f.property.readlog_only="yes"===e.readlog_only?"yes":"no",f.property.db2_set_cdc="yes"===e.db2_set_cdc?"yes":"no",f.property.log_slot_size=parseInt(e.log_slot_size)?parseInt(e.log_slot_size):1e3,f.property.max_log_slot=parseInt(e.max_log_slot)?parseInt(e.max_log_slot):1e3;var r=parseInt(e.update_ratio)?parseInt(e.update_ratio):0;f.property.update_ratio=100*r}else f.dbConf.nowDB=g.pt,f.property.capture_interval=parseInt(e.capture_interval)?parseInt(e.capture_interval):15,f.property.transaction_slot_size=parseInt(e.transaction_slot_size)?parseInt(e.transaction_slot_size):32,f.property.cap_loader_data=e.cap_loader_data||"yes";f.dbConf.isEdit=!0,f.dl.downstream_info?(f.logFx.ms="lx",f.logFx.db_ip=f.dl.downstream_info.db_ip||"",f.logFx.db_id=f.dl.downstream_info.db_id||"",f.logFx.db_user=f.dl.downstream_info.db_user||"",f.logFx.db_password=f.dl.downstream_info.db_password||"",f.logFx.db_port=f.dl.downstream_info.db_port||""):f.logFx.ms="zx"}},f.itemDesc=function(e){angular.forEach(f.params,function(t,n){if("all"===e)!0;else if("none"===e)!1;else if(n===e)return!0,!1})},f.lxMacConfig=function(){o.open({component:"offlineModel",windowClass:"small-modal-panel",size:"md",resolve:{title:function(){return"离线分析主机配置"},dbInfo:function(){return f.logFx}}}).result.then(function(e){f.logFx=e,f.logFx.ms="lx",f.data.lxErr=""})},f.saveCaptureInfo=function(){var e,o,i="",l=f.property.captureName,m=g.pt,_="";if("unnamed"===l)return void n.error(a("translate")("Cp_mcbnk"));if(parseInt(f.property.transaction_slot_size)*parseInt(f.property.max_transaction_slot)/1024+parseInt(f.property.internal_queue_size)>1024)return void(f.data.serErr=a("translate")("Cp_xz"));if(f.data.serErr="","lx"===f.logFx.ms){if(!(f.logFx.db_ip&&f.logFx.db_id&&f.logFx.db_user&&f.logFx.db_password&&f.logFx.db_port))return void(f.data.lxErr="离线分析模式必须对离线主机进行配置！");f.data.lxErr="",_={db_ip:f.logFx.db_ip,db_id:f.logFx.db_id,db_user:f.logFx.db_user,db_password:f.logFx.db_password,db_port:f.logFx.db_port}}var h=c(f.racs);if("oracle"===m||"oracle-rac"===m)e=d(f),o=p(f.property,m),i={group_id:g.gn,component_name:l,db_component_id:g.pn,type:g.pt,selected_users:e,downstream_info:_,rac_info:{instance:h},parameter:o,component_id:g.cid};else if("sqlserver"===m||"db2"===m||"mysql"===m){e=d(f),o=p(f.property,m);var v=u();i={group_id:g.gn,component_name:f.property.captureName,db_component_id:g.pn,type:g.pt,selected_users:e,snapshot_tables:{schema:v},rac_info:{instance:h},parameter:o,component_id:g.cid}}f.isSaving=!0,f.saveBtnTxt=x;!function(){var e=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),n=function(t,n){t?(e.setType("type-success"),e.getModalBody().html("保存成功！"),setTimeout(function(){e.close()},300)):(e.setType("type-danger"),n?e.getModalBody().html(n):e.getModalBody().html("保存失败！")),e.setClosable(!0)};e.open(),s.addCaptureProperty(i).then(function(e){if(e.res){f.real.com_id=e.comId;var a=$("#"+g.id);a.find(".dragPoint").text(l),a.attr("name",l),a.attr("type",m),a.attr("realid",f.real.com_id),r.save_graphics_no_alert(g.gn).finally(function(){n(!0)}),t.go("/")}else n(!1,e.msg)}).catch(function(){n(!1)}).finally(function(){f.isSaving=!1,f.saveBtnTxt=w})}()},f.pushSelect=function(){if(f.data.unselModel&&f.data.unselModel.length>0){var e=[];angular.forEach(f.data.unselList,function(t){$.inArray(t,f.data.unselModel)<0?e.push(t):(f.data.selList.push(t),f.data.selList.sort())}),e.sort(),f.data.unselList=e,f.data.unselModel=[]}},f.removeSelect=function(){if(f.data.selModel&&f.data.selModel.length>0){var e=[];angular.forEach(f.data.selList,function(t){$.inArray(t,f.data.selModel)<0?e.push(t):(f.data.unselList.push(t),f.data.unselList.sort())}),e.sort(),f.data.selList=e,f.data.selModel=[]}},f.onlyNonNegative_tow=function(e){event.keyCode;e.value=e.value.replace(/[^\d]/g,"")},f.blur_trans_parallel=function(e){e.value<2&&(e.value=2)},f.saveSeniorConfig=function(e){angular.extend(f.property,e);var t=p(f.property,g.pt);s.saveParameter(g,t).then(function(e){e&&f.saveCaptureInfo()})},f.showSqlPanel=function(){f.dbConf.sqlserPanel=!0,"db2"===f.dbConf.nowDB?(f.isBpz=!0,k.async.autoParam=["name=schema","gp=group","db=db_id"],k.async.otherParam={type:"table"},s.getDb2Schema(g).then(function(e){e.res&&(I=$.fn.zTree.init($("#objTreeDb2"),k,e.list))}).finally(function(){f.isBpz=!1})):l()},f.showSqlKzPanel=function(){f.dbConf.sqlActive=1,s.queryCaptureTable(g,f.data.selList).then(function(e){if(e.res){var t=_(e.info);v=$.fn.zTree.init($("#objTree1"),y,t)}})},f.saveSqlKz=function(){f.isSaving1=!0;var e=this.dbConf.nowDB;if("sqlserver"===e||"db2"===e||"mysql"===e){var t=u(),n=d(f),r=p(f.property,e);s.saveKzTable(g,f.property.captureName,n,t,r).finally(function(){f.isSaving1=!1})}},f.saveDb2Cdc=function(){if(I){f.isBpz=!0;var e=I.getCheckedNodes(!0),t=I.getCheckedNodes(!1),r=I.getNodes(),a=[],o=[],i={},c={},l=0,u=0,p=[];angular.forEach(r,function(e){e.isParent&&p.push({name:e.name,cLen:e.children.length})}),angular.forEach(p,function(t){i={select_all:"no",schema:t.name,table:[]},i.table=[],l=0,angular.forEach(e,function(e){e.isParent||i.schema===e.ps&&(i.table.push(e.name),l+=1)}),l>=t.cLen&&(i.table=[],i.select_all="yes"),(i.table.length>0||"yes"===i.select_all)&&a.push(i)}),angular.forEach(p,function(e){c={select_all:"no",schema:e.name,table:[]},c.table=[],u=0,angular.forEach(t,function(e){e.isParent||c.schema===e.ps&&(c.table.push(e.name),u+=1)}),u>=e.cLen&&(c.table=[],c.select_all="yes"),(c.table.length>0||"yes"===c.select_all)&&o.push(c)}),s.saveDb2CdcInfo(o,a,g.pn).then(function(e){e&&n.success("配置设置成功！")}).finally(function(){f.isBpz=!1})}},f.selectTbTables=function(){if(b=[],h){var e=h.getChangeCheckedNodes(),t=0,n=0,r=0;angular.forEach(e,function(e){if(1===e.level){var a={};a.name=e.name,a.table=[];var o={},s="",i=e.getParentNode().name;o.pname=i,o.name=e.name,o.checked=e.checked,r+=1,o.id="logs_"+r,o.cid="cx_"+r,s=e.checked?"add":"del",o.data='{"name":"'+i+'","table":"'+e.name+'","id":"'+o.id+'","cz":"'+s+'","cid":"'+o.cid+'"}',e.checked?t++:n++,b.push(o)}})}return f.dbConf.sqlLog.isEdit=!0,f.dbConf.sqlLog.tables=b,f.dbConf.sqlLog.totalApp=t,f.dbConf.sqlLog.totalCan=n,f.dbConf.sqlLog.appNum=0,f.dbConf.sqlLog.canNum=0,f.dbConf.sqlLog.error=0,f.dbConf.sqlLog.ckAll=!0,b},f.excuteBcLog=function(){var e=$("#sqlLogs").find("input.sqlTbCbox:checked"),t=[],r=0;if(e.length<=0)return void n.warning("请选择要执行的数据！");f.dbConf.sqlLog.excuteIng=!0,f.dbConf.sqlLog.excuteBtx="执行中...";var a=f.dbConf.sqlLog;angular.forEach(e,function(e){var n=$(e).val(),r=JSON.parse(n);t.push(r)});var o=function(){if(r===t.length&&(f.dbConf.sqlLog.excuteIng=!1,f.dbConf.sqlLog.excuteBtx="执行"),r<t.length){var e=t[r],n=e.id;s.changeExtendedLog(g,e).then(function(t){t?($("#"+n).html('<span class="text-success">成功！</span>'),"add"===e.cz?a.appNum++:a.canNum++):($("#"+n).html('<span class="text-danger">失败！</span>'),a.error++)},function(){$("#"+n).html('<span class="text-danger">失败！</span>'),a.error++}).finally(function(){r++,o()})}};t.length>0&&o()},f.qxToggle=function(){this.dbConf.sqlLog.ckAll?$("input.sqlTbCbox").prop("checked",!0):$("input.sqlTbCbox").prop("checked",!1)},f.cancelZx=function(){this.dbConf.sqlLog.isEdit=!1,l()}}]}).component("seniorPro",{templateUrl:"capture_view/seniorConfig.component.html",bindings:{superF:"<",dbType:"<",property:"<",onSave:"&",comId:"<"},controller:["$filter","$log",function(e,t){var n=this;n.params={captureName:!1,zfj:!1,xtjg:!1,cqjg:!1,scnxx:!1,racscn:!1,swc:!1,swczd:!1,ncdl:!1,lobzd:!1,gxqzd:!1,bingf:!1,bfgs:!1,skipGrant:!1,fullColUpdate:!1,onLine:!1,capId:!1,cpjg:!1,ssjg:!1,hlwgx:!1,fccl:!1,bcrztb:!1,ctbcrz:!1,zqlzz:!1,zqjg:!1},n.validErr="",n.$onInit=function(){},n.saveSeniorConfig=function(){return n.comId&&"undefined"!==n.comId?(n.validErr="",parseInt(n.property.transaction_slot_size)*parseInt(n.property.max_transaction_slot)/1024+parseInt(n.property.internal_queue_size)>1024?void(n.validErr=e("translate")("Cp_xz")):(n.validErr="",n.validErr="",void n.onSave({pro:n.property}))):void(n.validErr=e("translate")("Cp_bcgj"))}}]}).component("offlineModel",{templateUrl:"capture_view/offline.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$log",function(e){var t=this;t.$onInit=function(){t.logFx={},t.resolve.dbInfo&&(t.logFx=t.resolve.dbInfo,t.title=t.resolve.title||"离线分析主机配置")},t.ok=function(){t.close({$value:t.logFx})},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}).component("racModel",{templateUrl:"capture_view/rac.component.html",bindings:{racs:"="},controller:["$log",function(e){var t=this;t.plusRacs=function(){t.racs.push({thread:"",name:"",ip:"",port:"",enable:!1,path:""})},t.removeRacs=function(){t.racs.length>0&&t.racs.pop()}}]})}(),angular.module("myApp.queue_view",["ui.bootstrap.datetimepicker","myApp.queueComponent","myApp.queueService"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/queue_view/","/main/queue_view/status"),t.state("/.queue_view",{abstract:!0,url:"/queue_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Dl_pz")}],queueInfo:["$transition$","quService",function(e,t){var n=e.params();return n.gn&&"unnamed"!==n.cn&&n.cid?t.getQueueInfo(n):"init"}]},bindings:{title:"title"}}).state("/.queue_view.status",{url:"/status?gn&cn&pt&id&cid",component:"queueStatus",bindings:{dl:"queueInfo"}}).state("/.queue_view.property",{url:"/property?gn&cn&pt&id&cid",component:"queueProperty",bindings:{dl:"queueInfo"}})}]),function(){function e(e,t,n,r){this.getQueueInfo=function(r){
var a={group_id:r.gn,component_id:r.cid},o=null;a=n.md5Data(a);return e.postDataList("/dipserver/query_queue_info",a).then(function(e){return n.equalMd5Data(e)&&(e.status?o=e.response:t.error(e.response&&e.response.error_msg)),o})},this.saveQueueInfo=function(t,r){var a={group_id:t.gn,component_name:r.cname,queue_type:"file",size:r.size,statis:r.statis,queue_save_hour:r.hour,component_id:t.cid},o={res:!1,comId:"",msg:""};a=n.md5Data(a);return e.postDataList("/dipserver/save_queue_info",a).then(function(e){return n.equalMd5Data(e)&&(e.status?(o.res=!0,o.comId=e.response&&e.response.component_id||""):o.msg=e.response.error_msg),o})},this.deleteQueueStatis=function(a,o,s){var i={group_id:a.gn,component_id:a.cid,end_time:o,flag:s};i=n.md5Data(i);return e.postDataList("/dipserver/delete_queue_pkg_statis",i).then(function(e){n.equalMd5Data(e)&&(e.status?t.success(r("translate")("Sccg")):t.error(e.response&&e.response.error_msg))},function(){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.queueService",[]).service("quService",e),e.$inject=["httpService","tipsService","md5Service","$filter"]}(),function(){angular.module("myApp.queueComponent",[]).component("queueStatus",{templateUrl:"queue_view/status.component.html",bindings:{dl:"<"},controller:["$stateParams","$filter","$state",function(e,t,n){var r=this;r.params={qpn:!1,qpsiz:!1,qpsati:!1,qpsta:!1,qpId:!1},r.property={},r.real={com_id:"",hour:t("translate")("HOUR")},r.$onInit=function(){r.dl&&angular.isObject(r.dl)?(r.property.queue_name=r.dl.component_name,r.property.file_size=parseInt(r.dl.size)||128,r.property.save_hour=parseInt(r.dl.queue_save_hour)||48,r.property.charts=r.dl.statis?r.dl.statis:"no",r.real.com_id=e.cid):n.go("/")}}]}).component("queueProperty",{templateUrl:"queue_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","graphicService","$filter","quService",function(e,t,n,r,a,o){var s=this,i=e;s.number=0,s.data={superConfig:!1},s.params={qpn:!1,qpsiz:!1,qpsati:!1,qpsta:!1,qpId:!1},s.tj={deadline:!1,sw:!1,ct:!1,endTime:a("date")(new Date,"yyyy-MM-dd HH:mm"),sws:"no",charts:"no"},s.property={queue_name:"",file_size:128,save_hour:24,charts:"no"},s.real={com_id:""},s.isSaving=!1,s.isRemoving=!1,s.$onInit=function(){s.dl?s.dl&&angular.isObject(s.dl)&&(s.property.queue_name=s.dl.component_name,s.property.file_size=parseInt(s.dl.size)||128,s.property.save_hour=parseInt(s.dl.queue_save_hour)||48,s.property.charts=s.dl.statis?s.dl.statis:"no",s.real.com_id=i.cid):t.go("/")},s.save_queue_info=function(){var e=s.property.charts?s.property.charts:"no";if("unnamed"===s.property.queue_name)return void n.error(a("translate")("Dl_mcbnk"));var c={cname:s.property.queue_name,size:s.property.file_size,statis:e,hour:s.property.save_hour};s.isSaving=!0;var l=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),u=function(e,t){e?(l.setType("type-success"),l.getModalBody().html("保存成功！"),setTimeout(function(){l.close()},300)):(l.setType("type-danger"),t?l.getModalBody().html(t):l.getModalBody().html("保存失败！")),l.setClosable(!0)};l.open(),o.saveQueueInfo(i,c).then(function(e){if(e.res){s.real.com_id=e.comId;var n=$("#"+i.id);n.find(".dragPoint").text(s.property.queue_name),n.attr("name",s.property.queue_name),n.attr("type",i.pt),n.attr("realid",s.real.com_id),r.save_graphics_no_alert(i.gn).finally(function(){u(!0)}),t.go("/")}else u(!1,e.msg)}).catch(function(){u(!1)}).finally(function(){s.isSaving=!1})},s.removeLogData=function(){s.isRemoving=!0;var e=1;"yes"===s.tj.sws&&"yes"===s.tj.charts?e=3:("yes"===s.tj.sws&&(e=1),"yes"===s.tj.charts&&(e=2)),o.deleteQueueStatis(i,s.tj.endTime,e).finally(function(){s.isRemoving=!1})}}]})}(),function(){angular.module("myApp.loader_view",["ui.bootstrap","myApp.loaderService","myApp.loaderComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/loader_view/","/main/loader_view/status"),t.state("/.loader_view",{abstract:!0,url:"/loader_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Ld_pz")}],loaderInfo:["$transition$","ldService",function(e,t){var n=e.params();return t.getLoaderInfo(n)}]},bindings:{title:"title"}}).state("/.loader_view.status",{url:"/status?gn&cn&sn&st&tt&id&cid&cpid",component:"loaderStatus",bindings:{dl:"loaderInfo"}}).state("/.loader_view.property",{url:"/property?gn&cn&sn&st&tt&id&cid&cpid",component:"loaderProperty",bindings:{dl:"loaderInfo"}})}])}(),function(){function e(e,t,n,r){this.getLoaderInfo=function(r){var a="unnamed"===r.cn?"":r.cn,o={group_id:r.gn,component_id:r.cid,db_component_id:r.sn,db_type:r.st,type:r.tt,component_name:a,capture_id:r.cpid},s=null;return o=n.md5Data(o),e.postDataList("/dipserver/query_apply_config",o).then(function(e){return n.equalMd5Data(e)&&(e.status?s=e.response:t.error(e.response&&e.response.error_msg)),s})},this.createApplyTreeList=function(e){var t=[],n=[],r=[],a="/img/ico/";t=function(e){var t=[],n=[];return angular.isArray(e)?n=e:n.push(e),angular.forEach(n,function(e){var n={};n.name=e.name,n.checked=!1,n.type="user",n.icon=a+"schema.png",n.children=[],t[t.length]=n;var r=n.children;if(e.object_type){var o=[];angular.isArray(e.object_type)?o=e.object_type:o.push(e.object_type),angular.forEach(o,function(e){var t={};t.name=e.name,t.checked=!1,t.type="object_type",t.children=[],t.icon=a+"object_type.png",r[r.length]=t;var n=t.children;if(e.object){var o=[];angular.isArray(e.object)?o=e.object:o.push(e.object),angular.forEach(o,function(e){var t={};t.name=e.name,t.checked=!1,t.type="object",t.icon=a+"object.png",n[n.length]=t})}})}}),t}(e.objects.user);var o=function(e){var t=[];if(e.schema){var n=[];return angular.isArray(e.schema)?n=e.schema:n.push(e.schema),angular.forEach(n,function(e){var n,r=[],o=e.name,s=e.mapping_name;if(s?(n={},n.name=o,n.checked=!0,n.replace_schema=s,n.type="user",n.icon=a+"replace_schema.png",n.children=[],t[t.length]=n,r=n.children):(n={},n.name=o,n.checked=!0,n.replace_schema=null,n.type="user",n.icon=a+"schema.png",n.children=[],t[t.length]=n,r=n.children),e.object_type){var i=[];angular.isArray(e.object_type)?i=e.object_type:i.push(e.object_type),angular.forEach(i,function(e){var t={};t.name=e.name,t.checked=!0,t.type="object_type",t.icon=a+"object_type.png",t.children=[],r[r.length]=t;var n=t.children;if(e.object){var o=[];angular.isArray(e.object)?o=e.object:o.push(e.object),angular.forEach(o,function(e){var t={},r=e.name,o=e.mapping_name;o?(t.name=r,t.checked=!0,t.replace_object=o,t.type="object",t.icon=a+"replace_object.png",n[n.length]=t):(t.name=r,t.checked=!0,t.replace_object=null,t.type="object",t.icon=a+"object.png",n[n.length]=t)})}})}}),t}};return angular.forEach(e.filters.filter,function(e){"INCLUDE"===e.filter_type?n=o(e):"EXCLUDE"===e.filter_type&&(r=o(e))}),{all:t,include:n,exclude:r}},this.getObjectDataList=function(a,o,s){var i={group_id:a.gn,type:a.st,db_component_id:a.sn,object_type:o.name,owner:s},c={res:!1,newArr:[],oldArr:[]};i=n.md5Data(i);var l=[];return e.postDataList("/dipserver/query_apply_sourcedb_object",i).then(function(e){if(n.equalMd5Data(e))if(e.status){if(!e.response||!e.response.objects)return c;var r=[],a=o.manual.isall,s=e.response.objects.object;angular.isArray(s)?r=s:r.push(s),!0===a?angular.forEach(r,function(e){l[l.length]={name:e,checked:!1,replace_object:null}}):angular.forEach(r,function(e){var t=null;angular.forEach(o.manual.children,function(n){e===n.name&&(t=n)}),l[l.length]=null!==t?{name:t.name,checked:t.checked,replace_object:t.replace_object}:{name:e,checked:!1,replace_object:null}});var i=[];o.manual&&angular.isArray(o.manual.children)&&(i=o.manual.children),c.res=!0,c.newArr=l,c.oldArr=i}else t.error(e.response.error_msg);return c},function(e){t.error(r("translate")("Wlcw"))})},this.saveLoaderInfo=function(t,r,a,o){var s={group_id:t.gn,db_component_id:t.sn,component_name:r,type:t.st,filters:{filter:a},parameter:o,component_id:t.cid},i={res:!1,comId:"",msg:""};return s=n.md5Data(s),e.postDataList("/dipserver/add_apply_config",s,0).then(function(e){return n.equalMd5Data(e)&&(e.status?(i.res=!0,i.comId=e.response&&e.response.component_id||""):i.msg=e.response.error_msg),i})},this.saveLoaderSuperProperty=function(a,o){var s={group_id:a.gn,component_id:a.cid,parameter:o},i=!1;s=n.md5Data(s);return e.postDataList("/dipserver/add_apply_property",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(t.success(r("translate")("Bccg")),i=!0):t.error(e.response.error_msg)),i},function(e){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.loaderService",[]).service("ldService",e),e.$inject=["httpService","tipsService","md5Service","$filter"]}(),function(){angular.module("myApp.loaderComponent",["rx"]).component("loaderStatus",{templateUrl:"loader_view/status.component.html",bindings:{dl:"<"},controller:["$stateParams","$filter","$state","ldService","$timeout",function(e,t,n,r,a){var o=this,s=e,i={zTree_inc:null,zTree_inc_nodes:[],zTree_exc:null,zTree_exc_nodes:[],zTree_all_nodes:[],zTree_all:null,setting:{showLine:!0,check:{enable:!0},edit:{enable:!0}},setting1:{showLine:!0,check:{enable:!1},edit:{enable:!1}}};o.property={},o.data={loaderName:"",superConfig:!1,include_empty:!0,exclude_empty:!0,include_panel:!0,exclude_panel:!1,dbType:"oracle",isCom:!0},o.params={loaderName:!1,tg_tag:!1,cw_clfs:!1,zd_xfsb:!1,wz_cwcl:!1,dt_zx:!1,jy_syzd:!1,sj_nchar:!1,hl_ddl:!1,pltj:!1,client:!1,c_nchar:!1,clob:!1,sj_nclob:!1,ysj_zfj:!1,sz_tag:!1,hl_ddsj:!1,hl_wxg_zd:!1,lodId:!1,zdkx_sj:!1,sqlm:!1},o.real={com_id:"",zdcl:t("translate")("Ld_zdcl"),rgcl:t("translate")("Ld_rgcl"),hl:t("translate")("HL"),bhl:t("translate")("BHL"),jy:t("translate")("JY"),bjy:t("translate")("BJY")},o.$onInit=function(){if(o.dl&&angular.isObject(o.dl)){var e=r.createApplyTreeList(o.dl);e.include&&e.include.length>0&&(o.data.include_empty=!1,i.zTree_inc_nodes=e.include),e.exclude&&e.exclude.length>0&&(o.data.exclude_empty=!1,i.zTree_exc_nodes=e.exclude);var t=o.dl.parameter;o.property.tag_skip=t.tag_skip||"no",o.property.error_auto=t.error_auto||"yes",o.property.user_handle_name=t.user_handle_name||"skip_recode",o.property.skip_record="yes",o.property.exclude_table="no",o.property.unknown_error=t.unknown_error||"skip",o.property.execute_one=t.execute_one||"no",o.property.ddl_skip=t.ddl_skip||"no",o.property.batch_commit=t.batch_commit||"yes",o.property.source_metadata_charset=t.source_metadata_charset||"",o.property.set_tag=t.set_tag||"no",o.property.dip_nls_lang=t.dip_nls_lang||"",o.property.dip_nchar_charset=t.dip_nchar_charset||"",o.property.lob_skip=t.lob_skip||"no",o.property.idle_connect_seconds=parseInt(t.idle_connect_seconds)?parseInt(t.idle_connect_seconds):0,o.property.not_changeskip=t.not_changeskip||"no",o.property.check_old_image=t.check_old_image||"yes",o.property.use_merge_sql=t.use_merge_sql||"no",o.property.source_nchar_charset=t.source_nchar_charset||"",o.property.source_clob_charset=t.source_clob_charset||"",o.property.source_nclob_charset=t.source_nclob_charset||"",o.data.isCom=s.st!==s.tt,"oracle"===s.st?o.data.dbType="oracle":"sqlserver"===s.st?o.data.dbType="sqlserver":(s.st,o.data.dbType="mysql"),o.property.restart||(o.property.restart="no"),o.property.not_changeskip||(o.property.not_changeskip="yes"),""!==s.cn?o.data.loaderName="unnamed"!==s.cn?s.cn:"":o.data.loaderName="","undefined"!==s.cid&&s.cid&&(o.real.com_id=s.cid),a(function(){i.zTree_exc=$.fn.zTree.init($("#loaderExcTreeId"),i.setting1,i.zTree_exc_nodes),i.zTree_inc=$.fn.zTree.init($("#loaderIncTreeId"),i.setting1,i.zTree_inc_nodes)})}else n.go("/")}}]}).component("loaderProperty",{templateUrl:"loader_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","$filter","graphicService","ldService","$timeout","$scope","rx","$uibModal",function(e,t,n,r,a,o,s,i,c,l){function u(e){var t=[],n={},r={},a=e.zTree_inc.getCheckedNodes(!0);n.filter_type="INCLUDE",n.schema=[],angular.forEach(a,function(e){var t={};if(0===e.level){e.replace_schema?(t.name=e.name,t.mapping_name=e.replace_schema):t.name=e.name,t.object_type=[];var r=e.children;r||(r=[]),angular.forEach(r,function(e){if(!0===e.checked){var n={};n.name=e.name,n.object=[];var r=e.children;r||(r=[]),angular.forEach(r,function(e){if(!0===e.checked){var t={};e.replace_object?(t.name=e.name,t.mapping_name=e.replace_object):t.name=e.name,e.isNew&&(t.isNew=e.isNew),n.object.push(t)}}),t.object_type.push(n)}}),n.schema.push(t)}}),t.push(n);var o=e.zTree_exc.getCheckedNodes(!0);return r.filter_type="EXCLUDE",r.schema=[],angular.forEach(o,function(e){var t={};if(0===e.level){e.replace_schema?(t.name=e.name,t.mapping_name=e.replace_schema):t.name=e.name;var n=e.children;n||(n=[]),t.object_type=[],angular.forEach(n,function(e){if(!0===e.checked){var n={};n.name=e.name,n.object=[];var r=e.children;r||(r=[]),angular.forEach(r,function(e){if(!0===e.checked){var t={};e.replace_object?(t.name=e.name,t.mapping_name=e.replace_object):t.name=e.name,e.isNew&&(t.isNew=e.isNew),n.object.push(t)}}),t.object_type.push(n)}}),r.schema.push(t)}}),t.push(r),t}function p(){return g.data.isCom?{tag_skip:g.property.tag_skip,error_auto:g.property.error_auto,check_old_image:g.property.check_old_image,ddl_skip:g.property.ddl_skip,batch_commit:g.property.batch_commit,dip_nls_lang:g.property.dip_nls_lang,exclude_table:g.data.exclude_table,unknown_error:g.property.unknown_error,execute_one:g.property.execute_one,use_merge_sql:g.property.use_merge_sql}:"oracle"===h.st?{tag_skip:g.property.tag_skip,error_auto:g.property.error_auto,check_old_image:g.property.check_old_image,ddl_skip:g.property.ddl_skip,batch_commit:g.property.batch_commit,set_tag:g.property.set_tag,lob_skip:g.property.lob_skip,restart:g.property.restart,source_nchar_charset:g.property.source_nchar_charset,source_clob_charset:g.property.source_clob_charset,source_nclob_charset:g.property.source_nclob_charset,source_metadata_charset:g.property.source_metadata_charset,dip_nchar_charset:g.property.dip_nchar_charset,dip_nls_lang:g.property.dip_nls_lang,exclude_table:g.data.exclude_table,unknown_error:g.property.unknown_error,execute_one:g.property.execute_one,idle_connect_seconds:g.property.idle_connect_seconds,use_merge_sql:g.property.use_merge_sql}:"sqlserver"===h.st?{tag_skip:g.property.tag_skip,error_auto:g.property.error_auto,check_old_image:g.property.check_old_image,ddl_skip:g.property.ddl_skip,batch_commit:g.property.batch_commit,set_tag:g.property.set_tag,lob_skip:g.property.lob_skip,exclude_table:g.data.exclude_table,execute_one:g.property.execute_one,not_changeskip:g.property.not_changeskip,unknown_error:g.property.unknown_error,skip_record:g.data.skip_record}:{tag_skip:g.property.tag_skip,error_auto:g.property.error_auto,check_old_image:g.property.check_old_image,ddl_skip:g.property.ddl_skip,batch_commit:g.property.batch_commit,dip_nls_lang:g.property.dip_nls_lang,exclude_table:g.data.exclude_table,unknown_error:g.property.unknown_error,execute_one:g.property.execute_one,use_merge_sql:g.property.use_merge_sql}}function d(e,t){var n=[],r="/img/ico/";if(e)return angular.forEach(e,function(e,a){var o=null,s={};if(angular.forEach(t,function(t){e.name===t.name&&(o=t)}),null!==o){s.name=o.name,o.replace_schema?s.icon=r+"replace_schema.png":s.icon=r+"schema.png",s.replace_schema=o.replace_schema,s.checked=!0,s.type="user",s.open=0===a,s.select_all=0===o.children.length,s.children=[];var i=s.children;if(!e.children)return;angular.forEach(e.children,function(e){var t=null,n={};if(angular.forEach(o.children,function(n){e.name===n.name&&(t=n)}),n.name=e.name,n.type=e.type,n.icon=r+"object_type.png",null!==t){if(n.checked=!0,n.manual={children:[],isall:!1},!t.children)return;angular.forEach(t.children,function(e){n.manual.children[n.manual.children.length]={name:e.name,replace_object:e.replace_object,checked:!0,isNew:!!e.isNew&&e.isNew}})}else n.checked=!1,n.manual={children:[],isall:!0};n.children=[],i[i.length]=n})}else{s.name=e.name,s.replace_schema=null,s.checked=!1,s.type="user",s.icon=r+"schema.png",s.children=[];var c=s.children;if(!e.children)return;angular.forEach(e.children,function(e){var t={};t.name=e.name,t.checked=s.checked,t.type=e.type,t.icon=e.icon,t.children=[],c[c.length]=t,t.manual={children:[],isall:!1},e.children&&angular.forEach(e.children,function(e){t.manual.children[t.manual.children.length]={name:e.name,replace_object:e.replace_object,checked:!1,isNew:!!ccl.isNew&&ccl.isNew}})})}if(n[n.length]=s,0===n.length){if(!t)return;angular.forEach(t,function(e){var t=e,a={};a.name=t.name,a.replace_schema=t.replace_schema,a.checked=!0,a.type="user",a.icon=r+"replace_schema.png",a.children=[],n[n.length]=a;var o=a.children;e.children&&angular.forEach(e.children,function(e){var t={};t.name=e.name,t.checked=a.checked,t.type=e.type,t.icon=e.icon,t.children=[],o[o.length]=t,e.children&&(0===e.children.length&&!0===e.checked?t.manual={children:[],isall:!0}:(t.manual={children:[],isall:!1},angular.forEach(e.children,function(e){t.manual.children[t.manual.children.length]={name:e.name,replace_object:e.replace_object,checked:!0,isNew:!!ccl.isNew&&ccl.isNew}})))})})}}),n}function m(e,t){i.$apply(function(){t.schemaPanel=!0,t.oldSchema=e.name,t.newSchema=e.replace_schema&&e.replace_schema.length>0?e.replace_schema:"",t.schemaList.length=0,angular.isArray(e.children)&&angular.forEach(e.children,function(e){t.schemaList.push(e)})})}function _(e,t,n,r){n.schemaPanel=!1,n.userType=e.name,n.userList=[],1===r?k=[]:I=[],$("#incSearchBox").val(""),$("#excSearchBox").val("");var a=e.getParentNode().name;n.loading=!0,o.getObjectDataList(t,e,a).then(function(e){if(n.loading=!1,e.res){var t=0,a=[],o=[];angular.forEach(e.newArr,function(n,r){var o=n.replace_object?n.replace_object:"",s={id:r,name:n.name,checked:n.checked,rname:o,isNew:!1};angular.forEach(e.oldArr,function(e){e.name===n.name&&(s.checked=e.checked,s.rname=e.replace_object?e.replace_object:"")}),s.checked||t++,a.push(s)}),angular.forEach(e.oldArr,function(e){if(e.isNew){var t=e.replace_object?e.replace_object:"";o.push({id:1,name:e.name,checked:e.checked,rname:t,isNew:!0})}}),o=o.concat(a),angular.forEach(o,function(e,t){e.id=t,1===r?k.push(e.name):D.push(e.name)}),n.userList=o,1===r?(x=$.extend(n.userList,[]),g.pageInc.currentPage=1,g.pageInc.totalPage=Math.ceil(x.length/g.pageInc.pageSize)):(I=$.extend(n.userList,[]),g.pageExc.currentPage=1,g.pageExc.totalPage=Math.ceil(I.length/g.pageExc.pageSize)),n.userCkAll=0===t}},function(){n.loading=!1})}function f(e){var t=[],n="/img/ico/",r=e.getCheckedNodes(!0),a=function(e,t){var r="",a={},o=e.rname||e.replace_object||"";o?(r=n+"replace_object.png",a.replace_object=o):r=n+"object.png",a.isNew=!!e.isNew&&e.isNew,a.name=e.name,a.type="object",a.icon=r,a.checked=!0,t[t.length]=a};return angular.forEach(r,function(e){if("user"===e.type){var r={};r.name=e.name,r.type=e.type,r.icon=e.icon,r.checked=!0,r.children=[],e.replace_schema?(r.replace_schema=e.replace_schema,r.icon=n+"replace_schema.png"):(r.replace_schema="",r.icon=n+"schema.png"),t[t.length]=r;var o=r.children;e.select_all||angular.forEach(e.children,function(e){if(e.checked){var t={};t.name=e.name,t.type=e.type,t.icon=e.icon,t.checked=!0,t.children=[],o[o.length]=t;var n=t.children;e.manual&&angular.isArray(e.manual.children)&&angular.forEach(e.manual.children,function(e){a(e,n)})}})}}),t}var g=this,h=e;g.number=0,g.data={superConfig:!1,include_panel:!0,exclude_panel:!1,include_empty:!0,exclude_empty:!0,inc_edit:!1,inc_edit_txt:r("translate")("EDIT"),exc_edit:!1,exc_edit_txt:r("translate")("EDIT"),loaderName:"",skip_record:"yes",exclude_table:"no",inc_qr_txt:r("translate")("OK"),exc_qr_txt:r("translate")("OK"),dbType:"oracle",isCom:!0},g.params={loaderName:!1,lodTag:!1,lodWay:!1,lodRepair:!1,lodError:!1,loadSin:!1,lodUp:!1,lodDdl:!1,lodSub:!1,lodCliChar:!1,loadCliNchar:!1,lodDataNchar:!1,lodDataClob:!1,lodDataNclob:!1,lodEle:!1,loadIsTag:!1,loadIsIgn:!1,lodIsRes:!1,lodIsIgnNum:!1,zdkx_sj:!1,zdxfs:!1,wzcwd:!1,lodId:!1,hlwgx:!1,sqlm:!1},g.property={error_auto:"no",set_tag:"no",skip_record:"yes",exclude_table:"no"},g.superCon={oldSchema:"",newSchema:"",schemaList:[],userType:"",userSearch:"",userCkAll:!1,userList:[],schemaPanel:!0,loading:!1,pageCkAll:!1,selList:[]},g.superConExc={oldSchema:"",newSchema:"",schemaList:[],userType:"",userSearch:"",userCkAll:!1,userList:[],schemaPanel:!0,loading:!1,pageCkAll:!1,selList:[]};var v={zTree_inc:null,zTree_inc_nodes:[],zTree_exc:null,zTree_exc_nodes:[],zTree_all_nodes:[],zTree_all:null,setting:{showLine:!0,check:{enable:!0},edit:{enable:!0}},setting1:{showLine:!0,check:{enable:!1},edit:{enable:!1}}};g.real={com_id:""},g.isSaving=!1;var b=r("translate")("SAVE"),y=r("translate")("SAVING");g.saveBtnTxt=b,g.totalDisplayed=50,g.pageInc={currentPage:1,pageSize:g.totalDisplayed,totalPage:1,pDis:!1,nDis:!1},g.pageExc={currentPage:1,pageSize:g.totalDisplayed,totalPage:1,pDis:!1,nDis:!1};var w,x=[],I=[],k=[],D=[],E=c.Observable.create(function(e){w=e}),S={edit:r("translate")("EDIT"),close:r("translate")("CLOSE"),ok:r("translate")("OK"),clz:r("translate")("RUNNING")};g.$onInit=function(){if(g.dl&&angular.isObject(g.dl)){var e=o.createApplyTreeList(g.dl);e.include&&e.include.length>0&&(g.data.include_empty=!1,v.zTree_inc_nodes=e.include),e.exclude&&e.exclude.length>0&&(g.data.exclude_empty=!1,v.zTree_exc_nodes=e.exclude),v.zTree_all_nodes=e.all,g.dl.parameter.idle_connect_seconds=g.dl.parameter.idle_connect_seconds?0:g.dl.parameter.idle_connect_seconds;var n=g.dl.parameter;g.property.tag_skip=n.tag_skip||"no",g.property.error_auto=n.error_auto||"yes",g.property.user_handle_name=n.user_handle_name||"skip_recode",g.property.skip_record="yes",g.property.exclude_table="no",g.property.unknown_error=n.unknown_error||"skip",g.property.execute_one=n.execute_one||"no",g.property.ddl_skip=n.ddl_skip||"no",g.property.batch_commit=n.batch_commit||"yes",g.property.source_metadata_charset=n.source_metadata_charset||"",g.property.set_tag=n.set_tag||"no",g.property.dip_nls_lang=n.dip_nls_lang||"",g.property.dip_nchar_charset=n.dip_nchar_charset||"",g.property.lob_skip=n.lob_skip||"no",g.property.idle_connect_seconds=parseInt(n.idle_connect_seconds)?parseInt(n.idle_connect_seconds):0,g.property.not_changeskip=n.not_changeskip||"no",g.property.check_old_image=n.check_old_image||"yes",g.property.use_merge_sql=n.use_merge_sql||"no",g.property.source_nchar_charset=n.source_nchar_charset||"",g.property.source_clob_charset=n.source_clob_charset||"",g.property.source_nclob_charset=n.source_nclob_charset||"",g.data.isCom=h.st!==h.tt,"oracle"===h.st?g.data.dbType="oracle":"sqlserver"===h.st?g.data.dbType="sqlserver":"mysql"===h.st?g.data.dbType="mysql":g.data.dbType=h.st,g.property.restart||(g.property.restart="no"),g.property.not_changeskip||(g.property.not_changeskip="yes"),g.property.idle_connect_seconds||(g.property.idle_connect_seconds=0),""!==h.cn?g.data.loaderName="unnamed"!==h.cn?h.cn:"":g.data.loaderName="","undefined"!==h.cid&&h.cid&&(g.real.com_id=h.cid),s(function(){v.zTree_exc=$.fn.zTree.init($("#loaderExcTreeId"),v.setting1,v.zTree_exc_nodes),v.zTree_inc=$.fn.zTree.init($("#loaderIncTreeId"),v.setting1,v.zTree_inc_nodes)})}else t.go("/")},g.itemDesc=function(e){angular.forEach(g.params,function(t,n){if("all"===e)!0;else if("none"===e)!1;else if(n===e)return!0,!1})};var T=[],C=[],L=null,q=null,A=null,M=null,z=function(e,t){var n=v.zTree_all.getSelectedNodes()[0];if((n=t||n)&&"object_type"===n.type){var r=[],a=0,o=n.getParentNode().name,s=e.userList.length;angular.forEach(e.userList,function(e){e.checked&&(e.pname=o,e.replace_object=e.rname,e.isNew=!!e.isNew&&e.isNew,r.push(e),a++)}),s===a?n.select_all=!0:(n.select_all=!1,n.manual&&(n.manual.children=r))}},P=function(e,t){var n=v.zTree_all.getSelectedNodes()[0];(n=n||t)&&"user"===n.type&&(n.replace_schema=e.newSchema)};g.editIncConfig=function(){if(this.data.inc_edit=!this.data.inc_edit,this.data.inc_edit_txt=this.data.inc_edit_txt===S.edit?S.close:S.edit,this.data.inc_qr_txt=this.data.inc_qr_txt===S.clz?S.ok:S.clz,$("#incSearchBox").val(""),g.superCon.schemaPanel=!1,g.superCon.userList=[],this.data.inc_edit){var e={showLine:!0,check:{enable:!0},callback:{onClick:function(e,t,n){"user"===n.type?(L=n,m(n,g.superCon)):"object_type"===n.type?(A=n,i.$apply(function(){_(n,h,g.superCon,1)})):n.type},onCheck:function(e,t,n){},beforeClick:function(){i.$apply(function(){P(g.superCon,L),z(g.superCon,A)})}}},t=[];t=T.length>0?d(v.zTree_all_nodes,T):d(v.zTree_all_nodes,v.zTree_inc_nodes),v.zTree_all=$.fn.zTree.init($("#loaderIncEditTreeId"),e,t);var n=v.zTree_all.getCheckedNodes(!0);angular.forEach(n,function(e){"user"===e.type&&e.name===g.superCon.oldSchema&&(L=e)})}},g.saveFilterTree=function(){$("#incSearchBox").val(""),g.superCon.userList=angular.copy(x),z(g.superCon,A),P(g.superCon,L);var e=f(v.zTree_all);T=e,this.data.inc_edit=!1,this.data.inc_edit_txt=S.edit,this.data.inc_qr_txt=S.clz,g.superCon.schemaPanel=!1,e.length>0?(v.zTree_inc_nodes=e,v.zTree_inc=$.fn.zTree.init($("#loaderIncTreeId"),v.setting1,e),g.data.include_empty=!1):(v.zTree_inc_nodes=[],v.zTree_inc=$.fn.zTree.init($("#loaderIncTreeId"),v.setting1,e),g.data.include_empty=!0)},g.exitFilterTree=function(){$("#incSearchBox").val(""),this.data.inc_edit=!1,g.superCon.schemaPanel=!1,this.data.inc_edit_txt=S.edit},g.ckAll=function(){angular.forEach(x,function(e){e.checked=g.superCon.userCkAll}),g.superCon.userList=angular.copy(x),$("input:checkbox.loader-inc-box").each(function(e,t){$(t).prop("checked",g.superCon.userCkAll)})},g.ckPageAll=function(){var e=g.superCon.pageCkAll;angular.forEach(g.superCon.selList,function(t){g.superCon.userList[t.id].checked=e,x[t.id].checked=e}),$("input:checkbox.loader-inc-box").each(function(t,n){$(n).prop("checked",e)})},g.changeIncItem=function(e,t){w.next({id:e.id,val:t.target.value,type:1})},g.changeIncCk=function(e,t){var n=$(t.target).prop("checked");n||(g.superCon.userCkAll=!1),g.superCon.userList[e.id]&&(g.superCon.userList[e.id].checked=n,x[e.id].checked=n)},g.changeExcCk=function(e,t){var n=$(t.target).prop("checked");n||(g.superConExc.userCkAll=!1),g.superConExc.userList[e.id]&&(g.superConExc.userList[e.id].checked=n,I[e.id].checked=n)},g.pageIncPre=function(){if(g.pageInc.currentPage<=1)return void(g.pageInc.pDis=!0);g.pageInc.nDis=!1,g.pageInc.pDis=!1,g.superCon.pageCkAll=!1,g.pageInc.currentPage=g.pageInc.currentPage-1},g.pageIncNext=function(){if(g.pageInc.currentPage>g.superCon.userList.length/g.pageInc.pageSize)return void(g.pageInc.nDis=!0);g.pageInc.nDis=!1,g.pageInc.pDis=!1,g.superCon.pageCkAll=!1,g.pageInc.currentPage=g.pageInc.currentPage+1},g.changePage=function(){var e=parseInt(g.pageInc.currentPage);e?(e<1&&(g.pageInc.currentPage=1),e>g.superCon.userList.length/g.pageInc.pageSize&&(g.pageInc.currentPage=Math.ceil(g.superCon.userList.length/g.pageInc.pageSize))):g.pageInc.currentPage=1},g.isIncCheck=function(e){var t=0;e.checked?(angular.forEach(g.superCon.selList,function(e){e.checked&&t++}),t===g.superCon.userList.length&&(g.superCon.userCkAll=!0)):g.superCon.userCkAll=!1},g.editExcConfig=function(){if(this.data.exc_edit=!this.data.exc_edit,this.data.exc_edit_txt=this.data.exc_edit_txt===S.edit?S.close:S.edit,this.data.exc_qr_txt=this.data.exc_qr_txt===S.clz?S.ok:S.clz,$("#excSearchBox").val(""),g.superConExc.schemaPanel=!1,g.superConExc.userList=[],this.data.exc_edit){var e={showLine:!0,check:{enable:!0},callback:{onClick:function(e,t,n){"user"===n.type?(q=n,m(n,g.superConExc)):"object_type"===n.type?(M=n,i.$apply(function(){_(n,h,g.superConExc,2)})):n.type},onCheck:function(e,t,n){},beforeClick:function(){i.$apply(function(){P(g.superConExc,q),z(g.superConExc,M)})}}},t=[];t=C.length>0?d(v.zTree_all_nodes,C):d(v.zTree_all_nodes,v.zTree_exc_nodes),v.zTree_all=$.fn.zTree.init($("#loaderExcEditTreeId"),e,t);var n=v.zTree_all.getCheckedNodes(!0);angular.forEach(n,function(e){"user"===e.type&&e.name===g.superConExc.oldSchema&&(q=e)})}},g.saveFilterExcTree=function(){$("#excSearchBox").val(""),g.superConExc.userList=angular.copy(I),z(g.superConExc,M),P(g.superConExc,q);var e=f(v.zTree_all);C=e,this.data.exc_edit=!1,this.data.exc_edit_txt=S.edit,this.data.exc_qr_txt=S.clz,g.superConExc.schemaPanel=!1,e.length>0?(v.zTree_exc_nodes=e,v.zTree_exc=$.fn.zTree.init($("#loaderExcTreeId"),v.setting1,e),g.data.exclude_empty=!1):(v.zTree_exc_nodes=[],v.zTree_exc=$.fn.zTree.init($("#loaderExcTreeId"),v.setting1,e),g.data.exclude_empty=!0)},g.exitFilterExcTree=function(){$("#excSearchBox").val(""),g.superConExc.schemaPanel=!0,g.data.exc_edit=!1,g.data.exc_edit_txt=S.edit},g.ckExcAll=function(){angular.forEach(I,function(e){e.checked=g.superConExc.userCkAll}),g.superConExc.userList=angular.copy(I),$("input:checkbox.loader-exc-box").each(function(e,t){$(t).prop("checked",g.superConExc.userCkAll)})},g.ckExcPageAll=function(){angular.forEach(g.superConExc.selList,function(e){g.superConExc.userList[e.id]&&(g.superConExc.userList[e.id].checked=g.superConExc.pageCkAll,I[e.id].checked=g.superConExc.pageCkAll)}),$("input:checkbox.loader-exc-box").each(function(e,t){$(t).prop("checked",g.superConExc.pageCkAll)})},g.pageExcPre=function(){if(g.pageExc.currentPage<=1)return void(g.pageExc.pDis=!0);g.pageExc.nDis=!1,g.pageExc.pDis=!1,g.superConExc.pageCkAll=!1,g.pageExc.currentPage=g.pageExc.currentPage-1},g.pageExcNext=function(){if(g.pageExc.currentPage>g.superConExc.userList.length/g.pageExc.pageSize)return void(g.pageExc.nDis=!0);g.pageExc.nDis=!1,g.pageExc.pDis=!1,g.superConExc.pageCkAll=!1,g.pageExc.currentPage=g.pageExc.currentPage+1},g.changeExcPage=function(){var e=parseInt(g.pageExc.currentPage);e?(e<1&&(g.pageExc.currentPage=1),e>g.superConExc.userList.length/g.pageExc.pageSize&&(g.pageExc.currentPage=Math.ceil(g.superConExc.userList.length/g.pageExc.pageSize))):g.pageExc.currentPage=1},g.filterIncList=function(e){w.next({val:e.target.value,type:2})},g.filterExcList=function(e){w.next({val:e.target.value,type:3})},g.isExcCheck=function(e){var t=0;e.checked?(angular.forEach(g.superConExc.selList,function(e){e.checked&&t++}),t===g.superConExc.userList.length&&(g.superConExc.userCkAll=!0)):g.superConExc.userCkAll=!1},g.showObjectIncInfo=function(e){P(g.superCon,L),z(g.superCon,A),A=e,v.zTree_all.selectNode(e),_(e,h,g.superCon,1)},g.showObjectExcInfo=function(e){P(g.superConExc,q),z(g.superConExc,M),M=e,v.zTree_all.selectNode(e),_(e,h,g.superConExc,2)},g.saveLoaderInfo=function(){var e=u(v),s=p();if("unnamed"===g.data.loaderName)return void n.error(r("translate")("Ld_mcbnk"));g.isSaving=!0,g.saveBtnTxt=y;var i=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),c=function(e,t){e?(i.setType("type-success"),i.getModalBody().html("保存成功！"),setTimeout(function(){i.close()},300)):(i.setType("type-danger"),t?i.getModalBody().html(t):i.getModalBody().html("保存失败！")),i.setClosable(!0)};i.open(),o.saveLoaderInfo(h,g.data.loaderName,e,s).then(function(e){if(e.res){g.real.com_id=e.comId;var n=$("#"+h.id);n.find(".dragPoint").text(g.data.loaderName),n.attr("name",g.data.loaderName),n.attr("type",h.st),n.attr("realid",g.real.com_id),a.save_graphics_no_alert(h.gn).finally(function(){c(!0)}),t.go("/")}else c(!1,e.msg)}).catch(function(){c(!1)}).finally(function(){g.isSaving=!1,g.saveBtnTxt=b})},g.saveLoaderProperty=function(){if(""===g.real.com_id)return void n.error(r("translate")("Cp_bcgj"));var e=p();o.saveLoaderSuperProperty(h,e).then(function(e){e&&t.go("/")})},g.errHandler=function(){"yes"===this.property.error_auto&&g.autoXf()},g.autoXf=function(){"skip_recode"===this.property.user_handle_name&&(this.data.skip_record="yes",this.data.exclude_table="no"),"exclude_table"===this.property.user_handle_name&&(this.data.skip_record="no",this.data.exclude_table="yes")},g.openCustomPanel=function(e){1===e?$("#incSearchBox").val()&&($("#incSearchBox").val(""),g.superCon.userList=angular.copy(x),g.pageInc.currentPage=1,
g.pageInc.totalPage=Math.ceil(x.length/g.totalDisplayed)):$("#excSearchBox").val()&&($("#excSearchBox").val(""),g.superConExc.userList=angular.copy(I),g.pageExc.currentPage=1,g.pageExc.totalPage=Math.ceil(I.length/g.totalDisplayed)),l.open({component:"customTableModal",size:"md"}).result.then(function(t){var n=[],r=[];t&&t.length>0&&(1===e?(angular.forEach(t,function(e,t){var r=k.indexOf(e);r>=0&&x[r]?x[r].checked=!0:n.push({id:t,name:e,checked:!0,rname:"",isNew:!0})}),r=n.concat(x),k=[],angular.forEach(r,function(e,t){e.id=t,k.push(e.name)}),g.superCon.userList=r,x=$.extend(r,[]),g.pageInc.currentPage=1,g.pageInc.totalPage=Math.ceil(r.length/g.totalDisplayed)):(angular.forEach(t,function(e,t){var r=D.indexOf(e);r>=0&&I[r]?I[r].checked=!0:n.push({id:t,name:e,checked:!0,rname:"",isNew:!0})}),r=n.concat(I),D=[],angular.forEach(r,function(e,t){e.id=t,D.push(e.name)}),g.superConExc.userList=r,I=$.extend(r,[]),g.pageExc.currentPage=1,g.pageExc.totalPage=Math.ceil(r.length/g.totalDisplayed)))})},E.debounce(300).subscribe(function(e){var t=[];1===e.type?g.superCon.userList[e.id]&&(g.superCon.userList[e.id].rname=e.val,x[e.id].rname=e.val):2===e.type?(t=[],e.val.length>0?":ck"===e.val?angular.forEach(x,function(e){e.checked&&t.push(e)}):angular.forEach(x,function(n){n.name.toLowerCase().indexOf(e.val.toLowerCase())>=0&&t.push(n)}):t=angular.copy(x),i.$apply(function(){g.pageInc.currentPage=1,g.superCon.userList=t,g.pageInc.totalPage=Math.ceil(t.length/g.pageInc.pageSize)})):3===e.type&&(t=[],e.val.length>0?":ck"===e.val?angular.forEach(I,function(e){e.checked&&t.push(e)}):angular.forEach(I,function(n){n.name.toLowerCase().indexOf(e.val.toLowerCase())>=0&&t.push(n)}):t=angular.copy(I),i.$apply(function(){g.pageExc.currentPage=1,g.superConExc.userList=t,g.pageExc.totalPage=Math.ceil(t.length/g.pageExc.pageSize)}))}),g.$onDestroy=function(){E=null}}]}).component("customTableModal",{templateUrl:"loader_view/customTables.html",bindings:{close:"&",dismiss:"&"},controller:[function(){var e=this;e.handle={loading:!1,newStr:"",newList:[]},e.$onInit=function(){},e.saveCustoms=function(){var t=e.handle.newStr.replace(/[\r\n,]/g,",").replace(/\s/g,"").split(","),n=[];angular.forEach(t,function(e){e&&n.push(e)}),e.close({$value:n})},e.cancel=function(){e.dismiss({$value:"cancel"})}}]})}(),function(){angular.module("myApp.ful_syc_view",["myApp.fullSycService","myApp.fullSycComponent"]).config(["$urlServiceProvider","$stateProvider",function(e,t){e.rules.when("/main/full_syc_view","/main/full_syc_view/loader"),t.state("/.full_syc_view",{url:"/full_syc_view",component:"parentView",abstract:!0,resolve:{status:["$transition$","fullSycService",function(e,t){var n=e.params();return t.refreshFullSyncFilters(n)}]},bindings:{status:"status"}}).state("/.full_syc_view.loader",{url:"/loader?gn&cn&st&sn&name&cid",component:"mainView",bindings:{tree:"sync_tree",maps:"maps",comInfo:"params"},resolve:{sync_tree:["$transition$","fullSycService",function(e,t){var n=e.params();return t.query_full_sync_filters(n)}],maps:["fullSycService",function(e){return e.query_map_list()}]}})}])}(),function(){angular.module("myApp.fullSycService",[]).config(["$qProvider",function(e){e.errorOnUnhandledRejections(!1)}]).service("fullSycService",["httpService","tipsService","md5Service","$filter",function(e,t,n,r){this.query_full_sync_filters=function(r){var a={group:r.gn,db_component_id:r.sn,db_type:r.st,comp_id:r.cn},o=[];return a=n.md5Data(a),e.postDataList("/dipserver/query_full_sync_filters",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={id:t,name:e.schema,isParent:!0,icon:"/img/ico/schema.png",chkDisabled:!0,checked:!0,open:0===t,children:[]};e.table&&angular.forEach(e.table,function(e,t){n.children.push({id:t,name:e,chkDisabled:!0,checked:!0})}),o.push(n)})}else t.error(e.response.error_msg);return o},function(e){t.error("网络错误！")})},this.query_map_exp_schema=function(n){var r="<dip_command><command>query_map_exp_schema</command><command_data><group>"+n.group+"</group><component>"+n.comp_id+"</component><sync_id>"+n.sync_id+"</sync_id></command_data></dip_command>",a=[];return e.postDataList("/dipserver/query_map_exp_schema",{xmlDoc:r}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else if(e.return_data&&e.return_data.schema){var r=[];angular.isArray(e.return_data.schema)?r=e.return_data.schema:angular.isString(e.return_data.schema)&&r.push(e.return_data.schema),angular.forEach(r,function(e){a.push({name:e})})}return a},function(e){t.error("网络错误！")})},this.query_map_exp_table=function(n,r){var a="<dip_command><command>query_map_exp_table</command><command_data><group>"+n.group+"</group><component>"+n.comp_id+"</component><schema>"+r+"</schema><sync_id>"+n.sync_id+"</sync_id></command_data></dip_command>",o=[];return e.postDataList("/dipserver/query_map_exp_table",{xmlDoc:a}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{var r=e.return_data;if(r&&r.table){var a=[];angular.isArray(r.table)?a=r.table:angular.isObject(r.table)&&a.push(r.table),angular.forEach(a,function(e){e.checked=!1,o.push(e)})}}return o},function(e){t.error("网络错误！")})},this.query_map_list=function(){var r=n.md5Data({}),a=[];return e.postDataList("/dipserver/query_map_list",r).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n=e.group+"/"+e.comp_id+"/config"+e.sync_id;a.push({sync_id:e.sync_id,group:e.group,comp_id:e.comp_id,name:n,id:t})})}else t.error(e.response.error_msg);return a},function(e){t.error("网络错误！")})},this.queryTabSpace=function(r){var a=n.md5Data({group:r.gn,db_type:r.st,comp_id:r.sn}),o=[];return e.postDataList("/dipserver/query_db_tablespace",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.table_space&&angular.isArray(r.table_space)&&angular.forEach(r.table_space,function(e){o.push({name:e,map_name:""})})}else t.error(e.response.error_msg);return o},function(e){t.error("网络错误！")})},this.createSyncCfg=function(r,a,o){var s={group:r.gn,comp_id:r.cn,exp:a,imp:o},i="";return s=n.md5Data(s),e.postDataList("/dipserver/create_sync_cfg",s).then(function(e){return n.equalMd5Data(e)&&(e.status?e.response&&e.response.sync_id&&(i=e.response.sync_id):t.error(e.response.error_msg)),i},function(e){t.error("网络错误！")})},this.startFullSync=function(n,r,a){var o="<dip_command><command>start_full_sync</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name><sync_id>"+r+"</sync_id><again>"+a+"</again></command_data></dip_command>",s=!1;return e.postDataList("/dipserver/start_full_sync",{xmlDoc:o},0).then(function(e){return"SUCCESS"===e.command_return&&(s=!0),s},function(e){t.error("网络错误！")})},this.queryFullSyncSummary=function(n,r){var a="<dip_command><command>query_fullsync_summary</command><command_data><group>"+n.gn+"</group><component>"+n.cn+"</component><sync_id>"+r+"</sync_id></command_data></dip_command>",o={};return e.postDataList("/dipserver/query_fullsync_summary",{xmlDoc:a}).then(function(e){if(o.export={},o.import={},"ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{if(e.return_data&&e.return_data.export){var r=e.return_data.export;o.export.start_time=r.start_time?r.start_time:"",o.export.work_time=r.work_time?r.work_time:"",o.export.succ_num=r.succ_num?r.succ_num:0,o.export.err_num=r.err_num?r.err_num:0,o.export.total=r.total?r.total:0}if(e.return_data&&e.return_data.import){var a=e.return_data.import;o.import.start_time=a.start_time?a.start_time:"",o.import.work_time=a.work_time?a.work_time:"",o.import.succ_num=a.succ_num?a.succ_num:0,o.import.err_num=a.err_num?a.err_num:0,o.import.total=a.total?a.total:0}}return o},function(e){t.error("网络错误！")})},this.queryFullSyncDetail=function(n,r){var a="<dip_command><command>query_fullsync_detail</command><command_data><group>"+n.gn+"</group><component>"+n.cn+"</component><sync_id>"+r+"</sync_id></command_data></dip_command>",o=[];return e.postDataList("/dipserver/query_fullsync_detail",{xmlDoc:a}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{var r=e.return_data;r&&r.detail&&(angular.isArray(r.detail)?o=r.detail:angular.isObject(r.detail)&&o.push(r.detail))}return o},function(e){t.error("网络错误！")})},this.querySyncError=function(n,r){var a="<dip_command><command>query_fullsync_error</command><command_data><group>"+n.gn+"</group><component>"+n.cn+"</component><sync_id>"+r+"</sync_id></command_data></dip_command>",o=[];return e.postDataList("/dipserver/query_fullsync_error",{xmlDoc:a}).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{var r=e.return_data;r&&r.record&&(angular.isArray(r.record)?o=r.record:angular.isObject(r.record)&&o.push(r.record))}return o},function(e){t.error("网络错误！")})},this.stopFullSync=function(n){var r="<dip_command><command>stop_full_sync</command><command_data><group>"+n.gn+"</group><component_name>"+n.cn+"</component_name></command_data></dip_command>",a=!1;return e.postDataList("/dipserver/stop_full_sync",{xmlDoc:r},0).then(function(e){if("ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else a=!0;return a},function(e){t.error("网络错误！")})},this.getHistoryMaps=function(r){var a={group:r.gn,comp_id:r.cn},o=[];return a=n.md5Data(a),e.postDataList("/dipserver/query_fullsync_history",a).then(function(e){if(n.equalMd5Data(e))if(e.status){var a=e.response;a&&a.list&&angular.isArray(a.list)&&angular.forEach(a.list,function(e,t){var n=r.gn+"/"+r.cn+"/config"+e.sync_id;o.push({sync_id:e.sync_id,group:r.gn,comp_id:r.cn,name:n,id:t})})}else t.error(e.response.error_msg);return o},function(e){t.error("网络错误！")})},this.refreshFullSyncFilters=function(n){var r="<dip_command><command>refresh_fullsync_filters</command><command_data><group>"+n.gn+"</group><component>"+n.cn+"</component></command_data></dip_command>",a={};return e.postDataList("/dipserver/refresh_fullsync_filters",{xmlDoc:r}).then(function(e){if(a.export={},a.import={},a.details=[],a.syncId="",a.isFinish=!1,"ERROR"===e.command_return){var n=e.return_data.error_message||e.return_data.error_msg;t.error(n)}else{var r=e.return_data;r&&r.summary&&(a.export=r.summary.export,a.import=r.summary.import),r&&r.detail&&(angular.isArray(r.detail.record)?a.details=r.detail.record:angular.isObject(r.detail.record)&&a.details.push(r.detail.record)),r&&""!==r.sync_id&&(a.syncId=r.sync_id),""===r&&(a.isFinish=!0)}return a},function(e){t.error("网络错误！")})}}])}(),function(){angular.module("myApp.fullSycComponent",["ui.bootstrap"]).component("parentView",{templateUrl:"full_syc_view/main.component.html",bindings:{status:"<"},controller:["$stateParams","$location","$state","$uibModal","fullSycService","tipsService","$scope","graphicService","$rootScope",function(e,t,n,r,a,o,s,i,c){function l(){a.createSyncCfg(m.currentLoader,m.export,m.import).then(function(e){e&&(m.currentSyncId=e,u(m.currentLoader,e,0))})}function u(e,t,n){var r=new BootstrapDialog({title:"Full Sync Info",type:"type-warning",message:function(){return'<h2 class="text-warning">全同步操作启动中......</h2>'},closable:!0});r.open();var o=a.startFullSync(e,t,n);o.then(function(n){r.onhide=function(){BootstrapDialog.confirm("全同步操作启动中，确认要停止全同步吗？",function(e){e&&(o.abort(),r.close())})},n?(r.setType("type-success"),r.getModalBody().html('<h2 class="text-success">恭喜！全同步已经启动！<i class="green glyphicon glyphicon-ok"></i></h2>'),p(e,t),m.isRun=!0):(r.setType("type-danger"),r.getModalBody().html('<h2 class="text-error">抱歉！全同步启动失败！<i class="red glyphicon glyphicon-remove"></i></h2>'),m.isRun=!1),setTimeout(function(){r.close()},500)})}function p(e,t){r.open({component:"fullSyncModal",size:"lg",resolve:{summary:function(){return a.queryFullSyncSummary(e,t)},detail:function(){return a.queryFullSyncDetail(e,t)},info:function(){return{loader:e,syncId:t}}}}).result.then(function(e){m.isRun=e})}function d(e){r.open({component:"historyModal",size:"lg",resolve:{info:function(){return m.currentLoader},maps:function(){return e}}})}var m=this,_=i.getLoaders(),f=[];angular.forEach(_,function(t){var n={};n.gn=e.gn,n.cn=t.name,n.name=t.cname,n.st=t.st,n.sn=t.sn,n.cid=t.cid,f.push(n)}),m.currentLoaderName="",m.currentLoader=e,angular.forEach(f,function(t){t.cn===e.cn&&(m.selectedItem=t,m.currentLoaderName=t.name)}),m.loaders=f,m.dialog=!0,m.current=1,m.export={},m.import={},m.loaderTip="数据同步基于loader组件的基础上进行",m.isRun=!1,m.currentSyncId="",m.$onInit=function(){"1"!==m.status.export.status&&"1"!==m.status.import.status||(m.isRun=!0,m.currentSyncId=m.status.syncId,p(m.currentLoader,m.currentSyncId))};var g=s.$on("exportChange",function(e,t){return t&&!$.isEmptyObject(t)&&"0"===t.exp_simu&&"0"===t.exp_create_object?(o.error("系统检测到导出规则里面（导出任务并发数、导出其他对象）均未配置，将导致全同步导出无法启动，请至少配置其中一项！"),void(m.export={})):t&&"0"===t.exp_mode&&0===t.exp_schema.length?(o.error("系统检测到你未配置任何表，请选择要导出的表！"),void(m.export={})):(m.export=t,o.success("导出配置已保存！"),void e.stopPropagation())}),h=s.$on("importChange",function(e,t){return t&&!$.isEmptyObject(t)&&"0"===t.imp_simu&&"0"===t.imp_rebuild_object?(o.error("系统检测到导入规则里面（导入任务并发数、重建对象）均未配置，将导致全同步导入无法启动，请至少配置其中一项！"),void(m.import={})):t&&"0"===t.imp_mode&&0===t.imp_schema.length?(o.error("系统检测到你未配置任何表，请选择要导入的表！"),void(m.import={})):(m.import=t,o.success("导入配置已保存！"),void e.stopPropagation())}),v=c.$on("fullSyncIsRun",function(e,t){m.isRun=t});s.$on("$destroy",function(){v(),g(),h()}),m.changeLoader=function(){var e=m.selectedItem,t={gn:e.gn,cn:e.cn,st:e.st,sn:e.sn,name:e.name,cid:e.cid};m.currentLoaderName=e.name,m.currentLoader=t,a.refreshFullSyncFilters(t).then(function(e){"1"===e.export.status||"1"===e.import.status?(m.isRun=!0,m.currentSyncId=e.syncId,p(t,e.syncId)):m.isRun=!1}).finally(function(){n.go("/.full_syc_view.loader",t)})},m.redirectTo=function(){n.go("/")},m.beginToFullSync=function(){return $.isEmptyObject(m.export)&&$.isEmptyObject(m.import)?void o.error("请至少配置一项全同步规则，再执行该操作！"):$.isEmptyObject(m.export)&&!$.isEmptyObject(m.import)&&m.import&&"1"===m.import.imp_mode?void o.warning("请配置导出规则或者导入规则里面从已有数据文件导入其中至少一种规则才能启动全同步！"):void($.isEmptyObject(m.import)?BootstrapDialog.confirm({title:"Dip 提示",message:"系统检测到您尚未配置导入选项，系统将只执行导出，是否继续？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"继续",btnOKClass:"btn-warning",callback:function(e){e&&l()}}):BootstrapDialog.confirm({title:"Dip 提示",message:"确认要同步这些表吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(e){e&&l()}}))},m.workingFullSync=function(){p(m.currentLoader,m.currentSyncId)},m.getFullSyncHistory=function(){a.getHistoryMaps(m.currentLoader).then(function(e){e.length>0?d(e):o.warning("没有全同步历史数据！")})}}]}).component("mainView",{templateUrl:"full_syc_view/loader.component.html",bindings:{tree:"<",maps:"<"},controller:["$rootScope","tipsService","$stateParams","$scope",function(e,t,n,r){var a=this;a.$onInit=function(){a.isExport=!0,a.isImport=!1,a.export={},a.import={},a.currentLoader=n||{}},a.cfgExport=function(e){a.export=e,r.$emit("exportChange",e)},a.cfgImport=function(e){r.$emit("importChange",e),a.import=e}}]}).component("exportCom",{templateUrl:"full_syc_view/export.component.html",bindings:{tree:"<",loader:"=",onSave:"&"},controller:["$stateParams","tipsService","$uibModal","graphicService",function(e,t,n,r){function a(){var e=!1,t=[];angular.forEach(s.tables,function(e){e.checked&&t.push(e)}),angular.forEach(s.exportSchemas,function(n){n.name===s.currentSechema&&(n.object=t,e=!0)}),!e&&t.length>0&&s.exportSchemas.push({name:s.currentSechema,object:t})}function o(e,t){var n=[];s.tables=[],angular.forEach(s.exportSchemas,function(e){e.name===t&&angular.forEach(e.object,function(e){n.push(e.name)})}),angular.forEach(e,function(e){var t={checked:!1,name:e.name,status:e.status,clause:e.clause};t.checked=$.inArray(e.name,n)>=0,s.tables.push(t)})}var s=this,i={check:{enable:!0,chkDisabledInherit:!0},data:{simpleData:{enable:!0}}};s.exportAll=!0,s.schemasList=[],s.tables=[],s.selTables=[],s.exportSchemas=[],s.currentSechema="",s.charset=["ZHS16GBK","ASCII","GB18030","BIG5","GB2312","UTF-8","UTF-16BE","UTF-16LE","UTF8","UTF16","GBK","US7ASCII","ZHT16BIG5","ZHS16CGB231280","AL32UTF8","AL16UTF16","AL16UTF16LE","WE8MSWIN1252","CP1252","UTF-16","UTF-32","UTF-7","UTF-32BE","UTF-32LE","UTF7","UTF32","UTF16BE","UTF16LE","UTF32BE","UTF32LE","UCS-2","UCS-2LE","UCS-2BE","UCS2"],s.ckAll=!1,s.exp={exp_simu:1,exp_tab_simu:1,exp_dict_only:"0",exp_string:!1,exp_scn:"",exp_nls_lang:"ZHS16GBK",exp_use_etl:!1,exp_create_table:!0,exp_create_index:!0,exp_create_object:!1,file_size:32},s.isOracle=!1,s.isOracleToOther=!1,s.isOther=!1,s.$onInit=function(){$.fn.zTree.init($("#fullSycTree"),i,s.tree),angular.forEach(s.tree,function(e){var t={name:e.name,tables:[]};angular.forEach(e.children,function(n){t.tables.push({name:n.name,checked:!1,pname:e.name,clause:""})}),s.schemasList.push(t)});var e=r.getChild(s.loader.cid);e&&"database"===e.rtype&&("oracle"===s.loader.st&&("oracle"===e.type&&(s.isOracle=!0),"mysql"===e.type&&(s.isOracleToOther=!0,s.exp.exp_nls_lang="AL32UTF8",s.exp.exp_string=!0),"sqlserver"===e.type&&(s.isOracleToOther=!0,s.exp.exp_nls_lang="ZHS16GBK",s.exp.exp_string=!0)),"mysql"===s.loader.st&&(s.isOther=!0,"mysql"===e.type&&(s.exp.exp_nls_lang="AL32UTF8"),"oracle"===e.type&&(s.exp.exp_nls_lang="AL32UTF8",s.exp.exp_string=!0),"sqlserver"===e.type&&(s.exp.exp_nls_lang="ZHS16GBK",s.exp.exp_string=!0)),"sqlserver"===s.loader.st&&(s.isOther=!0,"mysql"===e.type&&(s.exp.exp_nls_lang="AL32UTF8",s.exp.exp_string=!0),"oracle"===e.type&&(s.exp.exp_nls_lang="AL32UTF8",s.exp.exp_string=!0),"sqlserver"===e.type&&(s.exp.exp_nls_lang="ZHS16GBK",s.exp.exp_string=!0)),"db2"===s.loader.st&&"db2"===e.type&&(s.isOther=!0,s.exp.exp_nls_lang="AL32UTF8",s.exp.exp_string=!0))},s.schemaCheck=function(e,t){var n=t.target;$(n).addClass("active").siblings().removeClass("active"),a(),s.currentSechema=e.name,o(angular.copy(e.tables),e.name)},s.checkAll=function(){s.ckAll?angular.forEach(s.selTables,function(e){e.checked=!0}):angular.forEach(s.selTables,function(e){e.checked=!1})},s.checkOne=function(e){var t=0;e.checked?(angular.forEach(s.selTables,function(e){e.checked&&t++}),t===s.tables.length&&(s.ckAll=!0)):s.ckAll=!1},s.editClause=function(e){n.open({templateUrl:"exportRuleModal.html",controller:["$uibModalInstance","rule",function(e,t){var n=this;n.rule=t,n.save=function(){e.close(n.rule)},n.cancel=function(){e.dismiss("cancel")}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{rule:function(){return e.clause}}}).result.then(function(t){angular.forEach(s.tables,function(n){n.name===e.name&&(n.clause=t)})})},s.saveExportCfg=function(){a();var e={exp_source_tab:"0"};e.exp_dict_only=""+s.exp.exp_dict_only,e.exp_mode=s.exportAll?"1":"0",e.exp_schema=s.exportSchemas,"0"===e.exp_dict_only?(e.file_size=s.exp.file_size>=0?""+s.exp.file_size:"0",e.exp_simu=s.exp.exp_simu>=0?""+s.exp.exp_simu:"0",e.exp_tab_simu=s.exp.exp_tab_simu>=0?""+s.exp.exp_tab_simu:"0",e.exp_string=s.exp.exp_string?"1":"0",e.exp_scn=s.exp.exp_scn,e.exp_nls_lang=""+s.exp.exp_nls_lang,e.exp_use_etl=s.exp.exp_use_etl?"1":"0",e.exp_create_table=s.exp.exp_create_table?"1":"0",e.exp_create_index=s.exp.exp_create_index?"1":"0",e.exp_create_object=s.exp.exp_create_object?"1":"0"):(e.exp_simu=s.exp.exp_simu>=0?""+s.exp.exp_simu:"0",e.exp_create_object=s.exp.exp_create_object?"1":"0",e.exp_use_etl=s.exp.exp_use_etl?"1":"0"),s.onSave({exp:e})}}]}).component("importCom",{templateUrl:"full_syc_view/import.component.html",bindings:{maps:"<",loader:"=",onSave:"&"},controller:["$stateParams","tipsService","$uibModal","fullSycService","graphicService",function(e,t,n,r,a){function o(){var e=!1,t=[];angular.forEach(i.tables,function(e){e.checked&&t.push(e)}),angular.forEach(i.importSchemas,function(n){n.name===i.currentSechema&&(n.object=t,e=!0)}),!e&&t.length>0&&i.importSchemas.push({name:i.currentSechema,object:t})}function s(e,t){var n=[];angular.forEach(i.importSchemas,function(e){e.name===t&&angular.forEach(e.object,function(e){n.push(e.name)})}),angular.forEach(e,function(e){var t={checked:!1,name:e.name,status:e.status};t.checked=$.inArray(e.name,n)>=0,i.tables.push(t)})}var i=this;i.fromOldData=!1,i.selectSync={},i.schemasList=[],i.tables=[],i.selTables=[],i.importSchemas=[],i.currentSechema="",i.isErrorOnly=!1,i.isError="",i.charset=["ZHS16GBK","ASCII","GB18030","BIG5","GB2312","UTF-8","UTF-16BE","UTF-16LE","UTF8","UTF16","GBK","US7ASCII","ZHT16BIG5","ZHS16CGB231280","AL32UTF8","AL16UTF16","AL16UTF16LE","WE8MSWIN1252","CP1252","UTF-16","UTF-32","UTF-7","UTF-32BE","UTF-32LE","UTF7","UTF32","UTF16BE","UTF16LE","UTF32BE","UTF32LE","UCS-2","UCS-2LE","UCS-2BE","UCS2"],i.ckAll=!1,i.loading=!1,i.loading1=!1,i.tableSpaces=[],i.imp={imp_simu:1,imp_tab_simu:1,imp_dict_only:"0",imp_write_log:!1,imp_rebuild_tab:!0,imp_nls_lang:"ZHS16GBK",imp_truncate_tab:!0,imp_rebuild_ind:!0,imp_rebuild_object:!1,imp_backup_file:!1,imp_ora_op:"1",imp_use_tabs_map:!1},i.isOracle=!1,i.isOther=!1,i.$onInit=function(){i.comInfo=i.loader,i.maps&&angular.isArray(i.maps)&&i.maps.length>0&&(i.selectSync=i.maps[0],r.query_map_exp_schema(i.selectSync).then(function(e){i.schemasList=e}));var e=a.getChild(i.loader.cid);e&&"database"===e.rtype&&("oracle"===i.loader.st&&("oracle"===e.type&&(i.isOracle=!0),"mysql"===e.type&&(i.isOther=!0,i.imp.imp_nls_lang="AL32UTF8",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1),"sqlserver"===e.type&&(i.isOther=!0,i.imp.imp_nls_lang="ZHS16GBK",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1)),"mysql"===i.loader.st&&(i.isOther=!0,"mysql"===e.type&&(i.imp.imp_nls_lang="AL32UTF8"),"oracle"===e.type&&(i.imp.imp_nls_lang="AL32UTF8",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1),"sqlserver"===e.type&&(i.imp.imp_nls_lang="ZHS16GBK",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1)),"sqlserver"===i.loader.st&&(i.isOther=!0,"mysql"===e.type&&(i.imp.imp_nls_lang="AL32UTF8",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1),"oracle"===e.type&&(i.imp.imp_nls_lang="AL32UTF8",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1),"sqlserver"===e.type&&(i.imp.imp_nls_lang="ZHS16GBK")),"db2"===i.loader.st&&"db2"===e.type&&(i.isOther=!0,i.imp.imp_nls_lang="AL32UTF8",i.imp.imp_rebuild_tab=!1,i.imp.imp_rebuild_ind=!1,i.imp.imp_truncate_tab=!1))},i.checkAll=function(){angular.forEach(i.selTables,function(e){e.checked=i.ckAll})},i.checkOne=function(e){var t=0;e.checked?(angular.forEach(i.selTables,function(e){e.checked&&t++}),t===i.tables.length&&(i.ckAll=!0)):i.ckAll=!1},i.schemaCheck=function(e,t){i.ckAll=!1;var n=t.target;$(n).addClass("active").siblings().removeClass("active"),o(),i.currentSechema=e.name,i.loading=!0,i.tables=[],r.query_map_exp_table(i.selectSync,e.name).then(function(t){s(t,e.name)}).finally(function(){i.loading=!1})},i.errorOnlyChange=function(){i.isError=i.isErrorOnly?"error":""},i.changeSync=function(){i.loading1=!0,i.schemasList=[],i.tables=[],i.selTables=[],i.importSchemas=[],i.currentSechema="",r.query_map_exp_schema(i.selectSync).then(function(e){i.schemasList=e}).finally(function(){i.loading1=!1})},i.saveImport=function(){o();var e={};i.fromOldData?(e.imp_mmap_id=i.selectSync.sync_id?i.selectSync.sync_id+"":"",e.imp_mode="0"):(e.imp_mmap_id="",e.imp_mode="1"),e.imp_dict_only=i.imp.imp_dict_only+"",e.imp_schema=i.importSchemas,e.imp_ora_op=i.imp.imp_ora_op+"",e.imp_write_log=i.imp.imp_write_log?"1":"0",e.table_space=i.tableSpaces,"0"===e.imp_dict_only?(e.imp_simu=i.imp.imp_simu>=0?i.imp.imp_simu+"":"0",e.imp_tab_simu=i.imp.imp_tab_simu>=0?i.imp.imp_tab_simu+"":"0",e.imp_rebuild_tab=i.imp.imp_rebuild_tab?"1":"0",e.imp_nls_lang=i.imp.imp_nls_lang+"",e.imp_truncate_tab=i.imp.imp_truncate_tab?"1":"0",e.imp_rebuild_ind=i.imp.imp_rebuild_ind?"1":"0",e.imp_rebuild_object=i.imp.imp_rebuild_object?"1":"0",e.imp_backup_file=i.imp.imp_backup_file?"1":"0",e.imp_use_tabs_map=i.imp.imp_use_tabs_map?"1":"0"):(e.imp_simu=i.imp.imp_simu>=0?i.imp.imp_simu+"":"0",e.imp_rebuild_tab=i.imp.imp_rebuild_tab?"1":"0",e.imp_truncate_tab=i.imp.imp_truncate_tab?"1":"0",e.imp_rebuild_ind=i.imp.imp_rebuild_ind?"1":"0",e.imp_rebuild_object=i.imp.imp_rebuild_object?"1":"0",e.imp_backup_file=i.imp.imp_backup_file?"1":"0",e.imp_use_tabs_map=i.imp.imp_use_tabs_map?"1":"0"),i.onSave({imp:e})},i.editTableSpace=function(){n.open({templateUrl:"tableSpaceModal.html",controller:["$uibModalInstance","tables",function(e,t){var n=this;n.tableSpaces=t,n.save=function(){e.close(n.tableSpaces)},n.cancel=function(){e.dismiss("cancel")}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{tables:function(){return r.queryTabSpace(i.loader)}}}).result.then(function(e){i.tableSpaces=e})}}]}).component("fullSyncModal",{templateUrl:"full_syc_view/full_sync.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["fullSycService","tipsService","$interval","$scope","$rootScope",function(e,t,n,r,a){function o(){angular.isDefined(i)&&(n.cancel(i),i=void 0,c.stopFlag=!0),c.isRun=!1}function s(){e.refreshFullSyncFilters(c.info.loader).then(function(t){t.isFinish?(o(),e.queryFullSyncSummary(c.info.loader,c.info.syncId).then(function(e){c.export=e.export,c.import=e.import,c.import&&!$.isEmptyObject(c.import)&&(c.isImportShow=!0)}),e.queryFullSyncDetail(c.info.loader,c.info.syncId).then(function(e){c.details=e})):(c.export=t.export,c.import=t.import,c.import&&!$.isEmptyObject(c.import)&&(c.isImportShow=!0),c.details=t.details,"0"===c.export.status&&"0"===c.import.status&&o(),c.isRun=!0)})}var i,c=this;c.export={},c.import={},c.isImportShow=!1,c.errors=[],c.loading1=!1,c.loading2=!1,c.stopFlag=!1,c.isRun=!0,c.$onInit=function(){c.details=c.resolve.detail||[],c.resolve.summary&&(c.export=c.resolve.summary.export,c.import=c.resolve.summary.import,c.import&&!$.isEmptyObject(c.import)&&(c.isImportShow=!0)),c.info=c.resolve.info||{},i=n(function(){s()},5e3),r.$on("$destroy",function(){a.$emit("fullSyncIsRun",c.isRun),o(i)})},c.cancel=function(){c.close({$value:c.isRun})},c.stopFullSync=function(){c.stopFlag=!0,e.stopFullSync(c.info.loader).then(function(e){e?(t.success("全同步操作停止成功！"),c.isRun=!1,c.close({$value:c.isRun})):t.warning("全同步操作停止失败！")}).finally(function(){c.stopFlag=!1})},c.getSyncErrors=function(){c.loading1=!0,c.errors=[],e.querySyncError(c.info.loader,c.info.syncId).then(function(e){c.errors=e}).finally(function(){c.loading1=!1})}}]}).component("historyModal",{templateUrl:"full_syc_view/history.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","fullSycService",function(e,t){function n(e,n,a){var o=new BootstrapDialog({title:"Full Sync Info",type:"type-warning",message:function(){return'<h2 class="text-warning">全同步操作启动中......</h2>'},closable:!0});o.open();var s=t.startFullSync(e,n,a);s.then(function(t){o.onhide=function(){BootstrapDialog.confirm("全同步操作启动中，确认要停止全同步吗？",function(e){e&&(s.abort(),o.close())})},t?(o.setType("type-success"),o.getModalBody().html('<h2 class="text-success">恭喜！全同步已经启动！<i class="green glyphicon glyphicon-ok"></i></h2>'),r(e,n)):(o.setType("type-danger"),o.getModalBody().html('<h2 class="text-error">抱歉！全同步启动失败！<i class="red glyphicon glyphicon-remove"></i></h2>')),setTimeout(function(){o.close()},500)})}function r(n,r){o.dismiss({$value:"cancel"}),e.open({component:"fullSyncModal",size:"lg",resolve:{summary:function(){return t.queryFullSyncSummary(n,r)},detail:function(){return t.queryFullSyncDetail(n,r)},info:function(){return{loader:n,syncId:r}}}})}function a(){var e={gn:o.selectSync.group,cn:o.selectSync.comp_id};t.queryFullSyncSummary(e,o.selectSync.sync_id).then(function(e){o.export=e.export,o.import=e.import,o.import&&!$.isEmptyObject(o.import)&&(o.isImportShow=!0)}),o.loading2=!0,o.details=[],t.queryFullSyncDetail(e,o.selectSync.sync_id).then(function(e){o.details=e}).finally(function(){o.loading2=!1})}var o=this;o.export={},o.import={},o.details=[],o.loading1=!1,o.loading2=!1,o.isImportShow=!1,o.currentActive=0,o.$onInit=function(){o.selectSync={},o.maps=o.resolve.maps||[],o.info=o.resolve.info||{},o.maps&&angular.isArray(o.maps)&&(o.selectSync=o.maps[0]),a()},o.cancel=function(){o.dismiss({$value:"cancel"})},o.reTryFullSync=function(){BootstrapDialog.confirm({title:"Dip 提示",message:"确定要执行该批次的数据导入吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(e){e&&n(o.info,o.selectSync.sync_id,1)}})},o.changeSyncId=function(){o.currentActive=0,o.errors=[],a()},o.getSyncErrors=function(){o.loading1=!0,o.errors=[],t.querySyncError(o.info,o.selectSync.sync_id).then(function(e){o.errors=e}).finally(function(){o.loading1=!1})}}]}).directive("glNum",function(){return{restrict:"A",link:function(e,t){t.on("keyup",function(){var e=this.value;e?(e=e.toString(),e=e.replace(/[^0-9]*/g,""),""===(e=e.replace(/^0(.+)/,"$1"))&&(e="0")):e="0",this.value=parseInt(e)})}}})}(),function(){angular.module("myApp.tclient_view",["ui.bootstrap","myApp.tcService","myApp.tcComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/tclient_view/","/main/tclient_view/status"),t.state("/.tclient_view",{abstract:!0,url:"/tclient_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Tc_zjsz")}],tcInfo:["$transition$","tcService",function(e,t){var n=e.params();return n.gn&&"unnamed"!==n.cn&&""!==n.cid?t.getTclientInfo(n):"init"}]},bindings:{title:"title"}}).state("/.tclient_view.status",{url:"/status?gn&cn&id&cid",component:"tcStatus",bindings:{dl:"tcInfo"}}).state("/.tclient_view.property",{url:"/property?gn&cn&id&cid",component:"tcProperty",bindings:{dl:"tcInfo"}})}])}(),function(){function e(e,t,n,r,a){this.getTclientInfo=function(o){var s={group_id:o.gn,component_id:o.cid},i=null;return s=n.md5Data(s),e.postDataList("/dipserver/query_qrecv_config",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(i=e.response,i.passwd&&(i.passwd=a.de_des(i.passwd))):t.error(e.response&&e.response.error_msg)),i},function(){t.error(r("translate")("Wlcw"))})},this.saveTclientInfo=function(t,r){var o={group_name:r.group_name,ip:r.ip,port:r.port,compress:r.compress,encrypt:r.encrypt,queue_name:r.queue_name,pkg_size:r.pkg_size,db_type:r.db_type,user:r.user,passward:r.passwd};o.passward=a.en_des(o.passward);var s={group_id:t.gn,component_name:r.component_name,type:"transfer",transfer:o,component_id:t.cid},i={res:!1,comId:"",msg:""};return s=n.md5Data(s),e.postDataList("/dipserver/add_apply_config",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(i.res=!0,i.comId=e.response&&e.response.component_id||""):i.msg=e.response.error_msg),i})}}angular.module("myApp.tcService",[]).service("tcService",e),e.$inject=["httpService","tipsService","md5Service","$filter","tDes"]}(),function(){angular.module("myApp.tcComponent",[]).component("tcStatus",{templateUrl:"tclient_view/status.component.html",bindings:{dl:"<"},controller:["$stateParams","$filter","$state",function(e,t,n){var r=this;r.params={cliUser:!1,cliPass:!1,cliModu:!1,cliIpd:!1,cliPor:!1,cliOra:!1,cliGrop:!1,cliQue:!1,cliCompre:!1,cliEnc:!1,cliPacksize:!1,tcid:!1},r.property={},r.real={com_id:""},r.$onInit=function(){r.dl&&angular.isObject(r.dl)?(r.property.user=r.dl.user,r.property.passwd="******",r.property.component_name=r.dl.component_name?r.dl.component_name:e.cn,r.property.ip=r.dl.ip,r.property.port=r.dl.port,r.property.db_type=r.dl.db_type,r.property.group_name=r.dl.group_name,r.property.queue_name=r.dl.queue_name,r.property.compress=r.dl.compress,
r.property.encrypt=r.dl.encrypt,r.property.pkg_size=parseInt(r.dl.pkg_size)||1024,r.real.com_id=e.cid||""):n.go("/")}}]}).component("tcProperty",{templateUrl:"tclient_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","graphicService","$filter","tcService",function(e,t,n,r,a,o){var s=this,i=e;s.params={cliUser:!1,cliPass:!1,cliModu:!1,cliIpd:!1,cliPor:!1,cliOra:!1,cliGrop:!1,cliQue:!1,cliCompre:!1,cliEnc:!1,cliPacksize:!1,tcid:!1},s.property={user:"",passwd:"",component_name:"",ip:"",port:"7007",db_type:"oracle",group_name:"",queue_name:"",compress:"yes",encrypt:"yes",pkg_size:1024},s.serverErr="",s.real={com_id:""},s.allowDbs=["oracle","db2","sqlserver","gbase-8a","mysql","informix","sybase","altibase","postgresql","oscar","dameng","kingbase","vertica","dbone","kdb"],s.isSaving=!1;var c=a("translate")("SAVE"),l=a("translate")("SAVING");s.saveBtnTxt=c,s.$onInit=function(){s.dl?s.dl&&angular.isObject(s.dl)&&(s.property=s.dl,s.property.component_name=s.dl.component_name?s.dl.component_name:i.cn,s.property.pkg_size=parseInt(s.dl.pkg_size)||1024,s.real.com_id=i.cid||""):t.go("/")},s.saveTcpInfo=function(){if("unnamed"===s.property.component_name)return void n.error(a("translate")("Tc_mcbnk"));s.isSaving=!0,s.saveBtnTxt=l;var e=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),u=function(t,n){t?(e.setType("type-success"),e.getModalBody().html("保存成功！"),setTimeout(function(){e.close()},300)):(e.setType("type-danger"),n?e.getModalBody().html(n):e.getModalBody().html("保存失败！")),e.setClosable(!0)};e.open(),o.saveTclientInfo(i,s.property).then(function(e){if(e.res){s.real.com_id=e.comId;var n=$("#"+i.id);n.find(".dragPoint").text(s.property.component_name),n.attr("name",s.property.component_name),n.attr("type",s.property.db_type),n.attr("realid",s.real.com_id),r.save_graphics_no_alert(i.gn).finally(function(){u(!0)}),t.go("/")}else u(!1,e.msg)}).catch(function(){u(!1)}).finally(function(){s.isSaving=!1,s.saveBtnTxt=c})}}]})}(),function(){angular.module("myApp.tserver_view",["ui.bootstrap","myApp.tsService","myApp.tsComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/tserver_view/","/main/tserver_view/status"),t.state("/.tserver_view",{abstract:!0,url:"/tserver_view",component:"rightDialog",resolve:{title:["$filter",function(e){return e("translate")("Ts_pz")}],tsInfo:["$transition$","tsService",function(e,t){return"no-ne"!==e.params().cn?t.getTserverInfo():"init"}]},bindings:{title:"title"}}).state("/.tserver_view.status",{url:"/status?cn",component:"tsStatus"}).state("/.tserver_view.property",{url:"/property?cn",component:"tsProperty",bindings:{dl:"tsInfo"}})}])}(),function(){function e(e,t,n,r,a){this.getTserverInfo=function(){var o=n.md5Data({}),s=null;return e.postDataList("/dipserver/query_tserver_config",o).then(function(e){return n.equalMd5Data(e)&&(e.status?(s=e.response,s.server_config.user.passwd&&(s.server_config.user.passwd=a.de_des(s.server_config.user.passwd))):t.error(e.response&&e.response.error_msg)),s},function(){t.error(r("translate")("Wlcw"))})},this.getTserverStatus=function(){var t={res:!1,info:null};return e.postDataList("/dipserver/query_tserver_status",{xmlDoc:"<dip_command><command>query_tserver_status</command><command_data></command_data></dip_command>"}).then(function(e){if("SUCCESS"===e.command_return){var n=e.return_data;n&&n.server_info&&(t.res=!0,t.info=n.server_info)}return t})},this.startTserver=function(){var n=!1;return e.postDataList("/dipserver/start_server",{xmlDoc:"<dip_command><command>start_server</command><command_data><group></group><type>tserver</type><name></name></command_data></dip_command>"},0).then(function(e){return n="SUCCESS"===e.command_return},function(){t.error(r("translate")("Wlcw"))})},this.saveTserverConfig=function(o){o.user.passwd=a.en_des(o.user.passwd);var s=n.md5Data({server_config:o}),i=!1;return e.postDataList("/dipserver/add_tserver_config",s).then(function(e){return n.equalMd5Data(e)&&(e.status?i=!0:t.error(e.response&&e.response.error_msg)),i},function(){t.error(r("translate")("Wlcw"))})}}angular.module("myApp.tsService",[]).service("tsService",e),e.$inject=["httpService","tipsService","md5Service","$filter","tDes"]}(),function(){angular.module("myApp.tsComponent",[]).component("tsStatus",{templateUrl:"tserver_view/status.component.html",controller:["$stateParams","$filter","$state","tsService","$rootScope","tipsService",function(e,t,n,r,a,o){function s(){r.getTserverStatus().then(function(e){e.res?"tserver"===e.info.type&&"running"===e.info.status&&(i.isRun=!0):i.isRun=!1})}var i=this,c=e.cn;i.params={serUser:!1,serPass:!1,serGrop:!1,serQue:!1,serAll:!1},i.property={},i.isRun=!1,i.$onInit=function(){c?(i.property.user=c,i.property.passwd="******",s()):n.go("/")},i.startTserver=function(){if(!i.property.user)return void o.error(t("translate")("Ts_wpzts"));var e=new BootstrapDialog({title:"Tserver Info",type:"type-warning",message:function(){return'<h2 class="text-warning">'+t("translate")("Ts_qdz")+"</h2>"},closable:!1});e.open(),r.startTserver().then(function(n){n?(e.setType("type-success"),e.getModalBody().html('<h2 class="text-success">'+t("translate")("Ts_qdcg")+'<i class="green glyphicon glyphicon-ok"></i></h2>'),e.setClosable(!0),a.$emit("tserverStarted",{}),i.isRun=!0):(e.setType("type-danger"),e.getModalBody().html('<h2 class="text-error">'+t("translate")("Ts_qdsb")+'<i class="red glyphicon glyphicon-remove"></i></h2>'),e.setClosable(!0)),setTimeout(function(){e.close()},500)},function(){e.close()})}}]}).component("tsProperty",{templateUrl:"tserver_view/property.component.html",bindings:{dl:"<"},controller:["$stateParams","$state","tipsService","$location","tsService","$filter",function(e,t,n,r,a,o){var s=this;s.params={serUser:!1,serPass:!1,serGrop:!1,serQue:!1,serAll:!1},s.property={user:"",passwd:"",group_name:"tserver_test",queue_name:"que",all_que:"yes"},s.serverErr="",s.isSaving=!1;var i=o("translate")("SAVE"),c=o("translate")("SAVING");s.saveBtnTxt=i,s.$onInit=function(){if(s.dl){if(s.dl&&angular.isObject(s.dl)&&s.dl.server_config){var e=s.dl.server_config.user;s.property.user=e.name,s.property.passwd=e.passwd}}else t.go("/")},s.saveTcpInfo=function(){s.isSaving=!0,s.saveBtnTxt=c;var e={user:{name:s.property.user,passwd:s.property.passwd,pri:{all_que:"yes"}}};a.saveTserverConfig(e).then(function(e){e&&(n.success(o("translate")("Bccg")),r.url("/main/tserver_view/status?cn="+s.property.user))}).finally(function(){s.isSaving=!1,s.saveBtnTxt=i})}}]})}(),function(){angular.module("myApp.etl_view",["myApp.etlService","myApp.component"]).config(["$urlServiceProvider","$stateProvider",function(e,t){e.rules.when("/main/etl_view","/main/etl_view/status"),t.state("/.etl_view",{url:"/etl_view/",component:"etlView",abstract:!0,resolve:{etl_conf:["$transition$","etlService",function(e,t){var n=e.params();return t.fetchEtlConfig(n)}]}}).state("/.etl_view.status",{url:"status?gn&cn&pn&pt&id&cid",component:"etlStatus",bindings:{conf:"etl_conf"}}).state("/.etl_view.property",{url:"property?gn&cn&pn&pt&id&cid",component:"etlProperty"}).state("/.etl_view.property.config",{url:"/config",component:"etlConf",bindings:{conf:"etl_conf"}}).state("/.etl_view.property.rule",{url:"/rule",component:"etlRule",resolve:{etl_users:["$transition$","etlService",function(e,t){var n=e.params();return t.fetchEtlUser(n)}]},bindings:{users:"etl_users"}}).state("/.etl_view.property.bgl",{url:"/bgl",component:"etlBglRule",resolve:{etl_users:["$transition$","etlService",function(e,t){var n=e.params();return t.fetchEtlUser(n)}]},bindings:{users:"etl_users"}}).state("/.etl_view.property.operate",{url:"/operate",component:"etlOperateRule",resolve:{etl_users:["$transition$","etlService",function(e,t){var n=e.params();return t.fetchEtlUser(n)}]},bindings:{users:"etl_users"}}).state("/.etl_view.property.batch",{url:"/batch",component:"etlPlRule",resolve:{batches:["$transition$","etlService",function(e,t){var n=e.params();return t.fetchBatchs(n,"filter")}]},bindings:{users:"batches"}}).state("/.etl_view.property.configured",{url:"/configured",component:"configRule"}).state("/.etl_view.property.pl_rule_apply",{url:"/pl_rule_apply",component:"etlApplyRule",resolve:{rules:["$transition$","etlService",function(e,t){var n=e.params();return t.getBatchCheckedList(n,"filter")}]},bindings:{rules:"rules"}})}])}(),function(){angular.module("myApp.etlService",[]).config(["$qProvider",function(e){e.errorOnUnhandledRejections(!1)}]).service("etlService",["httpService","tipsService","md5Service","$filter","graphicService","$q","tDes",function(e,t,n,r,a,o,s){this.fetchEtlConfig=function(r){var a={init:!0};if(r.gn&&r.pn&&r.pt){var o="unnamed"===r.cn?"":r.cn,s={group:r.gn,component_name:o,db_type:r.pt,db_component_name:r.pn,component_id:r.cid};s=n.md5Data(s);return e.postDataList("/dipserver/query_etl_config",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(a.init=!1,a.data=e.response,a.etl_id=r.cid?r.cid:"",a.etl_name=o):t.error(e.response.error_msg)),a},function(e){return t.error("网络错误！"),a})}return a},this.saveEtlConfig=function(r,o,s){if("unnamed"===o.etl_name)return void t.error("Etl名称不能为unnamed！");var i={charset:o.etl_char,ncharset:o.etl_nchar,clobset:o.etl_clob,nclobset:o.etl_nclob,full_string:o.etl_gs,interval:o.etl_jg};"yes"===o.etl_gs&&(i.tar_set=o.etl_zh);var c={group_id:r.gn,component_name:o.etl_name,type:"etl",db_component_id:r.pn,etl_config:i,component_id:r.cid};c=n.md5Data(c);var l=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),u=function(e,t){e?(l.setType("type-success"),l.getModalBody().html("保存成功！"),setTimeout(function(){l.close()},300)):(l.setType("type-danger"),t?l.getModalBody().html(t):l.getModalBody().html("保存失败！")),l.setClosable(!0)};return l.open(),e.postDataList("/dipserver/add_apply_config",c).then(function(e){if(n.equalMd5Data(e))if(e.status){var t=$("#"+r.id);t.find(".dragPoint").text(o.etl_name),t.attr("name",o.etl_name),t.attr("realid",e.response.component_id),t.attr("type",r.pt),a.save_graphics_no_alert(r.gn).finally(function(){u(!0)}),s.go("/")}else u(!1,e.response.error_msg)},function(){u(!1)})},this.fetchEtlUser=function(r){var a={group:r.gn,db_type:r.pt,db_component_name:r.pn},o=[];return a=n.md5Data(a),e.postDataList("/dipserver/query_etl_user",a).then(function(e){return n.equalMd5Data(e)&&(e.status?o=e.response.user:t.error(e.response.error_msg)),o},function(e){return t.error("网络错误！"),o})},this.fetchEtlTable=function(r,a){var o={group:r.gn,db_type:r.pt,db_component_name:r.pn,user:a},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_etl_table",o).then(function(e){return n.equalMd5Data(e)&&(e.status&&e.response?s=e.response.tables:t.error(e.response.error_msg)),s},function(e){return t.error("网络错误！"),s})},this.getRuleByName=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i=[];return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_table_rule",s).then(function(e){return n.equalMd5Data(e)&&(e.status&&angular.isArray(e.response)?angular.forEach(e.response,function(e){"add_column"===e?i.push({name:"add_column",title:"增加列"}):"delete_column"===e?i.push({name:"delete_column",title:"删除列"}):"column_mapping"===e?i.push({name:"column_mapping",title:"映射列"}):"record_filter"===e?i.push({name:"record_filter",title:"记录过滤"}):"table_audit"===e?i.push({name:"table_audit",title:"审计表"}):"operation_transform"===e&&i.push({name:"operation_transform",title:"操作转换"})}):t.error(e.response.error_msg)),i},function(e){return t.error("网络错误！"),i})},this.saveEtlRules=function(r,a){var o={group:r.gn,component_name:r.cid,user:a.uname,table:a.tname,rules:a.sel,del_rule:a.del},s=[];o=n.md5Data(o),e.postDataList("/dipserver/save_etl_table_rule",o).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),s},function(e){return t.error("网络错误！"),s})},this.fetchEtlAddConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i={};return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_add_config",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;i.dbs=[],i.addList=[],i.bdList=[],i.dbInfo={},r&&(i.dbs=angular.isArray(r.database)?r.database:[],angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={};n.id=t,n.name=e.column_name,n.names=[e.column_name],n.type=e.data_type,"string"===n.type?(n.value=e.column_value,n.desc="固定字符串"):"sysdata"===n.type?(n.value=e.column_value,n.desc="系统变量"):"expression"===n.type&&(n.expression="",e.expression&&(n.expression=Base64.decode(e.expression)),"string"==typeof n.expression&&n.expression.length>20?n.value=n.expression.substring(0,20)+"...":n.value=n.expression,n.connect_db=e.connect_db,n.desc="表达式"),n.checked=!1,n.bdList=[],n.dbInfo={},angular.isArray(e.bind_name)&&(n.bdList=e.bind_name),e.db_info&&angular.isObject(e.db_info)&&(n.dbInfo=e.db_info),i.addList.push(n)}),i.selectTab=[],r.select_tab&&r.select_tab.length>0&&(i.selectTab=r.select_tab))}else t.error(e.response.error_msg);return i},function(e){return t.error("网络错误！"),i})},this.fetchEtlYdzdList=function(r,a,o,s){s=angular.isArray(s)?s:[];var i={group:r.gn,component_name:r.cid,user:a,table:o,db_type:r.pt,db_component_name:r.pn,exist_list:s},c=[];return i=n.md5Data(i),e.postDataList("/dipserver/query_column_list",i).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&angular.isArray(r.list)&&(c=r.list)}else t.error(e.response.error_msg);return c},function(e){return t.error("网络错误！"),c})},this.getTargetDbs=function(t,r){var a=0,s=o.defer(),i=[];if(r&&angular.isArray(r)){var c=[];return angular.forEach(r,function(r,s){var i=o.defer(),l=!1,u={group:t,db_type:r.db_type,db_component_name:r.db_name};l=a<=0;var p={id:s,name:r.db_name,open:l,isParent:!0,children:[]};u=n.md5Data(u),e.postDataList("/dipserver/query_etl_user",u).then(function(e){if(n.equalMd5Data(e)&&e.status){var t=e.response;t&&angular.isArray(t.user)&&angular.forEach(t.user,function(e,t){var n={id:t,name:e,pt:r.db_type,pn:r.db_name,open:!1,isParent:!0,children:[]};p.children.push(n)})}i.resolve(p)},function(e){i.reject(e)}),c.push(i.promise),a++}),o.all(c).then(function(e){angular.forEach(e,function(e){i.push(e)}),s.resolve(i)}),s.promise}return s.resolve([]),s.promise},this.expressionCheck=function(r,a,o,s,i){var c={group:r.gn,db_type:r.pt,db_component_name:r.pn,user:a,table:o,connect_db:s,expression:i},l=[];return c=n.md5Data(c),e.postDataList("/dipserver/legal_check_expression",c).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&angular.isArray(r.column_name)&&(l=r.column_name)}else t.error(e.response.error_msg);return l},function(e){return t.error("网络错误！"),l})},this.saveEtlAddConfig=function(r,a,o,s,i){var c={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s&&angular.isArray(s)?c.other_tables=s:c.other_tables=[],c.map_db_component_name="",c.map_db_type="",c.map_user="",c.map_table="",i&&!$.isEmptyObject(i)&&(c.map_db_component_name=i.map_db_component_name,c.map_db_type=i.map_db_type,c.map_user=i.map_user,c.map_table=i.map_table),c.list=[],angular.forEach(o,function(e){var t={};t.column_name=e.name,t.data_type=e.type,"expression"===e.type?(t.expression=Base64.encode(e.expression),t.connect_db=e.connect_db):t.column_value=e.value,t.bind_name=[],angular.forEach(e.bdList,function(e){e&&t.bind_name.push(e)}),t.db_info=e.dbInfo,c.list.push(t)});var l=[];return c=n.md5Data(c),e.postDataList("/dipserver/save_etl_add_config",c).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),l},function(e){return t.error("网络错误！"),l})},this.fetchEtlTransformConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i=[];return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_transform_config",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;i.dbs=[],i.addList=[],r&&(i.dbs=angular.isArray(r.database)?r.database:[],r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={};n.id=t,n.name=e.column_name,n.names=[e.column_name],n.type=e.data_type,"string"===n.type?(n.value=e.column_value,n.desc="固定字符串"):"sysdata"===n.type&&(n.value=e.column_value,n.desc="系统变量"),n.checked=!1,i.addList.push(n)}),i.selectTab=[],r.select_tab&&r.select_tab.length>0&&(i.selectTab=r.select_tab),i.table_prefix=r.table_prefix?r.table_prefix:"",i.table_suffix=r.table_suffix?r.table_suffix:"",i.keep_copy=r.keep_copy?r.keep_copy:"no")}else t.error(e.response.error_msg);return i},function(e){return t.error("网络错误！"),i})},this.saveEtlTransformConfig=function(r,a,o,s,i,c){var l={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s&&angular.isArray(s)?l.other_tables=s:l.other_tables=[],l.map_db_component_name="",l.map_db_type="",l.map_user="",l.map_table="",i&&!$.isEmptyObject(i)&&(l.map_db_component_name=i.map_db_component_name,l.map_db_type=i.map_db_type,l.map_user=i.map_user,l.map_table=i.map_table),l.table_prefix="",l.table_suffix="",l.keep_copy="",c&&!$.isEmptyObject(c)&&(l.table_prefix=c.table_prefix,l.table_suffix=c.table_suffix,l.keep_copy=c.keep_copy),l.list=[],angular.forEach(o,function(e){var t={};t.column_name=e.name,t.data_type=e.type,"expression"===e.type?(t.expression=Base64.encode(e.expression),t.connect_db=e.connect_db):t.column_value=e.value,t.bind_name=[],angular.forEach(e.bdList,function(e){e&&t.bind_name.push(e)}),t.db_info=e.dbInfo,l.list.push(t)});var u=[];return l=n.md5Data(l),e.postDataList("/dipserver/save_etl_transform_config",l).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),u},function(e){return t.error("网络错误！"),u})},this.fetchEtlConditionConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i={};return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_condition_config",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;i.addList=[],r&&(r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={};n.id=t,n.option=e.option?e.option:"no",n.expression=Base64.decode(e.expression),"string"==typeof n.expression&&n.expression.length>30?n.value=n.expression.substring(0,30)+"...":n.value=n.expression,n.connect_db=e.connect_db,n.checked=!1,n.bdList=[],n.dbInfo={},angular.isArray(e.bind_name)&&(n.bdList=e.bind_name),e.db_info&&angular.isObject(e.db_info)&&(n.dbInfo=e.db_info),i.addList.push(n)}),i.selectTab=[],r.select_tab&&r.select_tab.length>0&&(i.selectTab=r.select_tab))}else t.error(e.response.error_msg);return i},function(e){return t.error("网络错误！"),i})},this.saveEtlConditionConfig=function(r,a,o,s){var i={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s&&angular.isArray(s)?i.other_tables=s:i.other_tables=[],i.list=[],angular.forEach(o,function(e){var t={};t.option=e.option,t.expression=Base64.encode(e.expression),t.connect_db=e.connect_db,t.bind_name=[],angular.forEach(e.bdList,function(e){e&&t.bind_name.push(e)}),t.db_info=e.dbInfo,i.list.push(t)});var c=[];return i=n.md5Data(i),e.postDataList("/dipserver/save_etl_condition_config",i).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),c},function(e){return t.error("网络错误！"),c})},this.fetchEtlDeleteConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i={};return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_delete_config",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;i.addList=[],r&&(r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={};n.id=t,n.name=e.column_name,n.type=e.column_type,i.addList.push(n)}),i.selectTab=[],r.select_tab&&r.select_tab.length>0&&(i.selectTab=r.select_tab))}else t.error(e.response.error_msg);return i},function(e){return t.error("网络错误！"),i})},this.saveEtlDeleteConfig=function(r,a,o,s){var i={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s&&angular.isArray(s)?i.other_tables=s:i.other_tables=[],i.list=[],angular.forEach(o,function(e){var t={};t.column_name=e.name,t.column_type=e.type,i.list.push(t)});var c=[];return i=n.md5Data(i),e.postDataList("/dipserver/save_etl_delete_config",i).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),c},function(){t.error("网络错误！")})},this.fetchEtlMapConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a,table:o},i={};return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_map_config",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;i.addList=[],i.dbs=[],r&&(i.dbs=angular.isArray(r.database)?r.database:[],r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e){var t={};t.name=e.column_name,t.type=e.column_type,t.map=e.map_name,t.mapType=e.column_type,t.value="",t.expression="",e.expression&&(t.expression=Base64.decode(e.expression)),"string"==typeof t.expression&&t.expression.length>30?t.value=t.expression.substring(0,30)+"...":t.value=t.expression,t.connect_db=e.connect_db?e.connect_db:"no",t.bdList=[],t.dbInfo={},e.bind_name&&angular.isArray(e.bind_name)&&(t.bdList=e.bind_name),e.db_info&&angular.isObject(e.db_info)&&(t.dbInfo=e.db_info),i.addList.push(t)}),i.selectTab=[],r.select_tab&&r.select_tab.length>0&&(i.selectTab=r.select_tab))}else t.error(e.response.error_msg);return i},function(e){return t.error("网络错误！"),i})},this.saveEtlMapConfig=function(r,a,o,s,i){var c={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s&&angular.isArray(s)?c.other_tables=s:c.other_tables=[],c.map_db_component_name="",c.map_db_type="",c.map_user="",c.map_table="",i&&!$.isEmptyObject(i)&&(c.map_db_component_name=i.map_db_component_name,c.map_db_type=i.map_db_type,c.map_user=i.map_user,c.map_table=i.map_table),c.list=[],angular.forEach(o,function(e){var t={};t.column_name=e.name,t.column_type=e.type,t.map_name=e.map,t.map_type=e.type,t.expression=Base64.encode(e.expression),t.connect_db=e.connect_db,t.bind_name=[],angular.forEach(e.bdList,function(e){e&&t.bind_name.push(e)}),t.db_info=e.dbInfo,c.list.push(t)});var l=[];return c=n.md5Data(c),e.postDataList("/dipserver/save_etl_map_config",c).then(function(e){return n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg)),l},function(e){return t.error("网络错误！"),l})},this.testDbConnect=function(r){var a=angular.copy(r),o=!1;return a.db_password&&(a.db_password=s.en_des(a.db_password)),a=n.md5Data(a),e.postDataList("/dipserver/test_db_connection",a,0).then(function(e){return n.equalMd5Data(e)&&(e.status?(t.success("数据库连接测试成功！"),o=!0):t.error(e.response.error_msg)),o})},this.getEtlOperationConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,user:a.uname,table:a.tname,oper_type:o},i={};return s=n.md5Data(s),e.postDataList("/dipserver/query_etl_convert",s).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&(i.expression="",r.expression&&(i.expression=Base64.decode(r.expression)),i.connect_db=r.connect_db?r.connect_db:"no",i.bdList=[],i.dbInfo={},r.bind_name&&angular.isArray(r.bind_name)&&(i.bdList=r.bind_name),r.db_info&&angular.isObject(r.db_info)&&(i.dbInfo=r.db_info),i.flags=[],r.add_column&&angular.isArray(r.add_column)&&angular.forEach(r.add_column,function(e,t){i.flags.push({id:t,checked:!1,name:e.name,value:e.value})}),i.selList=[],r.column&&angular.isArray(r.column)&&angular.forEach(r.column,function(e){i.selList.push(e.name)}))}else t.error(e.response.error_msg);return i},function(){return t.error("网络错误！"),i})},this.saveEtlOperationConfig=function(r,a,o){var s={group:r.gn,component_name:r.cid,db_type:r.pt,db_component_name:r.pn,user:a.uname,table:a.tname};s.operation={},s.operation.oper_type=o.oper_type,s.operation.expression=Base64.encode(o.expression),s.operation.connect_db=o.connect_db,s.operation.bind_name=[],angular.forEach(o.bdList,function(e){e&&s.operation.bind_name.push(e)}),s.operation.db_info=o.dbInfo,"deletetoupdate"===s.operation.oper_type&&(s.reserve_all=o.reserve_all,s.add_column=[],angular.forEach(o.flags,function(e){s.add_column.push({name:e.name,type:"string",source:"string",value:e.value})}),"yes"!==s.reserve_all&&(s.reserve_column=o.newList));s=n.md5Data(s),e.postDataList("/dipserver/save_etl_convert",s).then(function(e){n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg))},function(e){t.error("网络错误！")})},this.getEtlBglList=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,user:a},s={};return o=n.md5Data(o),e.postDataList("/dipserver/query_etl_table_filter",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&(s.list=r.list,s.flag=r.flag&&"string"==typeof r.flag?r.flag.toLowerCase():"include",s.tables=r.tables?r.tables:[])}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.saveEltBglRule=function(r,a){var o={group:r.gn,component_name:r.cid,list:a};o=n.md5Data(o),e.postDataList("/dipserver/save_etl_table_filter",o).then(function(e){n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg))},function(e){t.error("网络错误！")})},this.getEtlCzglList=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,user:a},s={};return o=n.md5Data(o),e.postDataList("/dipserver/query_etl_operation_filter",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.list&&(s.list=[],angular.isArray(r.list)&&angular.forEach(r.list,function(e,t){var n={};n.id=t,n.name=e.tab_name,n.tab_ins=e.tab_ins,n.tab_del=e.tab_del,n.tab_upt=e.tab_upt,n.expression=e.expression?Base64.decode(e.expression):"",n.connect_db=e.connect_db?e.connect_db:"no",n.bdList=[],n.dbInfo={},e.bdList&&angular.isArray(e.bdList)&&(n.bdList=e.bdList),e.dbInfo&&angular.isObject(e.dbInfo)&&(n.dbInfo=e.dbInfo),s.list.push(n)}))}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.saveEtlCzglRule=function(r,a){var o=[],s=angular.copy(a);angular.forEach(s,function(e){angular.forEach(e.list,function(e){e.expression&&(e.expression=Base64.encode(e.expression))}),o.push({user:e.user,list:e.list})});var i={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,list:o};i=n.md5Data(i),e.postDataList("/dipserver/save_etl_operation_filter",i).then(function(e){n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg))},function(e){t.error("网络错误！")})},this.getBatchRules=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,rule_type:a.rule_type,batch_name:a.batch_name},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_batch_rule",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.rules&&angular.isArray(r.rules)&&angular.forEach(r.rules,function(e,t){var n={};n.list=[],e.list&&angular.isArray(e.list)&&(n.list=e.list),n.id=t,n.coder=e.coder,n.checked=!1,n.resered=e.resered?e.resered:"yes",n.expression=e.expression?Base64.decode(e.expression):"",n.value=e.value?e.value:"",n.connect_db=e.connect_db?e.connect_db:"no",n.bdList=[],n.dbInfo={},e.bdList&&angular.isArray(e.bdList)&&(n.bdList=e.bdList),e.db_info&&angular.isObject(e.db_info)&&(n.dbInfo=e.db_info),s.push(n)})}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.saveBatchRules=function(r,a,o,s){var i={group:r.gn,db_component_name:r.pn,db_type:r.pt,rule_type:a,batch_name:o,rules:s};return i=n.md5Data(i),e.postDataList("/dipserver/save_batch_rule",i).then(function(e){n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg))},function(e){t.error("网络错误！")})},this.fetchBatchs=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,rule_type:a},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_batch",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.batch_name&&angular.isArray(r.batch_name)&&(s=r.batch_name)}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.fetchSettingRule=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,rule_type:a},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_etl_rule_ptable",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;"table_filter"===a?r&&angular.isArray(r.include)&&angular.isArray(r.exclude)&&(angular.forEach(r.include,function(e){s.push({user:e.user,table:e.table,type:"include"})}),angular.forEach(r.exclude,function(e){s.push({user:e.user,table:e.table,type:"exclude"})})):r&&r.list&&angular.isArray(r.list)&&(s=r.list)}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.getBatchCheckedList=function(r,a){var o={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,rule_type:a},s=[];return o=n.md5Data(o),e.postDataList("/dipserver/query_batch_checked",o).then(function(e){if(n.equalMd5Data(e))if(e.status){var r=e.response;r&&r.list&&angular.isArray(r.list)&&angular.forEach(r.list,function(e){var t={};if(t.name=e.name?e.name:"",t.checked=(e.checked,e.checked),t.codes=[],e.codes&&angular.isArray(e.codes)){var n=angular.extend(e.codes);angular.forEach(n,function(e,t){e.id=t,e.checked=!1}),t.codes=n}s.push(t)})}else t.error(e.response.error_msg);return s},function(e){return t.error("网络错误！"),s})},this.saveBatchInfo=function(r,a,o){var s=[];angular.forEach(o,function(e){e.checked&&s.push(e)});var i={group:r.gn,db_component_name:r.pn,db_type:r.pt,component_name:r.cid,rule_type:a,batchRules:s};i=n.md5Data(i),e.postDataList("/dipserver/save_batch_codevalue",i).then(function(e){n.equalMd5Data(e)&&(e.status?t.success("保存成功！"):t.error(e.response.error_msg))},function(e){t.error("网络错误！")})},this.getSourceUserTree=function(t){var r={group:t.gn,db_component_name:t.pn,db_type:t.pt},a=[];return r=n.md5Data(r),e.postDataList("/dipserver/query_etl_user",r).then(function(e){if(n.equalMd5Data(e)&&e.status){var r=e.response;r&&angular.isArray(r.user)&&angular.forEach(r.user,function(e,n){var r={id:n,name:e,pt:t.pt,pn:t.pn,open:!1,isParent:!0,children:[]};a.push(r)})}return a},function(){return a})}}])}(),function(){angular.module("myApp.component",["ui.bootstrap"]).component("etlView",{templateUrl:"etl_view/main.component.html",controller:["$stateParams","$location","$state",function(e,t,n){var r=this;r.state=n,r.dialog=!0,r.current=1,r.state.includes("*.etl_view.status.**")&&(r.current=1),r.state.includes("*.etl_view.property.**")&&(r.current=2),r.redirectTo=function(){n.go("/")},r.changeTo=function(e){var n=t.url();if("status"===e){var a=t.path();n=n.replace(a,"/main/etl_view/status"),r.current=1}else r.current=2,n=n.replace("status","property/config");t.url(n)}}]}).component("etlStatus",{templateUrl:"etl_view/etl_status.component.html",bindings:{conf:"<"},controller:["$state",function(e){this.etl={etl_id:"",etl_name:"",etl_char:"",etl_nchar:"",etl_clob:"",etl_nclob:"",etl_jg:"",etl_gs:"no",etl_zh:"",isGs:!1},this.$onInit=function(){var t=this.conf.data;t?(t.cset&&(this.etl.etl_char=t.cset.real_charset),t.ncset&&(this.etl.etl_nchar=t.ncset.real_ncharset),t.cbset&&(this.etl.etl_clob=t.cbset.real_clobset),t.ncbset&&(this.etl.etl_nclob=t.ncbset.real_nclobset),t.tset&&(this.etl.etl_zh=t.tset.real_tar_set),this.etl.etl_jg=t.interval+"秒",t.full_string?(this.etl.etl_gs="yes"===t.full_string?"是":"否",this.etl.isGs="yes"===t.full_string):this.etl.etl_gs="否",this.etl.etl_id=this.conf.etl_id,this.etl.etl_name=this.conf.etl_name):e.go("/")},this.params={filed:!1,filed1:!1,filed2:!1,filed3:!1,filed4:!1,filed5:!1,filed6:!1,filed7:!1,filed8:!1}}]}).component("etlProperty",{templateUrl:"etl_view/etl_property.component.html",controller:["$stateParams","$state","tipsService",function(e,t,n){this.etl_title="ETL属性";var r=e,a=!1
;r.cid&&"undefined"!==r.cid&&"unnamed"!==r.cn||(a=!0),this.changeJob=function(e){if(e>1&&a)return void n.error("配置Etl规则之前请先完成Etl属性的配置！");switch(e){case 1:this.etl_title="ETL属性";break;case 2:this.etl_title="规则配置",t.go("/.etl_view.property.rule");break;case 3:this.etl_title="表过滤",t.go("/.etl_view.property.bgl");break;case 4:this.etl_title="操作过滤",t.go("/.etl_view.property.operate");break;case 5:this.etl_title="批量配置",t.go("/.etl_view.property.batch");break;case 6:this.etl_title="已配置规则",t.go("/.etl_view.property.configured");break;case 7:this.etl_title="批量配置值绑定",t.go("/.etl_view.property.pl_rule_apply");break;default:this.etl_title="ETL属性"}}}]}).component("etlConf",{templateUrl:"etl_view/config.component.html",bindings:{conf:"<"},controller:["$stateParams","etlService","$state",function(e,t,n){var r=e,a=this;a.pool={},a.etl={etl_id:"",etl_name:"",etl_char:"",etl_nchar:"",etl_clob:"",etl_nclob:"",etl_jg:5,etl_gs:"no",etl_zh:""},a.etlGsTip="如果进行同构数据同步，“转换通用格式”选中“否”选项，否则blob类型数据同步会发生异常。",a.params={filed:!1,filed1:!1,filed2:!1,filed3:!1,filed4:!1,filed5:!1,filed6:!1,filed7:!1,filed8:!1},a.idSave=!1,a.$onInit=function(){if(a.conf.data&&!a.conf.init){var e=a.conf.data;a.pool.char_list=[],e.cset&&(a.pool.char_list=angular.isArray(e.cset.charset)?e.cset.charset:[],a.etl.etl_char=e.cset.real_charset),a.pool.nchar_list=[],e.ncset&&(a.pool.nchar_list=angular.isArray(e.ncset.ncharset)?e.ncset.ncharset:[],a.etl.etl_nchar=e.ncset.real_ncharset),a.pool.clob_list=[],e.cbset&&(a.pool.clob_list=angular.isArray(e.cbset.clobset)?e.cbset.clobset:[],a.etl.etl_clob=e.cbset.real_clobset),a.pool.nlob_list=[],e.ncbset&&(a.pool.nlob_list=angular.isArray(e.ncbset.nclobset)?e.ncbset.nclobset:[],a.etl.etl_nclob=e.ncbset.real_nclobset),a.pool.zh_list=[],e.tset&&(a.pool.zh_list=angular.isArray(e.tset.tar_set)?e.tset.tar_set:[],a.etl.etl_zh=e.tset.real_tar_set),a.etl.etl_jg=parseInt(e.interval)?parseInt(e.interval):5,a.etl.etl_gs="yes"===e.full_string?"yes":"no",a.etl.etl_id=a.conf.etl_id,a.etl.etl_name=a.conf.etl_name}},a.saveEtlConfig=function(){a.idSave=!0,t.saveEtlConfig(r,a.etl,n).finally(function(){a.idSave=!1})}}]}).component("etlRule",{templateUrl:"etl_view/rule.component.html",bindings:{users:"<"},controller:["$stateParams","etlService","tipsService","$uibModal",function(e,t,n,r){var a=this;a.animationsEnabled=!0,this.u_filter="",this.t_filter="",this.tables=[],this.current_user="",this.current_table="",this.current_map="/",this.rules=[],this.ckAll={checked:!1,read:!1},a.onLoading=!1,this.ckSon=[{checked:!1,read:!1},{checked:!1,read:!1},{checked:!1,read:!1},{checked:!1,read:!1},{checked:!1,read:!1},{checked:!1,read:!1}],this.$onInit=function(){this.users&&angular.isArray(this.users)||(this.users=[])},a.editRuleInfo=function(e){"add_column"===e?a.openAddModal():"delete_column"===e?a.openDeleteModal():"column_mapping"===e?a.openMapModal():"record_filter"===e?a.openConditionModal():"table_audit"===e?a.openTransformModal():"operation_transform"===e&&a.openOperationModal()},a.openAddModal=function(){r.open({animation:a.animationsEnabled,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",component:"etlAddRule",controller:["$uibModalInstance",function(e){}],size:"lg",resolve:{items:function(){return t.fetchEtlAddConfig(e,a.current_user,a.current_table)},clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.openTransformModal=function(){r.open({animation:a.animationsEnabled,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",component:"transformModal",size:"lg",resolve:{items:function(){return t.fetchEtlTransformConfig(e,a.current_user,a.current_table)},clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.openConditionModal=function(){r.open({animation:a.animationsEnabled,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",component:"conditionModal",controller:["$uibModalInstance",function(e){}],size:"lg",resolve:{items:function(){return t.fetchEtlConditionConfig(e,a.current_user,a.current_table)},clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.openDeleteModal=function(){r.open({animation:a.animationsEnabled,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",component:"deleteModal",size:"lg",resolve:{items:function(){return t.fetchEtlDeleteConfig(e,a.current_user,a.current_table)},clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.openMapModal=function(){r.open({animation:a.animationsEnabled,component:"mapModal",size:"lg",resolve:{items:function(){return t.fetchEtlMapConfig(e,a.current_user,a.current_table)},clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.openOperationModal=function(){r.open({animation:a.animationsEnabled,component:"operationModal",size:"lg",resolve:{clist:function(){return t.fetchEtlYdzdList(e,a.current_user,a.current_table)},comInfo:function(){return e},current:function(){return{uname:a.current_user,tname:a.current_table}}}})},a.showRules=function(){var e=a.ckSon,t=a.rules;angular.forEach(e,function(n,r){e[r]={checked:!1,read:!1},angular.forEach(t,function(t){"add_column"===t.name?e[0]={checked:!0,read:!0}:"delete_column"===t.name?e[1]={checked:!0,read:!0}:"column_mapping"===t.name?e[2]={checked:!0,read:!0}:"record_filter"===t.name?e[3]={checked:!0,read:!0}:"table_audit"===t.name?e[4]={checked:!0,read:!0}:"operation_transform"===t.name&&(e[5]={checked:!0,read:!0})})}),$("#dialog_confirm_map").modal("show"),$(".modal-backdrop").appendTo("#etl_rule_id")},a.showTables=function(n){a.current_user=n,a.current_map=n,e&&e.gn&&(a.onLoading=!0,a.tables=[],t.fetchEtlTable(e,n).then(function(e){a.tables=e}).finally(function(){a.onLoading=!1}))},a.getRuleByName=function(r){if(a.current_table=r,!a.current_table)return void n.warning("请选择表！");a.current_map=a.current_user+" > "+r,t.getRuleByName(e,a.current_user,a.current_table).then(function(e){a.rules=e})},a.saveEtlTableRules=function(){if(!a.current_user)return void n.warning("请选择用户！");if(!a.current_table)return void n.warning("请选择表！");var r={};r.uname=a.current_user,r.tname=a.current_table,r.sel=a.rules,t.saveEtlRules(e,r)},a.changeCA=function(){a.ckAll.checked?angular.forEach(a.ckSon,function(e,t){e.checked=!0}):angular.forEach(a.ckSon,function(e,t){e.checked=!1})},a.sonChange=function(e){var t=!0;a.ckSon[e].checked?(angular.forEach(a.ckSon,function(n,r){r===e||n.checked||(t=!1)}),t&&(a.ckAll.checked=!0)):a.ckAll.checked=!1},a.appendRules=function(){angular.forEach(a.ckSon,function(e,t){if(e.checked&&!e.read){var n={};0===t?(n.name="add_column",n.title="增加列"):1===t?(n.name="delete_column",n.title="删除列"):2===t?(n.name="column_mapping",n.title="映射列"):3===t?(n.name="record_filter",n.title="记录过滤"):4===t?(n.name="table_audit",n.title="审计表"):5===t&&(n.name="operation_transform",n.title="操作转换"),a.rules.push(n)}}),$("#dialog_confirm_map").modal("hide")},a.deleteRules=function(n){var r=function(){var r=a.rules[n].name;a.rules.splice(n,1);var o={};o.uname=a.current_user,o.tname=a.current_table,o.sel=[],o.del=r,t.saveEtlRules(e,o)};BootstrapDialog.confirm({title:"Dip 提示",message:"确认要删除该规则吗？",type:BootstrapDialog.TYPE_WARNING,btnCancelLabel:"取消",btnOKLabel:"确认",btnOKClass:"btn-warning",callback:function(e){e&&r()}})}}]}).component("etlAddRule",{templateUrl:"etl_view/add_rule.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","$log","etlService","tipsService","graphicService",function(e,t,n,r,a){var o=this;o.ckAll=!1,o.addList=[],o.model={},o.targetTreeJson=[],o.targetLabel="",o.otherTables=[],o.selectTab=[],o.mapInfo={},o.$onInit=function(){o.config=this.resolve.items,o.comInfo=this.resolve.comInfo,o.current=this.resolve.current,o.fieldList=this.resolve.clist,o.addList=o.config.addList;var e=[],t=a.getRealIdBySourceId(o.comInfo.id,"database");angular.forEach(o.config.dbs,function(n){t&&n.db_name===t[0]&&e.push(n)}),n.getTargetDbs(o.comInfo.gn,e).then(function(e){o.targetTreeJson=e}),o.selectTab=o.config.selectTab},o.cancel=function(){o.dismiss({$value:"cancel"})},o.editColumn=function(t){o.model.name=t.name,o.model.type=t.type,o.model.id=t.id,"expression"!==t.type?o.model.value=t.value:"expression"===t.type&&(o.model.row={bdList:t.bdList,clist:o.resolve.clist,dbInfo:t.dbInfo,expression:t.expression,connect_db:t.connect_db}),e.open({ariaLabelledBy:"modal-title1",ariaDescribedBy:"modal-body1",templateUrl:"myModalContent.html",controller:["$uibModalInstance","model",function(e,t){var n=this;n.model=t,n.ok=function(){n.model.cz="add",e.close(n.model)},n.cancel=function(){e.dismiss("cancel")},n.edit=function(){n.model.cz="edit",e.close(n.model)}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{model:function(){return o.model}}}).result.then(function(e){o.model.name=e.name,o.model.type=e.type,angular.forEach(o.addList,function(t){t.id===e.id&&(t.names=[],t.names.push(e.name),t.name=e.name,t.type=e.type,"string"===e.type?(t.value=e.value,t.desc="固定字符串"):"sysdata"===e.type?(t.value=e.value,t.desc="系统变量"):"expression"===e.type&&(t.value="",t.desc="表达式"))}),"expression"===e.type&&"edit"===e.cz&&(o.model.row||(o.model.row={bdList:[],dbInfo:{},clist:o.resolve.clist,expression:"",connect_db:"yes"}),o.openExpressPanel(o.model))})},o.openExpressPanel=function(t){e.open({component:"expressionPanel",size:"lg",resolve:{row:function(){return t.row},comInfo:function(){return o.comInfo},current:function(){return o.current},type:function(){return"normal"}}}).result.then(function(e){o.model.row=e,o.saveExp(e)})},o.addColumn=function(){var e={},t=0;o.addList.length>0&&(t=o.addList[o.addList.length-1].id+1),e.id=t,e.checked=!1,e.name="",e.names=[""],e.type="string",e.desc="固定字符串",e.value="",o.addList.push(e)},o.deleteColumn=function(){if($("input.cl-etl-input:checked").length>0){var e=angular.copy(o.addList),t=[];angular.forEach(e,function(e){e.checked||t.push(e)}),o.addList=t,o.ckAll=!1}else r.warning("请选择要删除的列表！")},o.changeAllCheck=function(){angular.forEach(o.addList,function(e){e.checked=o.ckAll})},o.changeOne=function(e){var t=0;e.checked?(angular.forEach(o.addList,function(e){e.checked&&t++}),t===o.addList.length&&(o.ckAll=!0)):o.ckAll=!1},o.editItemInfo=function(e){},o.saveExp=function(e){angular.forEach(o.addList,function(t){t.id===o.model.id&&"expression"===o.model.type&&(t.desc="表达式","string"==typeof e.expression&&e.expression.length>20?t.value=e.expression.substring(0,20)+"...":t.value=e.expression,t.connect_db=e.connect_db,t.expression=e.expression,t.bdList=e.bdList,t.dbInfo=e.dbInfo)})},o.saveAddRule=function(){var e=[];if(angular.forEach(o.addList,function(t){t.name&&t.value&&e.push(t)}),0===e.length)return void r.error("请添加至少一条规则并且确保字段名称、字段值不能为空！");n.saveEtlAddConfig(o.comInfo,o.current,e,o.otherTables,o.mapInfo),o.close()},Array.prototype.unique=function(){for(var e=[],t={},n=0;n<this.length;n++)t[this[n]]||(e.push(this[n]),t[this[n]]=1);return e},o.openTargetsModal=function(){e.open({component:"targetTree",windowClass:"small-modal-panel",size:"sm",resolve:{jsonTree:function(){return o.targetTreeJson},comInfo:function(){return o.comInfo}}}).result.then(function(e){if(e){o.targetLabel=e.map_db_com_name+" 库 > "+e.map_user+"."+e.map_table,o.mapInfo=e;var t=[];angular.forEach(o.fieldList,function(e){t.push({column_name:e.column_name})});var r=angular.copy(o.comInfo);r.pn=e.map_db_com_name,n.fetchEtlYdzdList(r,e.map_user,e.map_table,t).then(function(e){var t=[];angular.forEach(e,function(e){t.push(e.column_name)}),angular.forEach(o.addList,function(e){var n=e.names.concat(t);e.names=n.unique()})})}else o.mapInfo={}})},o.openApplyToModal=function(){e.open({component:"applyToOther",windowClass:"small-modal-panel",size:"sm",resolve:{tables:function(){return n.fetchEtlTable(o.comInfo,o.current.uname)},selected:function(){return o.selectTab}}}).result.then(function(e){o.otherTables=[],angular.forEach(e,function(e){o.otherTables.push(e.name)})})}}]}).component("expressionPanel",{templateUrl:"etl_view/expression.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$uibModal","etlService",function(e,t){var n=this;n.$onInit=function(){n.bindNameVisble=!1,n.row=this.resolve.row,n.current=this.resolve.current,n.comInfo=this.resolve.comInfo,n.model={},n.row&&(n.model=n.row.dbInfo),n.isAllowTable=!1,this.resolve.allowTable&&(n.isAllowTable=!0),n.row.connect_db||(n.row.connect_db="yes"),n.type=n.resolve.type||"normal"},n.insertToText=function(e){e="yes"===n.row.connect_db?":"+e:"{"+e+"}";var t=$("#bjq_expression");t.focus().insertToText(e),n.row.expression=t.val()},n.dbConfig=function(){e.open({component:"databaseModal",size:"md",resolve:{model:function(){return n.model}}}).result.then(function(e){n.row.dbInfo=e})},n.checkExpression=function(){var e=Base64.encode(n.row.expression);t.expressionCheck(n.comInfo,n.current.uname,n.current.tname,n.row.connect_db,e).then(function(e){n.row.bdList=e})},n.saveExpression=function(){var e=Base64.encode(n.row.expression);t.expressionCheck(n.comInfo,n.current.uname,n.current.tname,n.row.connect_db,e).then(function(e){n.row.bdList=e}).finally(function(){n.close({$value:n.row})})},n.cancel=function(){n.dismiss({$value:"cancel"})},n.selectOneTable=function(){e.open({component:"targetTree",size:"sm",resolve:{jsonTree:function(){return t.getSourceUserTree(n.comInfo)},comInfo:function(){return n.comInfo},title:function(){return"选择单个表"}}}).result.then(function(e){n.current.uname=e.map_user,n.current.tname=e.map_table,t.fetchEtlYdzdList(n.comInfo,e.map_user,e.map_table).then(function(e){n.row.clist=e,n.bindNameVisble=!0})})}}]}).component("targetTree",{templateUrl:"etl_view/target_tree.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$log","tipsService",function(e,t){function n(e,t,n){if(n&&!n.isParent){var a=n.getParentNode();r.targetInfo={map_db_com_name:a.pn,map_db_type:a.pt,map_user:a.name,map_table:n.name}}}var r=this,a={view:{selectedMulti:!1},async:{enable:!0,url:"/dipserver/query_etl_table",autoParam:[],otherParam:{},type:"get",contentType:"application/json",dataFilter:function(e,t,n){var r=[];return n&&n.status&&n.response&&angular.isArray(n.response.tables)&&angular.forEach(n.response.tables,function(e,t){r.push({id:t,name:e})}),r}},callback:{onClick:n}};r.$onInit=function(){r.jsonTree=r.resolve.jsonTree,r.comInfo=r.resolve.comInfo,r.title="目标库列表",r.resolve.title&&(r.title=r.resolve.title),r.targetInfo={},a.async.autoParam=["name=user","pt=db_type","pn=db_component_name"],a.async.otherParam={group:r.comInfo.gn},$.fn.zTree.init($("#etlTargetTree"),a,r.jsonTree)},r.ok=function(){if(!r.targetInfo.map_db_com_name||!r.targetInfo.map_user||!r.targetInfo.map_table)return void t.warning("您未选中任何目标表！");r.close({$value:r.targetInfo})},r.cancel=function(){r.dismiss({$value:"cancel"})}}]}).component("applyToOther",{templateUrl:"etl_view/apply_other.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$log",function(e){var t=this;t.tables=[],t.ckAll=!1,t.localDics=[],t.$onInit=function(){t.resolve.tables&&angular.isArray(t.resolve.tables)&&angular.forEach(t.resolve.tables,function(e){var n={};n.name=e,n.checked=t.resolve.selected.length>0&&$.inArray(e,t.resolve.selected)>=0,t.tables.push(n)})},t.checkAll=function(){angular.forEach(t.localDics,function(e){e.checked=t.ckAll})},t.selectOne=function(e){var n=0;e.checked?(angular.forEach(t.localDics,function(e){e.checked&&n++}),t.tables.length===n&&(t.ckAll=!0)):t.ckAll=!1},t.ok=function(){var e=[];angular.forEach(t.localDics,function(t){t.checked&&e.push(t)}),t.close({$value:e})},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}).component("transformModal",{templateUrl:"etl_view/transform.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","$log","etlService","tipsService","graphicService",function(e,t,n,r,a){var o=this;o.ckAll=!1,o.addList=[],o.model={},o.targetTreeJson=[],o.targetLabel="",o.otherTables=[],o.mapInfo={},o.transInfo={},o.selectTab=[],o.$onInit=function(){o.config=this.resolve.items,o.comInfo=this.resolve.comInfo,o.current=this.resolve.current,o.fieldList=this.resolve.clist,o.config?(o.addList=o.config.addList,o.transInfo.table_prefix=o.config.table_prefix,o.transInfo.table_suffix=o.config.table_suffix,o.transInfo.keep_copy=o.config.keep_copy,o.selectTab=o.config.selectTab):(o.config={},o.config.dbs=[]);var e=[],t=a.getRealIdBySourceId(o.comInfo.id,"database");angular.forEach(o.config.dbs,function(n){t&&n.db_name===t[0]&&e.push(n)}),n.getTargetDbs(o.comInfo.gn,e).then(function(e){o.targetTreeJson=e})},o.cancel=function(){o.dismiss({$value:"cancel"})},o.editColumn=function(t){o.model.name=t.name,o.model.type=t.type,o.model.id=t.id,o.model.value=t.value,e.open({templateUrl:"transformModal.html",controller:["$uibModalInstance","model",function(e,t){var n=this;n.model=t,n.ok=function(){n.model.cz="add",e.close(n.model)},n.cancel=function(){e.dismiss("cancel")},n.edit=function(){n.model.cz="edit",e.close(n.model)}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{model:function(){return o.model}}}).result.then(function(e){o.model.name=e.name,o.model.type=e.type,angular.forEach(o.addList,function(t){t.id===e.id&&(t.names=[],t.names.push(e.name),t.name=e.name,t.type=e.type,"string"===e.type?(t.value=e.value,t.desc="固定字符串"):"sysdata"===e.type&&(t.value=e.value,t.desc="系统变量"))})})},o.addColumn=function(){var e={},t=0;o.addList.length>0&&(t=o.addList[o.addList.length-1].id+1),e.id=t,e.checked=!1,e.name="",e.names=[""],e.type="string",e.desc="固定字符串",e.value="",o.addList.push(e)},o.deleteColumn=function(){if($("input.cl-etl-input:checked").length>0){var e=angular.copy(o.addList),t=[];angular.forEach(e,function(e){e.checked||t.push(e)}),o.addList=t,o.ckAll=!1}else r.warning("请选择要删除的列表！")},o.changeAllCheck=function(){angular.forEach(o.addList,function(e){e.checked=o.ckAll})},o.changeOne=function(e){var t=0;e.checked?(angular.forEach(o.addList,function(e){e.checked&&t++}),t===o.addList.length&&(o.ckAll=!0)):o.ckAll=!1},o.editItemInfo=function(e){},o.saveTransformRule=function(){var e=[];if(angular.forEach(o.addList,function(t){t.name&&t.value&&e.push(t)}),0===e.length)return void r.error("请添加至少一条规则并且确保字段名称、字段值不能为空！");n.saveEtlTransformConfig(o.comInfo,o.current,e,o.otherTables,o.mapInfo,o.transInfo),o.close()},Array.prototype.unique=function(){for(var e=[],t={},n=0;n<this.length;n++)t[this[n]]||(e.push(this[n]),t[this[n]]=1);return e},o.openTargetsModal=function(){e.open({component:"targetTree",windowClass:"small-modal-panel",size:"sm",resolve:{jsonTree:function(){return o.targetTreeJson},comInfo:function(){return o.comInfo}}}).result.then(function(e){if(e){o.targetLabel=e.map_db_com_name+" 库 > "+e.map_user+"."+e.map_table,o.mapInfo=e;var t=[];angular.forEach(o.fieldList,function(e){t.push({column_name:e.column_name})});var r=angular.copy(o.comInfo);r.pn=e.map_db_com_name,n.fetchEtlYdzdList(r,e.map_user,e.map_table,t).then(function(e){var t=[];angular.forEach(e,function(e){t.push(e.column_name)}),angular.forEach(o.addList,function(e){var n=e.names.concat(t);e.names=n.unique()})})}else o.mapInfo={}})},o.openApplyToModal=function(){e.open({component:"applyToOther",windowClass:"small-modal-panel",size:"sm",resolve:{tables:function(){return n.fetchEtlTable(o.comInfo,o.current.uname)},selected:function(){return o.selectTab}}}).result.then(function(e){o.otherTables=[],angular.forEach(e,function(e){o.otherTables.push(e.name)})})}}]}).component("conditionModal",{templateUrl:"etl_view/condition.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","$log","etlService","tipsService",function(e,t,n,r){var a=this;a.ruleTip="选择保留:是指只复制符合表达式条件的数据，不符合条件的会被丢弃；选择不保留:是指将符合表达式条件的数据丢弃，其它数据会被复制。",a.utInfo="",a.ckAll=!1,a.addList=[],a.clist=[],a.editRow={},a.comInfo={},a.current={},a.otherTables=[],a.selectTab=[],a.$onInit=function(){a.resolve&&(a.config=a.resolve.items,a.addList=a.config.addList,a.clist=a.resolve.clist,a.comInfo=a.resolve.comInfo,a.current=a.resolve.current,a.utInfo=a.current.uname+"."+a.current.tname,a.selectTab=a.config.selectTab)},a.editColumn=function(e){a.editRow={id:e.id,bdList:e.bdList,clist:a.clist,dbInfo:e.dbInfo,expression:e.expression,connect_db:e.connect_db},a.openExpressPanel(a.editRow)},a.openExpressPanel=function(t){e.open({component:"expressionPanel",size:"lg",resolve:{row:function(){return t},comInfo:function(){return a.comInfo},current:function(){return a.current},type:function(){return"large"}}}).result.then(function(e){a.editRow=e,a.updateList(e)})},a.updateList=function(e){angular.forEach(a.addList,function(t){t.id===e.id&&(e.expression.length>45?t.value=e.expression.substring(0,45)+"...":t.value=e.expression,t.connect_db=e.connect_db,t.expression=e.expression,t.bdList=e.bdList)})},a.saveConditionRule=function(){var e=[];if(angular.forEach(a.addList,function(t){t.value&&e.push(t)}),0===e.length)return void r.error("请添加至少一条规则并且确保表达式不能为空！");n.saveEtlConditionConfig(a.comInfo,a.current,e,a.otherTables),a.close()},a.changeAll=function(){angular.forEach(a.addList,function(e){e.checked=a.ckAll})},a.changeOne=function(e){var t=0;e.checked?(angular.forEach(a.addList,function(e){e.checked&&t++}),t===a.addList.length&&(a.ckAll=!0)):a.ckAll=!1},a.addColumn=function(){var e={},t=1,n=a.addList.length;n>0&&(t=a.addList[n-1].id+1),e.id=t,e.checked=!1,e.value="",e.expression="",e.option="yes",e.connect_db="no",e.bdList=[],e.dbInfo={},a.addList.push(e)},a.deleteColumn=function(){if($("input.etl-condition-son:checked").length>0){var e=angular.copy(a.addList),t=[];angular.forEach(e,function(e){e.checked||t.push(e)}),a.addList=t,a.ckAll=!1}else r.warning("请选择要删除的列表！")},a.cancel=function(){a.dismiss({$value:"cancel"})},a.openApplyToModal=function(){e.open({component:"applyToOther",windowClass:"small-modal-panel",size:"sm",resolve:{tables:function(){return n.fetchEtlTable(a.comInfo,a.current.uname)},selected:function(){return a.selectTab}}}).result.then(function(e){a.otherTables=[],angular.forEach(e,function(e){a.otherTables.push(e.name)})})}}]}).component("deleteModal",{templateUrl:"etl_view/delete.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","$log","etlService","tipsService",function(e,t,n,r){var a=this;a.utInfo="",a.ckAll=!1,a.addList=[],a.clist=[],a.editRow={},a.comInfo={},a.current={},a.otherTables=[],a.selList=[],a.selectTab=[],a.$onInit=function(){a.resolve&&(a.config=a.resolve.items,a.clist=a.resolve.clist,angular.forEach(a.clist,function(e){var t={};t.checked=!1,angular.forEach(a.config.addList,function(n){n.name===e.column_name&&(t.checked=!0)}),t.name=e.column_name,t.type=e.column_type,a.addList.push(t)}),a.comInfo=a.resolve.comInfo,a.current=a.resolve.current,a.utInfo=a.current.uname+"."+a.current.tname,a.selectTab=a.config.selectTab)},a.saveDeleteRule=function(){var e=[];if(angular.forEach(a.addList,function(t){t.checked&&e.push(t)}),0===e.length)return void r.error("请选择要保存的数据！");n.saveEtlDeleteConfig(a.comInfo,a.current,e,a.otherTables),a.close()},a.changeAll=function(){angular.forEach(a.selList,function(e){e.checked=a.ckAll})},a.changeOne=function(e){var t=0;e.checked?(angular.forEach(a.selList,function(e){e.checked&&t++}),t===a.addList.length&&(a.ckAll=!0)):a.ckAll=!1},a.deleteColumn=function(){if($("input.etl-condition-son:checked").length>0){var e=angular.copy(a.addList),t=[];angular.forEach(e,function(e){e.checked||t.push(e)}),a.addList=t,a.ckAll=!1}else r.warning("请选择要删除的列表！")},a.cancel=function(){a.dismiss({$value:"cancel"})},a.openApplyToModal=function(){e.open({component:"applyToOther",windowClass:"small-modal-panel",size:"sm",resolve:{tables:function(){return n.fetchEtlTable(a.comInfo,a.current.uname)},selected:function(){return a.selectTab}}}).result.then(function(e){a.otherTables=[],angular.forEach(e,function(e){a.otherTables.push(e.name)})})}}]}).component("mapModal",{templateUrl:"etl_view/map.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["$uibModal","$log","etlService","tipsService","graphicService",function(e,t,n,r,a){var o=this;o.ckAll=!1,o.addList=[],o.clist=[],o.editRow={},o.comInfo={},o.current={},o.otherTables=[],o.selList=[],o.targetLabel="",o.mapInfo={},o.targetTreeJson=[],o.selectTab=[],o.$onInit=function(){if(o.resolve){o.config=o.resolve.items,o.clist=o.resolve.clist,o.comInfo=o.resolve.comInfo,o.current=o.resolve.current;var e=[],t=a.getRealIdBySourceId(o.comInfo.id,"database");angular.forEach(o.config.dbs,function(n){t&&n.db_name===t[0]&&e.push(n)}),n.getTargetDbs(o.comInfo.gn,e).then(function(e){o.targetTreeJson=e}),angular.forEach(o.clist,function(e,t){var n={};n.id=t,n.checked=!1,n.map="",n.mapType="",n.maps=[],n.value="",n.expression="",n.connect_db="no",n.bdList=[],n.dbInfo={},n.name=e.column_name,n.type=e.column_type,angular.forEach(o.config.addList,function(t){t.name===e.column_name&&(n.checked=!0,n.map=t.map,n.mapType=t.mapType,n.maps.push(t.map),n.value=t.value,n.expression=t.expression,n.connect_db=t.connect_db,n.bdList=t.bdList,n.dbInfo=t.dbInfo)}),o.addList.push(n)}),o.selectTab=o.config.selectTab}},o.editColumn=function(t){e.open({templateUrl:"etlMapModal.html",controller:["$uibModalInstance","model",function(e,t){var n=this;n.model=t,n.ok=function(){n.model.cz="add",e.close(n.model)},n.cancel=function(){e.dismiss("cancel")},n.edit=function(){n.model.cz="edit",e.close(n.model)}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{model:function(){return t}}}).result.then(function(e){if(angular.forEach(o.addList,function(t){t.id===e.id&&(e.map?(t.maps=[],t.maps.push(e.map),t.map=e.map,t.checked=!0):t.checked=!1)}),"edit"===e.cz){var t={};t.row={id:e.id,bdList:e.bdList,dbInfo:e.dbInfo,clist:o.resolve.clist,expression:e.expression,connect_db:e.connect_db},o.openExpressPanel(t)}})},o.openExpressPanel=function(t){e.open({component:"expressionPanel",size:"lg",resolve:{row:function(){return t.row},comInfo:function(){return o.comInfo},current:function(){return o.current},type:function(){return"normal"}}}).result.then(function(e){o.saveExp(e)})},o.saveExp=function(e){angular.forEach(o.addList,function(t){t.id===e.id&&(e.expression.length>30?t.value=e.expression.substring(0,30)+"...":t.value=e.expression,t.connect_db=e.connect_db,t.expression=e.expression,t.bdList=e.bdList,t.dbInfo=e.dbInfo)})},o.saveMapRule=function(){var e=[];if(angular.forEach(o.addList,function(t){t.checked&&t.map&&e.push(t)}),0===e.length)return void r.error("请选择要保存的数据并且确保选中数据的映射名不能为空！");n.saveEtlMapConfig(o.comInfo,o.current,e,o.otherTables,o.mapInfo),o.close()},o.cancel=function(){o.dismiss({$value:"cancel"})},o.changeAll=function(){angular.forEach(o.addList,function(e){e.checked=o.ckAll})},o.changeOne=function(e){var t=0;e.checked?(angular.forEach(o.addList,function(e){e.checked&&t++}),t===o.addList.length&&(o.ckAll=!0)):o.ckAll=!1},o.openTargetsModal=function(){e.open({component:"targetTree",windowClass:"small-modal-panel",size:"sm",resolve:{jsonTree:function(){return o.targetTreeJson},comInfo:function(){return o.comInfo}}}).result.then(function(e){if(e){o.targetLabel=e.map_db_com_name+" 库 > "+e.map_user+"."+e.map_table,o.mapInfo=e;var t=[];angular.forEach(o.fieldList,function(e){t.push({column_name:e.column_name})});var r=angular.copy(o.comInfo);r.pn=e.map_db_com_name,n.fetchEtlYdzdList(r,e.map_user,e.map_table,t).then(function(e){var t=[];angular.forEach(e,function(e){t.push(e.column_name)}),angular.forEach(o.addList,function(e){e.map="",e.maps=t})})}else o.mapInfo={}})},o.openApplyToModal=function(){e.open({component:"applyToOther",windowClass:"small-modal-panel",size:"sm",resolve:{tables:function(){return n.fetchEtlTable(o.comInfo,o.current.uname)},selected:function(){return o.selectTab}}}).result.then(function(e){o.otherTables=[],angular.forEach(e,function(e){o.otherTables.push(e.name)})})}}]}).component("databaseModal",{templateUrl:"etl_view/database.component.html",bindings:{resolve:"<",dismiss:"&",close:"&"},controller:["etlService",function(e){var t=this;t.model={},t.notPass=!0,t.isTest=!1,t.dbs=["oracle","db2","sqlserver","gbase-8a","mysql","informix","sybase","altibase","postgresql","oscar","dameng","kingbase","vertica","dbone","kdb"],t.$onInit=function(){t.resolve&&t.resolve.model&&(t.model=t.resolve.model)},t.testDbConnect=function(){t.isTest=!0,e.testDbConnect(t.model).then(function(e){t.notPass=!e}).finally(function(){t.isTest=!1})},t.saveDbInfo=function(){t.close({$value:t.model})},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}).component("operationModal",{templateUrl:"etl_view/operation.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$uibModal","etlService","$log",function(e,t,n){var r=this;r.bindNameVisble=!1,r.model={},r.operate="",r.newTip=!1,r.flags=[{id:1,checked:!1,name:"aaa",value:"bbb"},{id:2,checked:!1,name:"ccc",value:"ddd"}],r.selList=[],r.allList=[],r.unselList=[],r.$onInit=function(){r.current=this.resolve.current,r.comInfo=this.resolve.comInfo,r.clist=this.resolve.clist,angular.forEach(r.clist,function(e){r.allList.push(e.column_name)}),r.row={bdList:[],dbInfo:{},clist:r.clist,expression:"",connect_db:"yes"}},r.changeOperation=function(){"inserttoupdate"===r.operate?(r.newTip=!1,r.getOperationInfo("inserttoupdate")):"updatetoinsert"===r.operate?(r.newTip=!0,r.getOperationInfo("updatetoinsert")):"deletetoupdate"===r.operate?(r.newTip=!0,r.getOperationInfo("deletetoupdate")):r.newTip=!1},r.getOperationInfo=function(e){t.getEtlOperationConfig(r.comInfo,r.current,e).then(function(e){$.isEmptyObject(e)||(r.row=e,r.row.clist=r.clist,r.model=e.dbInfo,r.flags=e.flags,r.selList=e.selList,0===r.selList.length&&(r.selList=r.allList))})},r.insertToText=function(e){e="yes"===r.row.connect_db?":"+e:"{"+e+"}";var t=$("#bjq_expression");t.focus().insertToText(e),r.row.expression=t.val()},r.dbConfig=function(){e.open({component:"databaseModal",size:"md",resolve:{model:function(){return r.model}}}).result.then(function(e){r.row.dbInfo=e})},r.checkExpression=function(){var e=Base64.encode(r.row.expression);t.expressionCheck(r.comInfo,r.current.uname,r.current.tname,r.row.connect_db,e).then(function(e){r.row.bdList=e})},r.saveExpression=function(){var e=Base64.encode(r.row.expression);t.expressionCheck(r.comInfo,r.current.uname,r.current.tname,r.row.connect_db,e).then(function(e){r.row.bdList=e}).finally(function(){r.row.oper_type=r.operate,"deletetoupdate"===r.row.oper_type&&(0===r.unselList.length?r.row.reserve_all="yes":r.row.reserve_all="no",r.row.newList=[],angular.forEach(r.clist,function(e){$.inArray(e.column_name,r.selList)>=0&&r.row.newList.push({name:e.column_name,type:e.column_type})})),t.saveEtlOperationConfig(r.comInfo,r.current,r.row),r.close()})},r.cancel=function(){r.dismiss({$value:"cancel"})},r.deleteFlag=function(){e.open({templateUrl:"delete_flag.model.html",controller:["$uibModalInstance","flags","tipsService",function(e,t,n){var a=this;a.flags=t,a.ckAll=!1,a.ok=function(){e.close(a.flags)},a.cancel=function(){e.dismiss("cancel")},a.addRow=function(){var e=0;a.flags.length>0&&(e=a.flags[a.flags.length-1].id+1),a.flags.push({id:e,checked:!1,name:"",value:""})},a.removeRow=function(){var e=[];angular.forEach(a.flags,function(t){t.checked||e.push(t)}),e.length===a.flags.length?n.error("您没有选中任何行！"):a.flags=e},a.changeCA=function(){angular.forEach(a.flags,function(e){e.checked=a.ckAll})},a.sonChange=function(e){var t=!0;e.checked?(angular.forEach(a.flags,function(e){e.checked||(t=!1)}),t&&(r.ckAll=!0)):r.ckAll=!1}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",
resolve:{flags:function(){return r.flags}}}).result.then(function(e){var t=[];angular.forEach(e,function(e){e.name&&e.value&&t.push(e)}),r.flags=t})},r.keepFieldList=function(){e.open({templateUrl:"keepFieldList.model.html",controller:["$uibModalInstance","model",function(e,t){var n=this;n.selList=t.selList,n.unselList=[],angular.forEach(t.list,function(e){$.inArray(e,t.selList)<0&&n.unselList.push(e)}),n.unselModel=[],n.selModel=[],n.left=">>",n.right="<<",n.ok=function(){e.close({selList:n.selList,unselList:n.unselList})},n.cancel=function(){e.dismiss("cancel")},n.pushSelect=function(){if(n.unselModel&&n.unselModel.length>0){var e=[];angular.forEach(n.unselList,function(t){$.inArray(t,n.unselModel)<0?e.push(t):n.selList.push(t)}),e.sort(),n.unselList=e,n.unselModel=[]}},n.removeSelect=function(){if(n.selModel&&n.selModel.length>0){var e=[];angular.forEach(n.selList,function(t){$.inArray(t,n.selModel)<0?e.push(t):n.unselList.push(t)}),e.sort(),n.selList=e,n.selModel=[]}}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{model:function(){return{list:r.allList,selList:r.selList}}}}).result.then(function(e){r.selList=angular.copy(e.selList),r.unselList=angular.copy(e.unselList)})}}]}).component("etlBglRule",{templateUrl:"etl_view/bgl.component.html",bindings:{users:"<"},controller:["$stateParams","etlService",function(e,t){function n(e,t){a.tj=e.flag,angular.forEach(a.list,function(n){n.user===t&&(e.tables=e.tables.concat(n.list).unique(),a.tj=n.flag)}),angular.forEach(e.tables,function(e){a.tables.push({checked:!0,name:e})}),angular.forEach(e.list,function(e){a.tables.push({checked:!1,name:e})})}function r(e){var t={user:e,flag:a.tj,list:[]},n=!0;angular.forEach(a.tables,function(e){e.checked&&t.list.push(e.name)}),angular.forEach(a.list,function(r){r.user===e&&(r.list=t.list,r.flag=a.tj,n=!1)}),a.tables.length>0&&n&&a.list.push(t)}var a=this;a.selUsers=[],a.tables=[],a.selTables=[],a.tj="include",a.currentName="",a.loading=!1,a.ckAll=!1,a.list=[],a.geting=!1,a.$onInit=function(){},a.getTable=function(o,s){a.geting||(a.geting=!0,r(a.currentName),a.currentName=o,a.loading=!0,a.tables=[],t.getEtlBglList(e,o,a.tj).then(function(e){n(e,o)}).finally(function(){a.loading=!1,a.geting=!1}),$(s.target).parent().addClass("active").siblings().removeClass("active"))},a.checkAll=function(){angular.forEach(a.selTables,function(e){e.checked=a.ckAll})},a.checkOne=function(e){var t=0;e.checked?(angular.forEach(a.selTables,function(e){e.checked&&t++}),t===a.tables.length&&(a.ckAll=!0)):a.ckAll=!1},a.saveEtlBglRule=function(){r(a.currentName),t.saveEltBglRule(e,a.list)},Array.prototype.unique=function(){for(var e=[],t={},n=0;n<this.length;n++)t[this[n]]||(e.push(this[n]),t[this[n]]=1);return e}}]}).component("etlOperateRule",{templateUrl:"etl_view/op_filter.component.html",bindings:{users:"<"},controller:["$stateParams","etlService","$log","$uibModal",function(e,t,n,r){function a(e,t){angular.forEach(s.list,function(n){n.user===t&&(e.list=n.lsList)}),s.tables=e.list}function o(e){var t={user:e,list:[],lsList:s.tables},n=!0;angular.forEach(s.tables,function(e){(e.tab_ins||e.tab_del||e.tab_upt)&&t.list.push(e)}),angular.forEach(s.list,function(r){r.user===e&&(r.list=t.list,n=!1)}),s.tables.length>0&&n&&s.list.push(t)}var s=this;s.selUsers=[],s.tables=[],s.selTables=[],s.tj="include",s.currentName="",s.loading=!1,s.ckAll=!1,s.list=[],s.$onInit=function(){},s.getTable=function(n,r){o(s.currentName),s.currentName=n,s.loading=!0,s.tables=[],t.getEtlCzglList(e,n).then(function(e){a(e,n)}).finally(function(){s.loading=!1}),$(r.target).parent().addClass("active").siblings().removeClass("active")},s.editExpression=function(n){t.fetchEtlYdzdList(e,s.currentName,n.name).then(function(e){var t={id:n.id,bdList:n.bdList,clist:e,dbInfo:n.dbInfo,expression:n.expression,connect_db:n.connect_db};s.openExpressPanel(t,n.name)})},s.openExpressPanel=function(t,n){r.open({component:"expressionPanel",size:"lg",resolve:{row:function(){return t},comInfo:function(){return e},current:function(){return{uname:s.currentName,tname:n}},type:function(){return"large"}}}).result.then(function(e){angular.forEach(s.tables,function(t){t.id===e.id&&(t.bdList=e.bdList,t.dbInfo=e.dbInfo,t.expression=e.expression,t.connect_db=e.connect_db)})})},s.checkAll=function(e){1===e?s.ckAllIns?angular.forEach(s.selTables,function(e){e.tab_ins=!0}):angular.forEach(s.selTables,function(e){e.tab_ins=!1}):2===e?s.ckAllDel?angular.forEach(s.selTables,function(e){e.tab_del=!0}):angular.forEach(s.selTables,function(e){e.tab_del=!1}):3===e&&(s.ckAllUpt?angular.forEach(s.selTables,function(e){e.tab_upt=!0}):angular.forEach(s.selTables,function(e){e.tab_upt=!1}))},s.checkOne=function(e,t){var n=0;1===t?(n=0,e.checked?(angular.forEach(s.selTables,function(e){e.tab_ins&&n++}),n===s.tables.length&&(s.ckAllIns=!0)):s.ckAllIns=!1):2===t?(n=0,e.checked?(angular.forEach(s.selTables,function(e){e.tab_del&&n++}),n===s.tables.length&&(s.ckAllDel=!0)):s.ckAllDel=!1):3===t&&(n=0,e.checked?(angular.forEach(s.selTables,function(e){e.tab_upt&&n++}),n===s.tables.length&&(s.ckAllUpt=!0)):s.ckAllUpt=!1)},s.saveEtlCzglRule=function(){o(s.currentName),t.saveEtlCzglRule(e,s.list)}}]}).component("etlPlRule",{templateUrl:"etl_view/pl_filter.component.html",bindings:{users:"<"},controller:["$stateParams","etlService","tipsService","$uibModal","$log",function(e,t,n,r,a){var o=this;o.selUsers=[],o.rules=[],o.selRules=[],o.loading=!1,o.ckAll=!1,o.addBtnTip="添加新的规则名称",o.applyTips="复用规则到选中表",o.filter_way="filter",o.newRuleName="",o.addIng=!1,o.clist=[],o.currentName="",o.isApply=!1,o.$onInit=function(){o.users&&angular.isArray(o.users)&&o.users.length>0&&(o.currentName=o.users[0])},o.checkAll=function(){angular.forEach(o.rules,function(e){e.checked=o.ckAll})},o.checkOne=function(e){var t=0;e.checked?(angular.forEach(o.rules,function(e){e.checked&&t++}),t===o.rules.length&&(o.ckAll=!0)):o.ckAll=!1},o.getRule=function(n,r){var a={rule_type:o.filter_way,batch_name:n};o.currentName=n,o.rules=[],o.loading=!0,o.ckAll=!1,t.getBatchRules(e,a).then(function(e){o.rules=e}).finally(function(){o.loading=!1}),$(r.target).parent().addClass("active").siblings().removeClass("active")},o.changeRuleType=function(){t.fetchBatchs(e,o.filter_way).then(function(e){o.users=e,o.rules=[]})},o.savePlRule=function(){var n=[],r=angular.copy(o.rules);angular.forEach(r,function(e){e.coder&&(e.expression&&(e.expression=Base64.encode(e.expression)),n.push(e))}),t.saveBatchRules(e,o.filter_way,o.currentName,n)},o.deleteColumn=function(){if($("#etlPlList").find("input.etl-pl-item:checked").length>0){var e=[];angular.forEach(o.rules,function(t){t.checked||e.push(t)}),o.rules=e,o.ckAll=!1}else n.warning("你没有选中任何数据！")},o.addNewColumn=function(){var e={},t=0;o.rules.length>0&&(t=o.rules[o.rules.length-1].id+1),e.id=t,e.checked=!1,e.coder="",e.resered="yes",e.expression="",e.value="",e.bdList=[],e.dbInfo={},e.list=[],o.rules.push(e)},o.editExpression=function(e){var t={id:e.id,bdList:e.bdList,clist:[],dbInfo:e.dbInfo,expression:e.expression,connect_db:e.connect_db?e.connect_db:"yes"};o.openExpressPanel(t)},o.openExpressPanel=function(t){r.open({component:"expressionPanel",size:"lg",resolve:{row:function(){return t},comInfo:function(){return e},current:function(){return{uname:"",tname:""}},allowTable:!0,type:function(){return"pl"}}}).result.then(function(e){angular.forEach(o.rules,function(t){t.id===e.id&&(t.bdList=e.bdList,t.dbInfo=e.dbInfo,t.expression=e.expression,"string"==typeof e.expression&&e.expression.length>10?t.value=e.expression.substring(0,10)+"...":t.value=e.expression,t.connect_db=e.connect_db)})})},o.applyRuleToOthers=function(n){o.isApply=!0,r.open({component:"selectTableModal",size:"lg",resolve:{users:function(){return t.fetchEtlUser(e)},comInfo:function(){return e},list:function(){return n.list}}}).result.then(function(e){angular.forEach(o.tables,function(t){t.id===n.id&&(t.list=e)}),o.isApply=!1},function(){o.isApply=!1})},o.addRuleName=function(){if(!/^[a-zA-Z]\w{0,29}$/.test(o.newRuleName))return void n.error("规则名只能包含数字、字母、下划线，且长度不能超过30个字符");var e=!0;angular.forEach(o.users,function(t){t===o.newRuleName&&(e=!1)}),e?(o.users.unshift(o.newRuleName),o.currentName=o.newRuleName,o.newRuleName=""):n.error("新规则名不能与已有规则名重复！")}}]}).component("selectTableModal",{templateUrl:"etl_view/select_table.component.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$log","etlService",function(e,t){function n(e,t){var n=[];angular.forEach(a.list,function(e){e.user===t&&(n=e.list)}),angular.forEach(e,function(e){$.inArray(e,n)>=0?a.tables.push({checked:!0,name:e}):a.tables.push({checked:!1,name:e})})}function r(e){var t={user:e,list:[]},n=!0;angular.forEach(a.tables,function(e){e.checked&&t.list.push(e.name)}),angular.forEach(a.list,function(r){r.user===e&&(r.list=t.list,n=!1)}),a.tables.length>0&&n&&a.list.push(t)}var a=this;a.selUsers=[],a.tables=[],a.selTables=[],a.currentName="",a.loading=!1,a.ckAll=!1,a.list=[],a.$onInit=function(){a.users=a.resolve.users,a.comInfo=a.resolve.comInfo,a.resolve.list&&(a.list=a.resolve.list)},a.getTable=function(e,o){r(a.currentName),a.currentName=e,a.loading=!0,a.tables=[],a.ckAll=!1,t.fetchEtlTable(a.comInfo,e).then(function(t){n(t,e)}).finally(function(){a.loading=!1}),$(o.target).parent().addClass("active").siblings().removeClass("active")},a.checkAll=function(){angular.forEach(a.selTables,function(e){e.checked=a.ckAll})},a.checkOne=function(e){var t=0;e.checked?(angular.forEach(a.selTables,function(e){e.checked&&t++}),t===a.tables.length&&(a.ckAll=!0)):a.ckAll=!1},a.saveSelectList=function(){r(a.currentName),a.close({$value:a.list})},a.cancel=function(){a.dismiss({$value:"cancel"})}}]}).component("configRule",{templateUrl:"etl_view/cfg_rule.component.html",controller:["$stateParams","etlService","$uibModal",function(e,t,n){var r=this;r.currentRuleName="增加列",r.isBgl=!1,r.isCzzh=!1,r.currentCzzh="insert_to_update",r.isInclude="include",r.list=[],r.include=[],r.exclude=[],t.fetchSettingRule(e,"add_column").then(function(e){r.list=e}),r.currentNum=1,r.$onInit=function(){},r.changeType=function(){"include"===r.isInclude?r.list=r.include:r.list=r.exclude},r.changeOperation=function(){r.currentRuleName="操作转换",t.fetchSettingRule(e,r.currentCzzh).then(function(e){r.list=e})},r.changeRule=function(n){r.isBgl=!1,r.isCzzh=!1,r.currentNum=n,1===n?(r.currentRuleName="增加列",t.fetchSettingRule(e,"add_column").then(function(e){r.list=e})):2===n?(r.currentRuleName="映射列",t.fetchSettingRule(e,"column_mapping").then(function(e){r.list=e})):3===n?(r.currentRuleName="删除列",t.fetchSettingRule(e,"delete_column").then(function(e){r.list=e})):4===n?(r.currentRuleName="记录过滤",t.fetchSettingRule(e,"record_filter").then(function(e){r.list=e})):5===n?(r.currentRuleName="审计表",t.fetchSettingRule(e,"table_audit").then(function(e){r.list=e})):6===n?(r.isBgl=!0,r.currentRuleName="表过滤",t.fetchSettingRule(e,"table_filter").then(function(e){r.include=[],r.exclude=[],angular.forEach(e,function(e){"include"===e.type?r.include.push(e):r.exclude.push(e)}),r.list=r.include})):7===n?(r.currentRuleName="操作过滤",t.fetchSettingRule(e,"operation_filter").then(function(e){r.list=e})):8===n&&(r.isCzzh=!0,r.currentRuleName="操作转换",t.fetchSettingRule(e,r.currentCzzh).then(function(e){r.list=e}))},r.showDetail=function(t){6!==r.currentNum&&n.open({templateUrl:"cfgRuleDetailModal.html",controller:["$uibModalInstance","model","etlService",function(e,t,n){var a=this;if(a.loading=!1,a.list=[],a.model=t,a.nowCzzhType=r.currentCzzh,a.czzhModel={},1===a.model.cnum)a.loading=!0,n.fetchEtlAddConfig(t.comInfo,t.uname,t.tname).then(function(e){a.list=e.addList}).finally(function(){a.loading=!1});else if(2===a.model.cnum)a.loading=!0,n.fetchEtlMapConfig(t.comInfo,t.uname,t.tname).then(function(e){a.list=e.addList}).finally(function(){a.loading=!1});else if(3===a.model.cnum)a.loading=!0,n.fetchEtlDeleteConfig(t.comInfo,t.uname,t.tname).then(function(e){a.list=e.addList}).finally(function(){a.loading=!1});else if(4===a.model.cnum)a.loading=!0,n.fetchEtlConditionConfig(t.comInfo,t.uname,t.tname).then(function(e){a.list=e.addList}).finally(function(){a.loading=!1});else if(5===a.model.cnum)a.loading=!0,n.fetchEtlTransformConfig(t.comInfo,t.uname,t.tname).then(function(e){a.list=e.addList}).finally(function(){a.loading=!1});else if(7===a.model.cnum){var o="";t.item&&(t.item.expression&&(o=Base64.decode(t.item.expression)),a.list.push({tab_ins:t.item.tab_ins,tab_del:t.item.tab_del,tab_upt:t.item.tab_upt,expression:o}))}else if(8===a.model.cnum){a.czzhModel.expression="",a.czzhModel.bjs=[],a.czzhModel.zds="";var s="";s="update_to_insert_or_delete"===a.nowCzzhType?"updatetoinsert":a.nowCzzhType.replace(/_/g,""),n.getEtlOperationConfig(t.comInfo,t,s).then(function(e){$.isEmptyObject(e)||(a.czzhModel.expression=e.expression,a.czzhModel.bjs=e.flags,a.czzhModel.zds=e.selList.toString())})}a.showFlags=function(e){var t="<tr>";angular.forEach(e,function(e){t+="<td>"+e.name+"</td><td>固定字符串</td><td>"+e.value+"</td>"}),t+="</tr>";var n='<div class="etl-flags"><table  class="table table-bordered"><colgroup><col style="width: 30%"><col style="width: 30%"><col style="width: 40%"></colgroup><tr><td>字段名称</td><td>值类型</td><td>字段值</td></tr>'+t+"</table></div>";new BootstrapDialog({title:"删除标记列表",message:$(n),type:"type-info",closable:!0,cssClass:"etl-flags-dialog-model"}).open()},a.ok=function(){a.model.cz="add",e.close(a.model)},a.cancel=function(){e.dismiss("cancel")}}],controllerAs:"$ct",windowClass:"small-modal-panel",size:"md",resolve:{model:function(){return{uname:t.user,tname:t.table,cnum:r.currentNum,comInfo:e,item:t}}}})}}]}).component("etlApplyRule",{templateUrl:"etl_view/apply_rule.component.html",bindings:{rules:"<"},controller:["etlService","tipsService","$stateParams",function(e,t,n){var r=this;r.selUsers=[],r.selRules=[],r.loading=!1,r.ckAll=!1,r.ruleType="filter",r.codes=[],r.selCodes=[],r.clist=[],r.$onInit=function(){},r.getCodes=function(e,t){r.codes=e.codes,$(t.target).parent().addClass("active").siblings().removeClass("active")},r.saveApplyRuleInfo=function(){e.saveBatchInfo(n,r.ruleType,r.rules)},r.changeRuleType=function(){e.getBatchCheckedList(n,r.ruleType).then(function(e){r.rules=e,r.codes=[]})},r.checkAll=function(){angular.forEach(r.selCodes,function(e){e.checked=r.ckAll})},r.checkOne=function(e){var t=0;e.checked?(angular.forEach(r.selCodes,function(e){e.checked&&t++}),t===r.rules.length&&(r.ckAll=!0)):r.ckAll=!1},r.deleteColumn=function(){if($("#etlPtRulePanel").find("input.etl-pt-li-son:checked").length>0){var e=[];angular.forEach(r.codes,function(t){t.checked||e.push(t)}),r.codes=e,r.ckAll=!1}else t.warning("你没有选中任何数据！")},r.addNewColumn=function(){var e={},t=0;r.codes.length>0&&(t=r.codes[r.codes.length-1].id+1),e.id=t,e.checked=!1,e.code="",e.name="",r.codes.push(e)}}]})}(),function(){angular.module("myApp.ftp_view",["myApp.ftpService","myApp.ftpComponent"]).config(["$urlRouterProvider","$stateProvider",function(e,t){e.when("/main/ftp_view/","/main/ftp_view/status"),t.state("/.ftp_view",{abstract:!0,url:"/ftp_view",component:"rightDialog",resolve:{title:function(){return"FTP数组传输组件配置"},ftpInfo:["$transition$","ftpService",function(e,t){var n=e.params();return n.gn&&"unnamed"!==n.cn&&n.cid?t.getFtpInfo(n):"init"}]},bindings:{title:"title"}}).state("/.ftp_view.status",{url:"/status?gn&cn&id&cid",component:"ftpStatus",bindings:{dl:"ftpInfo"}}).state("/.ftp_view.property",{url:"/property?gn&cn&id&cid",component:"ftpProperty",bindings:{dl:"ftpInfo"}})}])}(),function(){function e(e,t,n,r,a){this.getFtpInfo=function(o){var s={group_id:o.gn,component_id:o.cid,type:"qsend"},i=null;return s=n.md5Data(s),e.postDataList("/dipserver/query_apply_config",s).then(function(e){return n.equalMd5Data(e)&&e.status&&(i=e.response,i.passwd&&(i.passwd=a.de_des(i.passwd))),i},function(){t.error(r("translate")("Wlcw"))})},this.saveFtpInfo=function(t,r){var o=angular.copy(r);o.passwd=a.en_des(o.passwd);var s={group_id:t.gn,component_name:o.component_name,type:"qsend",qtran:o,component_id:t.cid},i={res:!1,comId:"",msg:""};return s=n.md5Data(s),e.postDataList("/dipserver/add_apply_config",s).then(function(e){return n.equalMd5Data(e)&&(e.status?(i.res=!0,i.comId=e.response&&e.response.component_id||""):i.msg=e.response.error_msg),i})}}angular.module("myApp.ftpService",[]).config(["$qProvider",function(e){e.errorOnUnhandledRejections(!1)}]).service("ftpService",e),e.$inject=["httpService","tipsService","md5Service","$filter","tDes"]}(),function(){angular.module("myApp.ftpComponent",[]).component("ftpProperty",{templateUrl:"ftp_view/property.component.html",bindings:{dl:"<"},controller:["$state","$stateParams","$filter","ftpService","tipsService","graphicService",function(e,t,n,r,a,o){var s=this,i=t;s.params={},s.real={com_id:""},s.property={},s.property.save_time=1,s.property.wait=60,s.property.type="qsend",s.isSaving=!1;var c=n("translate")("SAVE"),l=n("translate")("SAVING");s.saveBtnTxt=c,s.$onInit=function(){s.dl?s.dl&&angular.isObject(s.dl)&&(s.property.component_name=t.cn,s.real.com_id=t.cid||"",s.property.type=s.dl.type||"qsend",s.property.ip=s.dl.ip,s.property.user_name=s.dl.user_name,s.property.passwd=s.dl.passwd,s.property.save_time=s.dl.save_time||1,s.property.wait=s.dl.wait||60,s.property.ftp_path=s.dl.ftp_path,s.property.ftp_filename=s.dl.ftp_filename):e.go("/")},s.saveFtpInfo=function(){if("unnamed"===s.property.component_name)return void a.error("组件名不能为unnamed！");s.isSaving=!0,s.saveBtnTxt=l;var n=new BootstrapDialog({title:"Dip Tip",type:"type-primary",size:"size-small",message:"保存中......",closable:!1}),u=function(e,t){e?(n.setType("type-success"),n.getModalBody().html("保存成功！"),setTimeout(function(){n.close()},300)):(n.setType("type-danger"),t?n.getModalBody().html(t):n.getModalBody().html("保存失败！")),n.setClosable(!0)};n.open(),r.saveFtpInfo(t,s.property).then(function(t){if(t.res){s.real.com_id=t.comId;var n=$("#"+i.id);n.find(".dragPoint").text(s.property.component_name),n.attr("name",s.property.component_name),n.attr("type","qsend"),n.attr("realid",s.real.com_id),o.save_graphics_no_alert(i.gn).finally(function(){u(!0)}),e.go("/")}else u(!1,t.msg)}).catch(function(){u(!1)}).finally(function(){s.isSaving=!1,s.saveBtnTxt=c})}}]}).component("ftpStatus",{templateUrl:"ftp_view/status.component.html",bindings:{dl:"<"},controller:["$state","$stateParams",function(e,t){var n=this;n.params={},n.real={com_id:""},n.property={},n.$onInit=function(){n.dl&&angular.isObject(n.dl)?(n.property.component_name=t.cn,n.real.com_id=t.cid||"",n.property.type="qsend"===n.dl.type?"发送":"接收",n.property.ip=n.dl.ip,n.property.user_name=n.dl.user_name,n.property.passwd="******",n.property.save_time=n.dl.save_time?n.dl.save_time+"天":"1天",n.property.wait=isFinite(n.dl.wait)?n.dl.wait+"秒":"60秒",n.property.ftp_path=n.dl.ftp_path||"",n.property.ftp_filename=n.dl.ftp_filename||""):e.go("/")}}]})}();